{% extends "base.html" %}

{% block title %}{{ page_title }} - ARDT FMS{% endblock %}

{% block page_header %}
<div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{ page_title }}</h1>
        <p class="text-gray-600 dark:text-gray-400">Create GRN from Purchase Order {{ po.po_number }}</p>
    </div>
    <a href="{% url 'inventory:grn_list' %}" class="inline-flex items-center px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 text-sm">
        <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i>Back to GRN List
    </a>
</div>
{% endblock %}

{% block content %}
<form method="post" class="space-y-6">
    {% csrf_token %}

    <!-- PO Information (Read-only) -->
    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl shadow-sm p-6">
        <h2 class="text-lg font-semibold text-blue-900 dark:text-blue-200 mb-4">
            <i data-lucide="file-text" class="w-5 h-5 inline mr-2"></i>
            Purchase Order Information
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <span class="block text-sm font-medium text-blue-700 dark:text-blue-300">PO Number</span>
                <span class="text-gray-900 dark:text-white font-semibold">{{ po.po_number }}</span>
            </div>
            <div>
                <span class="block text-sm font-medium text-blue-700 dark:text-blue-300">Vendor</span>
                <span class="text-gray-900 dark:text-white">{{ po.vendor.name|default:"N/A" }}</span>
            </div>
            <div>
                <span class="block text-sm font-medium text-blue-700 dark:text-blue-300">Status</span>
                <span class="text-gray-900 dark:text-white">{{ po.get_status_display }}</span>
            </div>
            <div>
                <span class="block text-sm font-medium text-blue-700 dark:text-blue-300">Order Date</span>
                <span class="text-gray-900 dark:text-white">{{ po.order_date|date:"M d, Y" }}</span>
            </div>
        </div>
    </div>

    <!-- Receipt Details -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Receipt Details</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Warehouse <span class="text-red-500">*</span></label>
                <select name="warehouse" id="warehouse" required
                        class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Warehouse</option>
                    {% for wh in warehouses %}
                    <option value="{{ wh.pk }}">{{ wh.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Receiving Location <span class="text-red-500">*</span></label>
                <select name="receiving_location" id="receiving_location" required
                        class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Location</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Receipt Date</label>
                <input type="date" name="receipt_date" value="{% now 'Y-m-d' %}"
                       class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Owner Party <span class="text-red-500">*</span></label>
                <select name="owner_party" required
                        class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Owner</option>
                    {% for party in parties %}
                    <option value="{{ party.pk }}">{{ party.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ownership Type <span class="text-red-500">*</span></label>
                <select name="ownership_type" required
                        class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Type</option>
                    {% for ot in ownership_types %}
                    <option value="{{ ot.pk }}">{{ ot.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Delivery Note #</label>
                <input type="text" name="source_reference" placeholder="Vendor's delivery note number"
                       class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
                <textarea name="notes" rows="2"
                          class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
            <div class="flex items-center">
                <input type="checkbox" name="requires_qc" id="requires_qc" checked
                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <label for="requires_qc" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Requires QC Inspection</label>
            </div>
        </div>
    </div>

    <!-- Lines to Receive -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Items to Receive</h2>
        {% if outstanding_lines %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Item Code</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Description</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">PO Qty</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Already Received</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Outstanding</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Qty to Receive</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% for line in outstanding_lines %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-4 py-3 text-sm text-gray-900 dark:text-white font-medium">
                            {{ line.item.code|default:"N/A" }}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">
                            {{ line.item.name|default:line.po_line.description|truncatechars:40 }}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900 dark:text-white text-right">
                            {{ line.po_line.quantity_ordered|floatformat:0 }}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400 text-right">
                            {{ line.po_line.quantity_received|default:0|floatformat:0 }}
                        </td>
                        <td class="px-4 py-3 text-sm text-blue-600 dark:text-blue-400 text-right font-medium">
                            {{ line.qty_expected|floatformat:0 }}
                        </td>
                        <td class="px-4 py-3">
                            <input type="number" name="qty_received_{{ line.po_line.pk }}"
                                   value="{{ line.qty_expected|floatformat:0 }}"
                                   min="0" max="{{ line.qty_expected }}" step="1"
                                   class="w-24 px-2 py-1 text-right rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            <i data-lucide="check-circle" class="w-12 h-12 mx-auto mb-3 text-green-500"></i>
            <p>All items from this PO have been fully received.</p>
        </div>
        {% endif %}
    </div>

    <!-- Actions -->
    <div class="flex justify-end gap-3">
        <a href="{% url 'inventory:grn_list' %}" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">
            Cancel
        </a>
        {% if outstanding_lines %}
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 inline-flex items-center">
            <i data-lucide="package-plus" class="w-4 h-4 mr-2"></i>
            Create GRN
        </button>
        {% endif %}
    </div>
</form>

<script>
// Dynamic location loading based on warehouse selection
document.getElementById('warehouse').addEventListener('change', function() {
    const warehouseId = this.value;
    const locationSelect = document.getElementById('receiving_location');

    // Clear current options
    locationSelect.innerHTML = '<option value="">Loading...</option>';

    if (warehouseId) {
        fetch(`/inventory/api/warehouse/${warehouseId}/locations/`)
            .then(response => response.json())
            .then(data => {
                locationSelect.innerHTML = '<option value="">Select Location</option>';
                data.locations.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc.id;
                    option.textContent = loc.name;
                    locationSelect.appendChild(option);
                });
            })
            .catch(() => {
                locationSelect.innerHTML = '<option value="">Error loading locations</option>';
            });
    } else {
        locationSelect.innerHTML = '<option value="">Select Location</option>';
    }
});
</script>
{% endblock %}
