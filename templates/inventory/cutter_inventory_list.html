{% extends "base.html" %}
{% load inventory_filters %}

{% block title %}{{ page_title }} - ARDT FMS{% endblock %}

{% block extra_css %}
<style>
    /* CRITICAL: Prevent main content from extending under sidebar */
    main {
        overflow-x: hidden !important;
        min-width: 0 !important; /* Allow flex item to shrink */
    }
    main > div {
        overflow-x: hidden !important;
        max-width: 100% !important;
    }

    /* Page container - always bounded */
    .cutter-page-container {
        width: 100%;
        max-width: 100%;
        overflow: hidden;
    }

    /* Header section - never scrolls horizontally */
    .cutter-header-section {
        width: 100%;
        max-width: 100%;
    }

    /* Freeze mode - fills viewport, table gets independent scroll */
    .cutter-page-container.freeze-mode {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 140px);
    }
    .freeze-mode .cutter-header-section {
        flex-shrink: 0;
    }
    .freeze-mode .cutter-table-section {
        flex: 1;
        min-height: 0;
        overflow: hidden;
    }

    /* Table wrapper - ONLY element with horizontal scroll */
    .cutter-table-wrapper {
        width: 100%;
        overflow-x: auto;
        overflow-y: auto;
    }
    .freeze-mode .cutter-table-wrapper {
        height: 100%;
    }

    /* Sticky table header (always on in freeze mode) */
    .freeze-mode .cutter-table-wrapper thead {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    /* Sticky columns - positioned relative to table scroll container */
    .freeze-col-1 {
        position: sticky;
        left: 0;
        z-index: 15;
        background: inherit;
    }
    .freeze-col-2 {
        position: sticky;
        left: 40px;
        z-index: 15;
        background: inherit;
        box-shadow: 4px 0 6px -4px rgba(0,0,0,0.2);
    }
    .freeze-col-1-body {
        position: sticky;
        left: 0;
        z-index: 5;
    }
    .freeze-col-2-body {
        position: sticky;
        left: 40px;
        z-index: 5;
        box-shadow: 4px 0 6px -4px rgba(0,0,0,0.2);
    }

    /* Full page mode - maximizes table view */
    .full-page-mode {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 80px);
    }
    .full-page-mode .cutter-header-section {
        flex-shrink: 0;
    }
    .full-page-mode .cutter-table-section {
        flex: 1;
        min-height: 0;
        overflow: hidden;
    }
    .full-page-mode .cutter-table-wrapper {
        height: 100%;
    }
    /* Hide page header in full page mode */
    .full-page-mode ~ #pageHeader,
    body:has(.full-page-mode) #pageHeader {
        display: none !important;
    }
    /* Compact filter section in full page mode */
    .full-page-mode #filterSection {
        padding: 0.5rem 1rem;
        margin-bottom: 0.5rem;
    }

    /* Text wrap mode - cells wrap text and expand height */
    .text-wrap-mode #cutterTable td,
    .text-wrap-mode #cutterTable th {
        white-space: normal;
        word-wrap: break-word;
        max-width: none;
    }
    .text-wrap-mode #cutterTable td {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
    }
    .text-wrap-mode #cutterTable .truncate {
        overflow: visible;
        text-overflow: clip;
        white-space: normal;
    }

    /* No-wrap mode (default) - columns auto-size to fit content exactly */
    .no-wrap-mode #cutterTable {
        width: auto;
        table-layout: auto;
    }
    .no-wrap-mode #cutterTable td,
    .no-wrap-mode #cutterTable th {
        white-space: nowrap !important;
        max-width: none !important;
        min-width: auto !important;
        width: auto !important;
        overflow: visible !important;
        text-overflow: clip !important;
    }
    .no-wrap-mode #cutterTable .truncate,
    .no-wrap-mode #cutterTable [class*="max-w-"],
    .no-wrap-mode #cutterTable a {
        overflow: visible !important;
        text-overflow: clip !important;
        white-space: nowrap !important;
        max-width: none !important;
        display: inline !important;
    }
</style>
{% endblock %}

{% block page_header %}
<div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6" id="pageHeader">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{ page_title }}</h1>
        <p class="text-gray-600 dark:text-gray-400 mt-1">PDC Cutter inventory - matching Excel format</p>
    </div>
    <div class="mt-4 md:mt-0 flex gap-2">
        <a href="{% url 'inventory:cutter_order_list' %}" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            <i data-lucide="shopping-cart" class="w-4 h-4 mr-2"></i>View Orders
        </a>
        <a href="{% url 'inventory:item_list' %}?category=CT-PDC" class="inline-flex items-center px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200">
            <i data-lucide="list" class="w-4 h-4 mr-2"></i>All Cutters
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="cutter-page-container" :class="{ 'freeze-mode': freezePanes, 'full-page-mode': fullPageView, 'text-wrap-mode': textWrap, 'no-wrap-mode': !textWrap }" x-data="cutterInventory()" x-init="init()">

<!-- HEADER SECTION - Always visible -->
<div class="cutter-header-section">
    <!-- Summary Cards (collapsible in full page view) -->
    <div id="summarySection" x-show="!fullPageView" x-transition>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Total Cutters</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white mt-1">{{ total_cutters }}</p>
                </div>
                <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                    <i data-lucide="circle-dot" class="w-6 h-6 text-blue-600 dark:text-blue-400"></i>
                </div>
            </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Total Stock</p>
                    <p class="text-2xl font-bold text-green-600 dark:text-green-400 mt-1">{{ total_stock|floatformat:0 }}</p>
                </div>
                <div class="w-12 h-12 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                    <i data-lucide="package" class="w-6 h-6 text-green-600 dark:text-green-400"></i>
                </div>
            </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Total New</p>
                    <p class="text-2xl font-bold text-emerald-600 dark:text-emerald-400 mt-1">{{ total_new_stock|floatformat:0 }}</p>
                </div>
                <div class="w-12 h-12 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
                    <i data-lucide="sparkles" class="w-6 h-6 text-emerald-600 dark:text-emerald-400"></i>
                </div>
            </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">On Order</p>
                    <p class="text-2xl font-bold text-blue-600 dark:text-blue-400 mt-1">{{ total_on_order|floatformat:0 }}</p>
                </div>
                <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                    <i data-lucide="truck" class="w-6 h-6 text-blue-600 dark:text-blue-400"></i>
                </div>
            </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Below Safety</p>
                    <p class="text-2xl font-bold {% if below_safety_count > 0 %}text-red-600 dark:text-red-400{% else %}text-gray-900 dark:text-white{% endif %} mt-1">{{ below_safety_count }}</p>
                </div>
                <div class="w-12 h-12 rounded-full {% if below_safety_count > 0 %}bg-red-100 dark:bg-red-900/30{% else %}bg-gray-100 dark:bg-gray-700{% endif %} flex items-center justify-center">
                    <i data-lucide="alert-triangle" class="w-6 h-6 {% if below_safety_count > 0 %}text-red-600 dark:text-red-400{% else %}text-gray-400{% endif %}"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters & Controls -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4" id="filterSection">
    <form method="get" class="flex flex-wrap gap-4 items-end">
        <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Search</label>
            <input type="text" name="search" value="{{ current_search }}" placeholder="Code or name..."
                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
        </div>
        <div class="flex gap-2 flex-wrap">
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                <i data-lucide="search" class="w-4 h-4 inline mr-1"></i>Filter
            </button>
            <a href="{% url 'inventory:cutter_inventory_list' %}" class="px-4 py-2 text-gray-600 hover:text-gray-800 dark:text-gray-400">Clear</a>

            <!-- Freeze Panes Toggle -->
            <button type="button" @click="toggleFreezePanes()"
                    :class="freezePanes ? 'bg-blue-600 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200'"
                    class="px-4 py-2 rounded-lg hover:opacity-90 flex items-center gap-2">
                <i data-lucide="lock" class="w-4 h-4"></i>
                <span x-text="freezePanes ? 'Unfreeze' : 'Freeze Panes'"></span>
            </button>

            <!-- Full Page View Toggle -->
            <button type="button" @click="toggleFullPageView()"
                    :class="fullPageView ? 'bg-emerald-600 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200'"
                    class="px-4 py-2 rounded-lg hover:opacity-90 flex items-center gap-2">
                <i data-lucide="maximize-2" class="w-4 h-4"></i>
                <span x-text="fullPageView ? 'Exit Full' : 'Full Page'"></span>
            </button>

            <!-- Text Wrap Toggle -->
            <button type="button" @click="toggleTextWrap()"
                    :class="textWrap ? 'bg-purple-600 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200'"
                    class="px-4 py-2 rounded-lg hover:opacity-90 flex items-center gap-2"
                    :title="textWrap ? 'Text wraps, rows expand' : 'No wrap, columns expand'">
                <i data-lucide="wrap-text" class="w-4 h-4"></i>
                <span x-text="textWrap ? 'Wrap' : 'No Wrap'"></span>
            </button>

            <!-- Column Toggle Button -->
            <div class="relative">
                <button type="button" @click="showColumnMenu = !showColumnMenu" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200">
                    <i data-lucide="columns" class="w-4 h-4 inline mr-1"></i>Columns
                </button>
                <!-- Column Visibility Dropdown -->
                <div x-show="showColumnMenu" @click.away="showColumnMenu = false"
                     class="absolute right-0 mt-2 w-72 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-50 p-3 max-h-[70vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-2 pb-2 border-b border-gray-200 dark:border-gray-700">
                        <span class="text-xs font-medium text-gray-500">Column Visibility</span>
                        <div class="flex gap-2">
                            <button type="button" @click="resetToDefaults()" class="text-xs text-blue-600 hover:text-blue-800">Reset</button>
                            <button type="button" @click="showAllColumns()" class="text-xs text-blue-600 hover:text-blue-800">Show All</button>
                        </div>
                    </div>
                    <p class="text-xs font-medium text-gray-500 mb-2">Attributes</p>
                    {% for attr in category_attributes %}
                    <label class="flex items-center gap-2 py-1 text-sm">
                        <input type="checkbox" x-model="columns.attr_{{ attr.code }}" @change="savePreferences()">
                        <span>{{ attr.name }}</span>
                        {% if not attr.visible_default %}<span class="text-xs text-gray-400">(hidden by default)</span>{% endif %}
                    </label>
                    {% endfor %}
                    <hr class="my-2">
                    <p class="text-xs font-medium text-gray-500 mb-2">Stock Variants</p>
                    <label class="flex items-center gap-2 py-1 text-sm"><input type="checkbox" x-model="columns.eno_new" @change="savePreferences()"> ENO New</label>
                    <label class="flex items-center gap-2 py-1 text-sm"><input type="checkbox" x-model="columns.eno_grd" @change="savePreferences()"> ENO Grd</label>
                    <label class="flex items-center gap-2 py-1 text-sm"><input type="checkbox" x-model="columns.ardt_rcl" @change="savePreferences()"> ARDT Rcl</label>
                    <label class="flex items-center gap-2 py-1 text-sm"><input type="checkbox" x-model="columns.lstk_rcl" @change="savePreferences()"> LSTK Rcl</label>
                    <hr class="my-2">
                    <p class="text-xs font-medium text-gray-500 mb-2">Stock Totals</p>
                    <label class="flex items-center gap-2 py-1 text-sm"><input type="checkbox" x-model="columns.new_stock" @change="savePreferences()"> New Stock</label>
                    <label class="flex items-center gap-2 py-1 text-sm"><input type="checkbox" x-model="columns.total_new" @change="savePreferences()"> Total New</label>
                    <hr class="my-2">
                    <p class="text-xs font-medium text-gray-500 mb-2">Consumption</p>
                    <label class="flex items-center gap-2 py-1 text-sm"><input type="checkbox" x-model="columns.cons_6m" @change="savePreferences()"> 6M Consumption</label>
                    <label class="flex items-center gap-2 py-1 text-sm"><input type="checkbox" x-model="columns.cons_3m" @change="savePreferences()"> 3M Consumption</label>
                    <label class="flex items-center gap-2 py-1 text-sm"><input type="checkbox" x-model="columns.cons_2m" @change="savePreferences()"> 2M Consumption</label>
                    <hr class="my-2">
                    <p class="text-xs font-medium text-gray-500 mb-2">Planning</p>
                    <label class="flex items-center gap-2 py-1 text-sm"><input type="checkbox" x-model="columns.safety" @change="savePreferences()"> Safety Stock</label>
                    <label class="flex items-center gap-2 py-1 text-sm"><input type="checkbox" x-model="columns.bom_req" @change="savePreferences()"> BOM Req</label>
                    <label class="flex items-center gap-2 py-1 text-sm"><input type="checkbox" x-model="columns.on_order" @change="savePreferences()"> On Order</label>
                    <label class="flex items-center gap-2 py-1 text-sm"><input type="checkbox" x-model="columns.forecast" @change="savePreferences()"> Forecast</label>
                    <label class="flex items-center gap-2 py-1 text-sm"><input type="checkbox" x-model="columns.remarks" @change="savePreferences()"> Remarks</label>
                </div>
            </div>
        </div>
    </form>
</div>
</div>
<!-- END HEADER SECTION -->

<!-- TABLE SECTION - Independent scrolling -->
<div class="cutter-table-section">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden h-full">
        <div class="cutter-table-wrapper">
            <table class="w-full text-xs border-collapse" id="cutterTable">
                <thead class="bg-gray-50 dark:bg-gray-700/50">
                    <tr class="text-gray-500 dark:text-gray-400">
                        <!-- # - Row Number (always visible, sticky when freeze) -->
                        <th class="px-2 py-2 text-left font-medium bg-gray-100 dark:bg-gray-700"
                            :class="freezePanes ? 'freeze-col-1' : ''">#</th>
                        <!-- MN - HDBS Code (sticky when freeze) -->
                        <th class="px-2 py-2 text-left font-medium bg-gray-100 dark:bg-gray-700"
                            :class="freezePanes ? 'freeze-col-2' : ''"
                            x-show="columns.attr_hdbs_code" data-column="mn" data-type="text">
                        <div class="column-header flex items-center gap-1 cursor-pointer select-none hover:text-gray-900 dark:hover:text-white" onclick="toggleColumnMenu(event, 'mn')">
                            <span>MN</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </th>
                    <!-- Product Name -->
                    <th class="pl-4 pr-2 py-2 text-left font-medium border-r border-gray-200 dark:border-gray-600 relative" data-column="product_name" data-type="text">
                        <div class="column-header flex items-center gap-1 cursor-pointer select-none hover:text-gray-900 dark:hover:text-white" onclick="toggleColumnMenu(event, 'product_name')">
                            <span>Product Name</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </th>
                    <!-- Dynamic Attributes (in Excel order: Cutter/Type, Size, Chamfer, Family, Category) -->
                    {% for attr in category_attributes %}
                    {% if attr.code != 'hdbs_code' and attr.code != 'hdbs' and attr.code != 'cutter_hdbs' %}
                    <th x-show="columns.attr_{{ attr.code }}" class="px-2 py-2 text-left font-medium relative" data-column="attr_{{ attr.code }}" data-type="text">
                        <div class="column-header flex items-center gap-1 cursor-pointer select-none hover:text-gray-900 dark:hover:text-white" onclick="toggleColumnMenu(event, 'attr_{{ attr.code }}')">
                            <span>{{ attr.name }}</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </th>
                    {% endif %}
                    {% endfor %}
                    <!-- Stock Variants (green background) -->
                    <th x-show="columns.eno_new" class="px-2 py-2 text-right font-medium bg-green-50 dark:bg-green-900/20 relative" title="E&O New" data-column="eno_new" data-type="number">
                        <div class="column-header flex items-center justify-end gap-1 cursor-pointer select-none hover:text-gray-900 dark:hover:text-white" onclick="toggleColumnMenu(event, 'eno_new')">
                            <span>ENO New</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </th>
                    <th x-show="columns.eno_grd" class="px-2 py-2 text-right font-medium bg-green-50 dark:bg-green-900/20 relative" title="E&O Ground" data-column="eno_grd" data-type="number">
                        <div class="column-header flex items-center justify-end gap-1 cursor-pointer select-none hover:text-gray-900 dark:hover:text-white" onclick="toggleColumnMenu(event, 'eno_grd')">
                            <span>ENO Grd</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </th>
                    <th x-show="columns.ardt_rcl" class="px-2 py-2 text-right font-medium bg-green-50 dark:bg-green-900/20 relative" title="ARDT Reclaim" data-column="ardt_rcl" data-type="number">
                        <div class="column-header flex items-center justify-end gap-1 cursor-pointer select-none hover:text-gray-900 dark:hover:text-white" onclick="toggleColumnMenu(event, 'ardt_rcl')">
                            <span>ARDT Rcl</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </th>
                    <th x-show="columns.lstk_rcl" class="px-2 py-2 text-right font-medium bg-green-50 dark:bg-green-900/20 border-r border-gray-200 dark:border-gray-600 relative" title="LSTK Reclaim" data-column="lstk_rcl" data-type="number">
                        <div class="column-header flex items-center justify-end gap-1 cursor-pointer select-none hover:text-gray-900 dark:hover:text-white" onclick="toggleColumnMenu(event, 'lstk_rcl')">
                            <span>LSTK Rcl</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </th>
                    <!-- New Stock (blue background) -->
                    <th x-show="columns.new_stock" class="px-2 py-2 text-right font-medium bg-blue-50 dark:bg-blue-900/20 relative" title="NEW-PUR only" data-column="new_stock" data-type="number">
                        <div class="column-header flex items-center justify-end gap-1 cursor-pointer select-none hover:text-gray-900 dark:hover:text-white" onclick="toggleColumnMenu(event, 'new_stock')">
                            <span>New Stock</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </th>
                    <th x-show="columns.total_new" class="px-2 py-2 text-right font-medium bg-blue-100 dark:bg-blue-900/30 border-r border-gray-200 dark:border-gray-600 relative" title="NEW-PUR + NEW-EO + NEW-RET" data-column="total_new" data-type="number">
                        <div class="column-header flex items-center justify-end gap-1 cursor-pointer select-none hover:text-gray-900 dark:hover:text-white" onclick="toggleColumnMenu(event, 'total_new')">
                            <span>Total New</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </th>
                    <!-- Consumption (yellow background) -->
                    <th x-show="columns.cons_6m" class="px-2 py-2 text-right font-medium bg-yellow-50 dark:bg-yellow-900/20 relative" data-column="cons_6m" data-type="number">
                        <div class="column-header flex items-center justify-end gap-1 cursor-pointer select-none hover:text-gray-900 dark:hover:text-white" onclick="toggleColumnMenu(event, 'cons_6m')">
                            <span>6M</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </th>
                    <th x-show="columns.cons_3m" class="px-2 py-2 text-right font-medium bg-yellow-50 dark:bg-yellow-900/20 relative" data-column="cons_3m" data-type="number">
                        <div class="column-header flex items-center justify-end gap-1 cursor-pointer select-none hover:text-gray-900 dark:hover:text-white" onclick="toggleColumnMenu(event, 'cons_3m')">
                            <span>3M</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </th>
                    <th x-show="columns.cons_2m" class="px-2 py-2 text-right font-medium bg-yellow-100 dark:bg-yellow-900/30 border-r border-gray-200 dark:border-gray-600 relative" data-column="cons_2m" data-type="number">
                        <div class="column-header flex items-center justify-end gap-1 cursor-pointer select-none hover:text-gray-900 dark:hover:text-white" onclick="toggleColumnMenu(event, 'cons_2m')">
                            <span>2M</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </th>
                    <!-- Safety (red background) -->
                    <th x-show="columns.safety" class="px-2 py-2 text-right font-medium bg-red-50 dark:bg-red-900/20 relative" data-column="safety" data-type="number">
                        <div class="column-header flex items-center justify-end gap-1 cursor-pointer select-none hover:text-gray-900 dark:hover:text-white" onclick="toggleColumnMenu(event, 'safety')">
                            <span>Safety</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </th>
                    <!-- Category (from attributes, moved here to match Excel order) -->
                    <th x-show="columns.attr_category" class="px-2 py-2 text-left font-medium border-r border-gray-200 dark:border-gray-600 relative" data-column="attr_category" data-type="text">
                        <div class="column-header flex items-center gap-1 cursor-pointer select-none hover:text-gray-900 dark:hover:text-white" onclick="toggleColumnMenu(event, 'attr_category')">
                            <span>Category</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </th>
                    <!-- Planning (green background) -->
                    <th x-show="columns.bom_req" class="px-2 py-2 text-right font-medium bg-green-50 dark:bg-green-900/20 relative" title="BOM Requirement" data-column="bom_req" data-type="number">
                        <div class="column-header flex items-center justify-end gap-1 cursor-pointer select-none hover:text-gray-900 dark:hover:text-white" onclick="toggleColumnMenu(event, 'bom_req')">
                            <span>BOM Req</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </th>
                    <th x-show="columns.on_order" class="px-2 py-2 text-right font-medium bg-green-50 dark:bg-green-900/20 relative" data-column="on_order" data-type="number">
                        <div class="column-header flex items-center justify-end gap-1 cursor-pointer select-none hover:text-gray-900 dark:hover:text-white" onclick="toggleColumnMenu(event, 'on_order')">
                            <span>On Order</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </th>
                    <th x-show="columns.forecast" class="px-2 py-2 text-right font-medium bg-green-100 dark:bg-green-900/30 border-r border-gray-200 dark:border-gray-600 relative" title="Total New + On Order - BOM Req" data-column="forecast" data-type="number">
                        <div class="column-header flex items-center justify-end gap-1 cursor-pointer select-none hover:text-gray-900 dark:hover:text-white" onclick="toggleColumnMenu(event, 'forecast')">
                            <span>Forecast</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </th>
                    <!-- Remarks -->
                    <th x-show="columns.remarks" class="px-2 py-2 text-left font-medium">Remarks</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                {% for row in cutter_data %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30 {% if row.below_safety %}bg-red-50 dark:bg-red-900/10{% endif %}">
                    <!-- Row # -->
                    <td class="px-2 py-2 text-gray-400 text-center {% if row.below_safety %}bg-red-50 dark:bg-red-900/30{% else %}bg-white dark:bg-gray-800{% endif %}"
                        :class="freezePanes ? 'freeze-col-1-body' : ''">{{ row.row_num }}</td>
                    <!-- MN (HDBS Code) -->
                    <td class="px-2 py-2 font-mono text-xs font-medium {% if row.below_safety %}bg-red-50 dark:bg-red-900/30{% else %}bg-white dark:bg-gray-800{% endif %}"
                        :class="freezePanes ? 'freeze-col-2-body' : ''"
                        x-show="columns.attr_hdbs_code" data-value="{{ row.attributes|get_item:'hdbs_code'|default:'' }}">
                        <a href="{% url 'inventory:item_detail' row.item.pk %}" class="text-blue-600 hover:text-blue-800 hover:underline" title="Open {{ row.product_name }}">
                            {{ row.attributes|get_item:'hdbs_code'|default:"-" }}
                        </a>
                    </td>
                    <!-- Product Name (with link) -->
                    <td class="pl-4 pr-2 py-2 border-r border-gray-100 dark:border-gray-700" data-value="{{ row.product_name }}">
                        <a href="{% url 'inventory:item_detail' row.item.pk %}" class="font-medium text-gray-900 dark:text-white hover:text-blue-600 text-[10px]" title="{{ row.product_name }}">
                            {{ row.product_name }}
                        </a>
                    </td>
                    <!-- Dynamic Attributes (excluding HDBS and Category which are handled separately) -->
                    {% for attr in category_attributes %}
                    {% if attr.code != 'hdbs_code' and attr.code != 'hdbs' and attr.code != 'cutter_hdbs' and attr.code != 'category' and attr.code != 'cutter_category' and attr.code != 'size_category' %}
                    <td x-show="columns.attr_{{ attr.code }}" class="px-2 py-2 text-gray-700 dark:text-gray-300" data-value="{{ row.attributes|get_item:attr.code|default:'' }}">
                        {{ row.attributes|get_item:attr.code|default:"-" }}
                    </td>
                    {% endif %}
                    {% endfor %}
                    <!-- Stock Variants -->
                    <td x-show="columns.eno_new" class="px-2 py-2 text-right font-mono bg-green-50/50 dark:bg-green-900/10 {% if row.variants|get_item:'NEW-EO' > 0 %}text-gray-900 dark:text-white{% else %}text-gray-300{% endif %}" data-value="{{ row.variants|get_item:'NEW-EO'|default:0 }}">
                        {{ row.variants|get_item:"NEW-EO"|floatformat:0|default:"-" }}
                    </td>
                    <td x-show="columns.eno_grd" class="px-2 py-2 text-right font-mono bg-green-50/50 dark:bg-green-900/10 {% if row.variants|get_item:'GRD-EO' > 0 %}text-gray-900 dark:text-white{% else %}text-gray-300{% endif %}" data-value="{{ row.variants|get_item:'GRD-EO'|default:0 }}">
                        {{ row.variants|get_item:"GRD-EO"|floatformat:0|default:"-" }}
                    </td>
                    <td x-show="columns.ardt_rcl" class="px-2 py-2 text-right font-mono bg-green-50/50 dark:bg-green-900/10 {% if row.variants|get_item:'USED-RCL' > 0 %}text-gray-900 dark:text-white{% else %}text-gray-300{% endif %}" data-value="{{ row.variants|get_item:'USED-RCL'|default:0 }}">
                        {{ row.variants|get_item:"USED-RCL"|floatformat:0|default:"-" }}
                    </td>
                    <td x-show="columns.lstk_rcl" class="px-2 py-2 text-right font-mono bg-green-50/50 dark:bg-green-900/10 border-r border-gray-100 dark:border-gray-700 {% if row.variants|get_item:'CLI-RCL' > 0 %}text-gray-900 dark:text-white{% else %}text-gray-300{% endif %}" data-value="{{ row.variants|get_item:'CLI-RCL'|default:0 }}">
                        {{ row.variants|get_item:"CLI-RCL"|floatformat:0|default:"-" }}
                    </td>
                    <!-- New Stock -->
                    <td x-show="columns.new_stock" class="px-2 py-2 text-right font-mono bg-blue-50/50 dark:bg-blue-900/10 {% if row.new_stock > 0 %}text-blue-700 dark:text-blue-300{% else %}text-gray-300{% endif %}" data-value="{{ row.new_stock }}">
                        {{ row.new_stock|floatformat:0 }}
                    </td>
                    <td x-show="columns.total_new" class="px-2 py-2 text-right font-mono font-bold bg-blue-100/50 dark:bg-blue-900/20 border-r border-gray-100 dark:border-gray-700 {% if row.total_new > 0 %}text-blue-800 dark:text-blue-200{% else %}text-gray-400{% endif %}" data-value="{{ row.total_new }}">
                        {{ row.total_new|floatformat:0 }}
                    </td>
                    <!-- Consumption -->
                    <td x-show="columns.cons_6m" class="px-2 py-2 text-right font-mono bg-yellow-50/50 dark:bg-yellow-900/10 text-yellow-700 dark:text-yellow-300" data-value="{{ row.consumption_6m }}">
                        {{ row.consumption_6m|floatformat:0 }}
                    </td>
                    <td x-show="columns.cons_3m" class="px-2 py-2 text-right font-mono bg-yellow-50/50 dark:bg-yellow-900/10 text-yellow-700 dark:text-yellow-300" data-value="{{ row.consumption_3m }}">
                        {{ row.consumption_3m|floatformat:0 }}
                    </td>
                    <td x-show="columns.cons_2m" class="px-2 py-2 text-right font-mono font-bold bg-yellow-100/50 dark:bg-yellow-900/20 border-r border-gray-100 dark:border-gray-700 text-yellow-800 dark:text-yellow-200" data-value="{{ row.consumption_2m }}">
                        {{ row.consumption_2m|floatformat:0 }}
                    </td>
                    <!-- Safety Stock -->
                    <td x-show="columns.safety" class="px-2 py-2 text-right font-mono bg-red-50/50 dark:bg-red-900/10 {% if row.below_safety %}text-red-700 dark:text-red-300 font-bold{% else %}text-gray-500{% endif %}" data-value="{{ row.safety_stock }}">
                        {{ row.safety_stock|floatformat:0 }}
                    </td>
                    <!-- Category -->
                    <td x-show="columns.attr_category" class="px-2 py-2 text-gray-700 dark:text-gray-300 border-r border-gray-100 dark:border-gray-700" data-value="{{ row.attributes|get_item:'category'|default:'' }}">
                        {{ row.attributes|get_item:'category'|default:"-" }}
                    </td>
                    <!-- Planning -->
                    <td x-show="columns.bom_req" class="px-2 py-2 text-right font-mono bg-green-50/50 dark:bg-green-900/10 text-purple-600 dark:text-purple-400" data-value="{{ row.bom_requirement }}">
                        {{ row.bom_requirement|floatformat:0 }}
                    </td>
                    <td x-show="columns.on_order" class="px-2 py-2 text-right font-mono bg-green-50/50 dark:bg-green-900/10 text-blue-600 dark:text-blue-400" data-value="{{ row.on_order }}">
                        {{ row.on_order|floatformat:0 }}
                    </td>
                    <td x-show="columns.forecast" class="px-2 py-2 text-right font-mono font-bold bg-green-100/50 dark:bg-green-900/20 border-r border-gray-100 dark:border-gray-700 {% if row.below_safety %}text-red-600 dark:text-red-400{% else %}text-green-600 dark:text-green-400{% endif %}" data-value="{{ row.forecast }}">
                        {{ row.forecast|floatformat:0 }}
                    </td>
                    <!-- Remarks -->
                    <td x-show="columns.remarks" class="px-2 py-2 text-gray-500 dark:text-gray-400 text-[10px]" title="{{ row.remarks }}">
                        {{ row.remarks|default:"-" }}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="24" class="px-4 py-8 text-center text-gray-500">
                        <i data-lucide="circle-dot" class="w-12 h-12 mx-auto text-gray-300 mb-3"></i>
                        <p>No PDC Cutters found</p>
                        <p class="text-sm mt-1">Ensure items exist with category code "CT-PDC"</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
</div>
<!-- END TABLE SECTION -->

<!-- Legend (hidden in full page view) -->
<div class="mt-4 bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4" x-show="!fullPageView" x-transition>
    <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Column Legend</h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs text-gray-500 dark:text-gray-400">
        <div class="flex items-center gap-2">
            <span class="w-4 h-4 rounded bg-green-100 dark:bg-green-900/30 border border-green-300"></span>
            <span>Stock variants (E&O, Reclaim)</span>
        </div>
        <div class="flex items-center gap-2">
            <span class="w-4 h-4 rounded bg-blue-100 dark:bg-blue-900/30 border border-blue-300"></span>
            <span>New Stock = PUR + EO + RET</span>
        </div>
        <div class="flex items-center gap-2">
            <span class="w-4 h-4 rounded bg-yellow-100 dark:bg-yellow-900/30 border border-yellow-300"></span>
            <span>Consumption (6/3/2 months)</span>
        </div>
        <div class="flex items-center gap-2">
            <span class="w-4 h-4 rounded bg-red-100 dark:bg-red-900/30 border border-red-300"></span>
            <span>Safety Stock (from 2M consumption)</span>
        </div>
    </div>
    <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700 text-xs text-gray-500">
        <strong>Forecast Formula:</strong> Total New + On Order - BOM Requirement |
        <strong>Safety Formula:</strong> 2M consumption + buffer (2-10), rounded up to nearest 5
    </div>
</div>

{% if page_obj.has_other_pages %}
<!-- Pagination -->
<div class="mt-6 flex items-center justify-between" x-show="!fullPageView" x-transition>
    <p class="text-sm text-gray-500">
        Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} cutters
    </p>
    <nav class="flex gap-1">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}&search={{ current_search }}"
           class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded hover:bg-gray-200">Prev</a>
        {% endif %}
        {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <span class="px-3 py-1 bg-blue-600 text-white rounded">{{ num }}</span>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <a href="?page={{ num }}&search={{ current_search }}"
           class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded hover:bg-gray-200">{{ num }}</a>
        {% endif %}
        {% endfor %}
        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}&search={{ current_search }}"
           class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded hover:bg-gray-200">Next</a>
        {% endif %}
    </nav>
</div>
{% endif %}

</div>

<!-- Column Filter Menu (Excel-like dropdown) -->
<div id="columnMenu" class="hidden fixed z-[100] bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 min-w-[260px] max-h-[80vh] overflow-hidden flex flex-col"
     onwheel="event.stopPropagation();" onscroll="event.stopPropagation();">
    <!-- Sort Section -->
    <div class="p-2 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
        <button type="button" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center gap-2" onclick="sortColumn('asc')">
            <i data-lucide="arrow-up-a-z" class="w-4 h-4 text-gray-500"></i>
            <span class="sort-asc-text">Sort A to Z</span>
        </button>
        <button type="button" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center gap-2" onclick="sortColumn('desc')">
            <i data-lucide="arrow-down-z-a" class="w-4 h-4 text-gray-500"></i>
            <span class="sort-desc-text">Sort Z to A</span>
        </button>
    </div>

    <!-- Clear Filter -->
    <div class="p-2 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
        <button type="button" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center gap-2" onclick="clearColumnFilter()">
            <i data-lucide="filter-x" class="w-4 h-4 text-gray-500"></i>
            Clear Filter from "<span id="clearFilterColumnName"></span>"
        </button>
    </div>

    <!-- Custom Filter Section -->
    <div class="p-2 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
        <div class="px-3 py-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Custom Filter</div>
        <div class="px-3 py-2 space-y-2">
            <select id="filterOperator" class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                <option value="contains">Contains</option>
                <option value="equals">Equals</option>
                <option value="not_equals">Does Not Equal</option>
                <option value="starts_with">Starts With</option>
                <option value="ends_with">Ends With</option>
                <option value="greater">Greater Than</option>
                <option value="less">Less Than</option>
                <option value="between">Between</option>
            </select>
            <input type="text" id="filterValue1" placeholder="Value..." class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200">
            <input type="text" id="filterValue2" placeholder="Value 2 (for Between)" class="hidden w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200">
            <button type="button" class="w-full px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700" onclick="applyCustomFilter()">
                Apply Filter
            </button>
        </div>
    </div>

    <!-- Values List (with checkboxes) -->
    <div class="p-2 flex-1 flex flex-col min-h-0">
        <div class="px-3 py-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase flex items-center justify-between flex-shrink-0">
            <span>Filter by Values</span>
            <div class="flex gap-2">
                <button type="button" class="text-blue-600 hover:text-blue-800 text-xs" onclick="selectAllValues()">All</button>
                <button type="button" class="text-blue-600 hover:text-blue-800 text-xs" onclick="selectNoneValues()">None</button>
            </div>
        </div>
        <div class="px-2 py-1 flex-shrink-0">
            <input type="text" id="valueSearch" placeholder="Search values..." class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200" oninput="filterValuesList()">
        </div>
        <div id="valuesList" class="flex-1 overflow-y-auto px-2 py-1 min-h-[100px] max-h-[200px]"
             onwheel="event.stopPropagation();">
            <!-- Values will be populated dynamically -->
        </div>
        <div class="px-2 pt-2 flex-shrink-0">
            <button type="button" class="w-full px-3 py-1.5 text-sm bg-emerald-600 text-white rounded hover:bg-emerald-700" onclick="applyValueFilter()">
                Apply
            </button>
        </div>
    </div>
</div>

<script>
    // Default column visibility (matching Excel)
    const defaultColumns = {
        // Attributes - Excel visible ones
        {% for attr in category_attributes %}
        'attr_{{ attr.code }}': {{ attr.visible_default|yesno:"true,false" }},
        {% endfor %}
        // Stock variants
        eno_new: true,
        eno_grd: true,
        ardt_rcl: true,
        lstk_rcl: true,
        // Stock totals
        new_stock: true,
        total_new: true,
        // Consumption
        cons_6m: true,
        cons_3m: true,
        cons_2m: true,
        // Planning
        safety: true,
        bom_req: true,
        on_order: true,
        forecast: true,
        remarks: true
    };

    function cutterInventory() {
        return {
            columns: { ...defaultColumns },
            freezePanes: false,
            fullPageView: false,
            textWrap: false,
            showColumnMenu: false,

            init() {
                // Load saved preferences from localStorage
                const saved = localStorage.getItem('cutterInventoryPrefs');
                if (saved) {
                    try {
                        const prefs = JSON.parse(saved);
                        if (prefs.columns) {
                            this.columns = { ...defaultColumns, ...prefs.columns };
                        }
                        if (prefs.freezePanes !== undefined) {
                            this.freezePanes = prefs.freezePanes;
                        }
                        if (prefs.fullPageView !== undefined) {
                            this.fullPageView = prefs.fullPageView;
                            if (this.fullPageView) {
                                this.applySidebarState(true);
                                this.applyPageHeaderState(true);
                            }
                        }
                        if (prefs.textWrap !== undefined) {
                            this.textWrap = prefs.textWrap;
                        }
                    } catch (e) {
                        console.error('Failed to load preferences:', e);
                    }
                }
            },

            savePreferences() {
                const prefs = {
                    columns: this.columns,
                    freezePanes: this.freezePanes,
                    fullPageView: this.fullPageView,
                    textWrap: this.textWrap
                };
                localStorage.setItem('cutterInventoryPrefs', JSON.stringify(prefs));
            },

            toggleFreezePanes() {
                this.freezePanes = !this.freezePanes;
                this.savePreferences();
            },

            toggleFullPageView() {
                this.fullPageView = !this.fullPageView;
                this.applySidebarState(this.fullPageView);
                this.applyPageHeaderState(this.fullPageView);
                this.savePreferences();
            },

            applySidebarState(collapse) {
                // Access the parent Alpine component for sidebar
                const mainEl = document.querySelector('[x-data]');
                if (mainEl && mainEl._x_dataStack) {
                    const rootData = mainEl._x_dataStack[0];
                    if (rootData && rootData.sidebarOpen !== undefined) {
                        rootData.sidebarOpen = !collapse;
                    }
                }
            },

            applyPageHeaderState(hide) {
                // Hide/show the page header
                const pageHeader = document.getElementById('pageHeader');
                if (pageHeader) {
                    pageHeader.style.display = hide ? 'none' : '';
                }
            },

            toggleTextWrap() {
                this.textWrap = !this.textWrap;
                this.savePreferences();
            },

            resetToDefaults() {
                this.columns = { ...defaultColumns };
                this.savePreferences();
            },

            showAllColumns() {
                Object.keys(this.columns).forEach(key => {
                    this.columns[key] = true;
                });
                this.savePreferences();
            }
        };
    }

    // Column menu state
    let currentColumn = null;
    let currentColumnType = 'text';
    let columnValues = [];
    let selectedValues = new Set();

    // Toggle column menu
    function toggleColumnMenu(event, column) {
        event.stopPropagation();
        const menu = document.getElementById('columnMenu');
        const th = event.currentTarget.closest('th');

        currentColumnType = th.dataset.type || 'text';
        currentColumn = column;

        if (currentColumnType === 'number') {
            document.querySelector('.sort-asc-text').textContent = 'Sort Smallest to Largest';
            document.querySelector('.sort-desc-text').textContent = 'Sort Largest to Smallest';
        } else {
            document.querySelector('.sort-asc-text').textContent = 'Sort A to Z';
            document.querySelector('.sort-desc-text').textContent = 'Sort Z to A';
        }

        document.getElementById('clearFilterColumnName').textContent = th.querySelector('span').textContent;
        populateValuesList(column);
        menu.classList.remove('hidden');

        const rect = th.getBoundingClientRect();
        const menuRect = menu.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const padding = 10;

        let left = rect.left;
        let top = rect.bottom + 5;

        if (left + menuRect.width > viewportWidth - padding) {
            left = viewportWidth - menuRect.width - padding;
        }
        if (left < padding) {
            left = padding;
        }
        if (top + menuRect.height > viewportHeight - padding) {
            top = rect.top - menuRect.height - 5;
            if (top < padding) {
                top = padding;
            }
        }

        menu.style.left = left + 'px';
        menu.style.top = top + 'px';
    }

    function populateValuesList(column) {
        const table = document.getElementById('cutterTable');
        const rows = table.querySelectorAll('tbody tr');
        const th = table.querySelector(`th[data-column="${column}"]`);
        if (!th) return;

        const colIndex = Array.from(th.parentNode.children).indexOf(th);
        const valuesSet = new Set();

        rows.forEach(row => {
            const cell = row.children[colIndex];
            if (cell) {
                const value = cell.dataset.value || cell.textContent.trim();
                if (value && value !== '--' && value !== '-') {
                    valuesSet.add(value);
                }
            }
        });

        columnValues = Array.from(valuesSet).sort((a, b) => {
            const numA = parseFloat(a);
            const numB = parseFloat(b);
            if (!isNaN(numA) && !isNaN(numB)) {
                return numA - numB;
            }
            return a.localeCompare(b);
        });
        selectedValues = new Set(columnValues);
        renderValuesList();
    }

    function renderValuesList(filter = '') {
        const container = document.getElementById('valuesList');
        const filtered = filter
            ? columnValues.filter(v => v.toLowerCase().includes(filter.toLowerCase()))
            : columnValues;

        container.innerHTML = filtered.map(value => `
            <label class="flex items-center gap-2 px-2 py-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer">
                <input type="checkbox" class="value-checkbox rounded border-gray-300 dark:border-gray-600 text-blue-600"
                       value="${value}" ${selectedValues.has(value) ? 'checked' : ''} onchange="toggleValue('${value.replace(/'/g, "\\'")}')">
                <span class="text-sm text-gray-700 dark:text-gray-200 truncate">${value}</span>
            </label>
        `).join('');

        if (!filter) {
            container.innerHTML = `
                <label class="flex items-center gap-2 px-2 py-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer">
                    <input type="checkbox" class="value-checkbox rounded border-gray-300 dark:border-gray-600 text-blue-600"
                           value="__blank__" checked onchange="toggleValue('__blank__')">
                    <span class="text-sm text-gray-500 dark:text-gray-400 italic">(Blank)</span>
                </label>
            ` + container.innerHTML;
        }
    }

    function filterValuesList() {
        renderValuesList(document.getElementById('valueSearch').value);
    }

    function toggleValue(value) {
        if (selectedValues.has(value)) {
            selectedValues.delete(value);
        } else {
            selectedValues.add(value);
        }
    }

    function selectAllValues() {
        selectedValues = new Set(columnValues);
        selectedValues.add('__blank__');
        renderValuesList();
    }

    function selectNoneValues() {
        selectedValues = new Set();
        renderValuesList();
    }

    function sortColumn(direction) {
        const table = document.getElementById('cutterTable');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const th = table.querySelector(`th[data-column="${currentColumn}"]`);
        if (!th) return;

        const colIndex = Array.from(th.parentNode.children).indexOf(th);

        rows.sort((a, b) => {
            const cellA = a.children[colIndex];
            const cellB = b.children[colIndex];
            if (!cellA || !cellB) return 0;

            let valA = cellA.dataset.value || cellA.textContent.trim();
            let valB = cellB.dataset.value || cellB.textContent.trim();

            const numA = parseFloat(valA);
            const numB = parseFloat(valB);
            if (!isNaN(numA) && !isNaN(numB)) {
                return direction === 'asc' ? numA - numB : numB - numA;
            }
            return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
        });

        rows.forEach(row => tbody.appendChild(row));
        closeColumnMenu();
    }

    function clearColumnFilter() {
        const table = document.getElementById('cutterTable');
        table.querySelectorAll('tbody tr').forEach(row => row.style.display = '');
        closeColumnMenu();
    }

    function applyCustomFilter() {
        const operator = document.getElementById('filterOperator').value;
        const value1 = document.getElementById('filterValue1').value.toLowerCase();
        const value2 = document.getElementById('filterValue2').value.toLowerCase();

        const table = document.getElementById('cutterTable');
        const rows = table.querySelectorAll('tbody tr');
        const th = table.querySelector(`th[data-column="${currentColumn}"]`);
        if (!th) return;

        const colIndex = Array.from(th.parentNode.children).indexOf(th);

        rows.forEach(row => {
            const cell = row.children[colIndex];
            if (!cell) return;

            const cellValue = (cell.dataset.value || cell.textContent.trim()).toLowerCase();
            let show = true;

            switch(operator) {
                case 'contains': show = cellValue.includes(value1); break;
                case 'equals': show = cellValue === value1; break;
                case 'not_equals': show = cellValue !== value1; break;
                case 'starts_with': show = cellValue.startsWith(value1); break;
                case 'ends_with': show = cellValue.endsWith(value1); break;
                case 'greater': show = parseFloat(cellValue) > parseFloat(value1); break;
                case 'less': show = parseFloat(cellValue) < parseFloat(value1); break;
                case 'between':
                    const num = parseFloat(cellValue);
                    show = num >= parseFloat(value1) && num <= parseFloat(value2);
                    break;
            }

            row.style.display = show ? '' : 'none';
        });

        closeColumnMenu();
    }

    function applyValueFilter() {
        const table = document.getElementById('cutterTable');
        const rows = table.querySelectorAll('tbody tr');
        const th = table.querySelector(`th[data-column="${currentColumn}"]`);
        if (!th) return;

        const colIndex = Array.from(th.parentNode.children).indexOf(th);

        rows.forEach(row => {
            const cell = row.children[colIndex];
            if (!cell) return;

            const cellValue = cell.dataset.value || cell.textContent.trim();
            const isBlank = !cellValue || cellValue === '--' || cellValue === '-';

            let show = false;
            if (isBlank && selectedValues.has('__blank__')) {
                show = true;
            } else if (selectedValues.has(cellValue)) {
                show = true;
            }

            row.style.display = show ? '' : 'none';
        });

        closeColumnMenu();
    }

    function closeColumnMenu() {
        document.getElementById('columnMenu').classList.add('hidden');
    }

    document.getElementById('filterOperator').addEventListener('change', function() {
        const value2 = document.getElementById('filterValue2');
        value2.classList.toggle('hidden', this.value !== 'between');
    });

    document.addEventListener('click', function(e) {
        const menu = document.getElementById('columnMenu');
        if (!menu.contains(e.target) && !e.target.closest('.column-header')) {
            closeColumnMenu();
        }
    });

    // Close menu on scroll, but not when scrolling inside the menu itself
    window.addEventListener('scroll', (e) => {
        const menu = document.getElementById('columnMenu');
        if (!menu.contains(e.target)) {
            closeColumnMenu();
        }
    }, true);
    window.addEventListener('resize', () => closeColumnMenu());

    const observer = new MutationObserver(() => {
        if (typeof lucide !== 'undefined') lucide.createIcons();
    });
    observer.observe(document.getElementById('columnMenu'), { attributes: true, attributeFilter: ['class'] });
</script>
{% endblock %}
