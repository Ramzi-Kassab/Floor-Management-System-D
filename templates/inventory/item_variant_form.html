{% extends "base.html" %}

{% block title %}{{ page_title }} - ARDT FMS{% endblock %}

{% block page_header %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{ form_title }}</h1>
        <p class="text-gray-600 dark:text-gray-400">Base Item: {{ item.code }} - {{ item.name }}</p>
    </div>
    <a href="{% url 'inventory:item_detail' item.pk %}" class="inline-flex items-center px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800">
        <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>Back to Item
    </a>
</div>
{% endblock %}

{% block content %}
<div class="max-w-3xl" x-data="variantForm()">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
        <form method="post">
            {% csrf_token %}

            {% if form.errors %}
            <div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
                <div class="flex items-start">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-red-500 mr-3 mt-0.5"></i>
                    <div>
                        <h3 class="text-sm font-medium text-red-800 dark:text-red-200">Please correct the following errors:</h3>
                        <ul class="mt-2 text-sm text-red-700 dark:text-red-300 list-disc list-inside">
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                <li>{% if field != '__all__' %}<strong>{{ field }}:</strong> {% endif %}{{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="space-y-6">
                <!-- Variant Case Selection -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                        <i data-lucide="layers" class="w-5 h-5 inline mr-2"></i>
                        Variant Type
                    </h3>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Variant Case *</label>
                        <select name="variant_case" x-model="selectedCase" @change="onCaseChange()"
                            class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500" required>
                            <option value="">-- Select Variant Case --</option>
                            {% for vc in variant_cases %}
                            <option value="{{ vc.pk }}"
                                    data-condition="{{ vc.condition }}"
                                    data-acquisition="{{ vc.acquisition }}"
                                    data-ownership="{{ vc.ownership }}"
                                    data-reclaim="{{ vc.reclaim_category }}"
                                    {% if form.variant_case.value|stringformat:"s" == vc.pk|stringformat:"s" %}selected{% endif %}>
                                {{ vc.name }}
                            </option>
                            {% endfor %}
                        </select>
                        {% if form.variant_case.errors %}<p class="text-red-600 text-sm mt-1">{{ form.variant_case.errors.0 }}</p>{% endif %}

                        <!-- Case Details Display -->
                        <div x-show="selectedCase" x-cloak class="mt-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                <div>
                                    <span class="text-gray-500 dark:text-gray-400">Condition:</span>
                                    <span class="ml-1 font-medium" :class="caseDetails.condition === 'NEW' ? 'text-green-600' : 'text-yellow-600'" x-text="caseDetails.condition || '-'"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500 dark:text-gray-400">Origin:</span>
                                    <span class="ml-1 font-medium text-blue-600" x-text="caseDetails.acquisition || '-'"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500 dark:text-gray-400">Owner:</span>
                                    <span class="ml-1 font-medium" :class="caseDetails.ownership === 'ARDT' ? 'text-purple-600' : 'text-orange-600'" x-text="caseDetails.ownership || '-'"></span>
                                </div>
                                <div x-show="caseDetails.reclaim">
                                    <span class="text-gray-500 dark:text-gray-400">Category:</span>
                                    <span class="ml-1 font-medium text-gray-700 dark:text-gray-300" x-text="caseDetails.reclaim || '-'"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick info about variant cases -->
                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 text-sm text-blue-700 dark:text-blue-300">
                        <p><strong>Tip:</strong> Variant cases define combinations of:</p>
                        <ul class="list-disc ml-5 mt-1 space-y-0.5">
                            <li><strong>Condition:</strong> New or Used</li>
                            <li><strong>Origin:</strong> Purchased, Reclaimed, Client-Provided, Manufactured</li>
                            <li><strong>Owner:</strong> ARDT (us) or Client</li>
                            <li><strong>Category:</strong> For reclaimed: Retrofit, E&O, Ground, Standard</li>
                        </ul>
                        <p class="mt-2">Don't see the case you need? <a href="{% url 'inventory:variant_create' %}" class="underline">Create a new variant case</a></p>
                    </div>
                </div>

                <!-- Customer/Account (for Client ownership) -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-6" x-show="showCustomer" x-cloak>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                        <i data-lucide="building" class="w-5 h-5 inline mr-2"></i>
                        Owner Account
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Customer *</label>
                            <select name="customer"
                                class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500"
                                :required="showCustomer">
                                <option value="">-- Select Customer --</option>
                                {% for customer in customers %}
                                <option value="{{ customer.pk }}" {% if form.customer.value|stringformat:"s" == customer.pk|stringformat:"s" %}selected{% endif %}>
                                    {{ customer.name }}{% if customer.code %} ({{ customer.code }}){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Required for client-owned variants.</p>
                            {% if form.customer.errors %}<p class="text-red-600 text-sm mt-1">{{ form.customer.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Account *</label>
                            <select name="account"
                                class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500"
                                :required="showCustomer">
                                <option value="">-- Select Account --</option>
                                <option value="LSTK" {% if form.account.value == "LSTK" %}selected{% endif %}>LSTK</option>
                                <option value="CORE_HEADS" {% if form.account.value == "CORE_HEADS" %}selected{% endif %}>Core Heads</option>
                                <option value="REGIONAL" {% if form.account.value == "REGIONAL" %}selected{% endif %}>Regional</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Account type for this client variant.</p>
                            {% if form.account.errors %}<p class="text-red-600 text-sm mt-1">{{ form.account.errors.0 }}</p>{% endif %}
                        </div>
                    </div>
                </div>

                <!-- Costing -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                        <i data-lucide="dollar-sign" class="w-5 h-5 inline mr-2"></i>
                        Costing
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Standard Cost (SAR)</label>
                            <input type="number" name="standard_cost" step="0.01" min="0"
                                value="{{ form.standard_cost.value|default:'' }}"
                                class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500"
                                placeholder="0.00">
                            <p class="text-xs text-gray-500 mt-1">Standard cost for this variant</p>
                            {% if form.standard_cost.errors %}<p class="text-red-600 text-sm mt-1">{{ form.standard_cost.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Last Cost (SAR)</label>
                            <input type="number" name="last_cost" step="0.01" min="0"
                                value="{{ form.last_cost.value|default:'' }}"
                                class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500"
                                placeholder="0.00">
                            <p class="text-xs text-gray-500 mt-1">Most recent purchase/acquisition cost</p>
                        </div>
                    </div>
                </div>

                <!-- Legacy References -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                        <i data-lucide="link" class="w-5 h-5 inline mr-2"></i>
                        Legacy References
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Legacy MAT Number</label>
                            <input type="text" name="legacy_mat_no"
                                value="{{ form.legacy_mat_no.value|default:'' }}"
                                class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500"
                                placeholder="e.g., MAT-12345">
                            <p class="text-xs text-gray-500 mt-1">Old system MAT number</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ERP Item Number</label>
                            <input type="text" name="erp_item_no"
                                value="{{ form.erp_item_no.value|default:'' }}"
                                class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500 {% if form.erp_item_no.errors %}border-red-500{% endif %}"
                                placeholder="e.g., ERP-67890">
                            <p class="text-xs text-gray-500 mt-1">ERP system reference (must be unique)</p>
                            {% if form.erp_item_no.errors %}<p class="text-red-600 text-sm mt-1">{{ form.erp_item_no.errors.0 }}</p>{% endif %}
                        </div>
                    </div>
                </div>

                <!-- Status & Notes -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                        <i data-lucide="settings" class="w-5 h-5 inline mr-2"></i>
                        Status & Notes
                    </h3>
                    <div class="flex items-center mb-4">
                        <input type="checkbox" name="is_active" id="is_active"
                            {% if form.is_active.value or not object %}checked{% endif %}
                            class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                        <label for="is_active" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Active</label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notes</label>
                        <textarea name="notes" rows="3"
                            class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500"
                            placeholder="Additional notes about this variant...">{{ form.notes.value|default:'' }}</textarea>
                    </div>
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                <a href="{% url 'inventory:item_detail' item.pk %}" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900">Cancel</a>
                <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                    {% if object %}Update{% else %}Create{% endif %} Variant
                </button>
            </div>
        </form>
    </div>

    <!-- Existing Variants Summary -->
    {% if item.variants.exists %}
    <div class="mt-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Existing Variants</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-3 py-2 text-left">Code</th>
                        <th class="px-3 py-2 text-left">Case</th>
                        <th class="px-3 py-2 text-left">Customer</th>
                        <th class="px-3 py-2 text-right">Cost</th>
                        <th class="px-3 py-2 text-center">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% for v in item.variants.all %}
                    <tr>
                        <td class="px-3 py-2 font-mono text-xs">{{ v.code }}</td>
                        <td class="px-3 py-2">{{ v.variant_case.name|default:"-" }}</td>
                        <td class="px-3 py-2">{{ v.customer.name|default:"-" }}</td>
                        <td class="px-3 py-2 text-right">{{ v.standard_cost|default:"-" }}</td>
                        <td class="px-3 py-2 text-center">
                            {% if v.is_active %}
                            <span class="px-2 py-0.5 text-xs bg-green-100 text-green-800 rounded-full">Active</span>
                            {% else %}
                            <span class="px-2 py-0.5 text-xs bg-gray-100 text-gray-600 rounded-full">Inactive</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<script>
function variantForm() {
    return {
        selectedCase: '{{ form.variant_case.value|default:"" }}',
        showCustomer: false,
        caseDetails: {
            condition: '',
            acquisition: '',
            ownership: '',
            reclaim: ''
        },

        init() {
            if (this.selectedCase) {
                this.onCaseChange();
            }
        },

        onCaseChange() {
            const select = document.querySelector('select[name="variant_case"]');
            const option = select.options[select.selectedIndex];

            if (option && option.value) {
                this.caseDetails = {
                    condition: option.dataset.condition || '',
                    acquisition: option.dataset.acquisition || '',
                    ownership: option.dataset.ownership || '',
                    reclaim: option.dataset.reclaim || ''
                };
                // Show customer field for CLIENT ownership
                this.showCustomer = this.caseDetails.ownership === 'CLIENT';
            } else {
                this.caseDetails = { condition: '', acquisition: '', ownership: '', reclaim: '' };
                this.showCustomer = false;
            }
        }
    }
}
</script>
{% endblock %}
