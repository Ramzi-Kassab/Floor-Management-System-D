{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }} - Inventory{% endblock %}

{% block content %}
<div class="space-y-6" x-data="attributeTable()">
    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{ page_title }}</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400">Global list of attribute names (Size, Color, Material, etc.)</p>
        </div>
        <a href="{% url 'inventory:standalone_attribute_create' %}"
           class="inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
            Create Attribute
        </a>
    </div>

    <!-- Info Card -->
    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
        <div class="flex items-start gap-3">
            <i data-lucide="info" class="w-5 h-5 text-blue-600 dark:text-blue-400 mt-0.5"></i>
            <div class="text-sm text-blue-800 dark:text-blue-200">
                <p class="font-medium mb-1">How Attributes Work</p>
                <p>Attributes are just names (Size, Color, Material). When you link an attribute to a category, you define its type (text, number, select), unit, and validation rules there.</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions Bar -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4">
        <div class="flex flex-wrap gap-4 items-center justify-between">
            <div class="flex items-center gap-4">
                <button type="button" @click="resetFilters()" class="px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                    <i data-lucide="filter-x" class="w-4 h-4 inline mr-1"></i>Reset Filters
                </button>
            </div>
            <div class="flex items-center gap-4 text-sm">
                <span class="text-gray-500 dark:text-gray-400">
                    Showing <span class="font-medium" x-text="visibleCount"></span> of {{ attributes|length }} attributes
                </span>
            </div>
        </div>
    </div>

    <!-- Attributes Table with Sortable/Filterable Headers -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
            <table class="w-full text-sm">
                <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                    <!-- Header Row with Sort -->
                    <tr class="border-b border-gray-200 dark:border-gray-600">
                        <th class="px-4 py-2 text-left cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                            @click="sortBy('code')">
                            <div class="flex items-center gap-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                                Code
                                <span x-show="sortField === 'code'" class="text-primary-600">
                                    <i x-show="sortDir === 'asc'" data-lucide="chevron-up" class="w-4 h-4"></i>
                                    <i x-show="sortDir === 'desc'" data-lucide="chevron-down" class="w-4 h-4"></i>
                                </span>
                                <i x-show="sortField !== 'code'" data-lucide="chevrons-up-down" class="w-4 h-4 opacity-30"></i>
                            </div>
                        </th>
                        <th class="px-4 py-2 text-left cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                            @click="sortBy('name')">
                            <div class="flex items-center gap-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                                Name
                                <span x-show="sortField === 'name'" class="text-primary-600">
                                    <i x-show="sortDir === 'asc'" data-lucide="chevron-up" class="w-4 h-4"></i>
                                    <i x-show="sortDir === 'desc'" data-lucide="chevron-down" class="w-4 h-4"></i>
                                </span>
                                <i x-show="sortField !== 'name'" data-lucide="chevrons-up-down" class="w-4 h-4 opacity-30"></i>
                            </div>
                        </th>
                        <th class="px-4 py-2 text-left cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                            @click="sortBy('classification')">
                            <div class="flex items-center gap-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                                Classification
                                <span x-show="sortField === 'classification'" class="text-primary-600">
                                    <i x-show="sortDir === 'asc'" data-lucide="chevron-up" class="w-4 h-4"></i>
                                    <i x-show="sortDir === 'desc'" data-lucide="chevron-down" class="w-4 h-4"></i>
                                </span>
                                <i x-show="sortField !== 'classification'" data-lucide="chevrons-up-down" class="w-4 h-4 opacity-30"></i>
                            </div>
                        </th>
                        <th class="px-4 py-2 text-left cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                            @click="sortBy('type')">
                            <div class="flex items-center gap-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                                Suggested Type
                                <span x-show="sortField === 'type'" class="text-primary-600">
                                    <i x-show="sortDir === 'asc'" data-lucide="chevron-up" class="w-4 h-4"></i>
                                    <i x-show="sortDir === 'desc'" data-lucide="chevron-down" class="w-4 h-4"></i>
                                </span>
                                <i x-show="sortField !== 'type'" data-lucide="chevrons-up-down" class="w-4 h-4 opacity-30"></i>
                            </div>
                        </th>
                        <th class="px-4 py-2 text-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                            @click="sortBy('status')">
                            <div class="flex items-center justify-center gap-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                                Status
                                <span x-show="sortField === 'status'" class="text-primary-600">
                                    <i x-show="sortDir === 'asc'" data-lucide="chevron-up" class="w-4 h-4"></i>
                                    <i x-show="sortDir === 'desc'" data-lucide="chevron-down" class="w-4 h-4"></i>
                                </span>
                                <i x-show="sortField !== 'status'" data-lucide="chevrons-up-down" class="w-4 h-4 opacity-30"></i>
                            </div>
                        </th>
                        <th class="px-4 py-2 text-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                            @click="sortBy('usedIn')">
                            <div class="flex items-center justify-center gap-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                                Used In
                                <span x-show="sortField === 'usedIn'" class="text-primary-600">
                                    <i x-show="sortDir === 'asc'" data-lucide="chevron-up" class="w-4 h-4"></i>
                                    <i x-show="sortDir === 'desc'" data-lucide="chevron-down" class="w-4 h-4"></i>
                                </span>
                                <i x-show="sortField !== 'usedIn'" data-lucide="chevrons-up-down" class="w-4 h-4 opacity-30"></i>
                            </div>
                        </th>
                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Actions</th>
                    </tr>
                    <!-- Filter Row -->
                    <tr class="bg-gray-100 dark:bg-gray-600/50">
                        <th class="px-4 py-2">
                            <input type="text" x-model="filters.code" @input="applyFilters()"
                                   placeholder="Filter..."
                                   class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-primary-500">
                        </th>
                        <th class="px-4 py-2">
                            <input type="text" x-model="filters.name" @input="applyFilters()"
                                   placeholder="Filter..."
                                   class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-primary-500">
                        </th>
                        <th class="px-4 py-2">
                            <select x-model="filters.classification" @change="applyFilters()"
                                    class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-primary-500">
                                <option value="">All</option>
                                {% for value, label in classification_choices %}
                                <option value="{{ value }}">{{ value }}</option>
                                {% endfor %}
                            </select>
                        </th>
                        <th class="px-4 py-2">
                            <select x-model="filters.type" @change="applyFilters()"
                                    class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-primary-500">
                                <option value="">All</option>
                                {% for value, label in type_choices %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </th>
                        <th class="px-4 py-2">
                            <select x-model="filters.status" @change="applyFilters()"
                                    class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-primary-500">
                                <option value="">All</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </th>
                        <th class="px-4 py-2"></th>
                        <th class="px-4 py-2"></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    <template x-for="attr in sortedAttributes" :key="attr.id">
                        <tr x-show="attr.visible"
                            class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                            <td class="px-4 py-3">
                                <code class="px-2 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono" x-text="attr.code"></code>
                            </td>
                            <td class="px-4 py-3">
                                <span class="font-medium text-gray-900 dark:text-white" x-text="attr.name"></span>
                            </td>
                            <td class="px-4 py-3">
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200"
                                      x-text="attr.classification"></span>
                            </td>
                            <td class="px-4 py-3 text-gray-500 dark:text-gray-400" x-text="attr.typeDisplay"></td>
                            <td class="px-4 py-3 text-center">
                                <span x-show="attr.isActive" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Active</span>
                                <span x-show="!attr.isActive" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-400">Inactive</span>
                            </td>
                            <td class="px-4 py-3 text-center text-gray-500 dark:text-gray-400">
                                <span x-text="attr.usedIn + ' categories'"></span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <div class="flex items-center justify-end gap-2">
                                    <a :href="attr.editUrl"
                                       class="p-1.5 text-gray-500 hover:text-primary-600 dark:text-gray-400 dark:hover:text-primary-400 transition-colors"
                                       title="Edit">
                                        <i data-lucide="pencil" class="w-4 h-4"></i>
                                    </a>
                                    <a :href="attr.deleteUrl"
                                       class="p-1.5 text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400 transition-colors"
                                       title="Delete">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- No results message -->
        <div x-show="visibleCount === 0" class="text-center py-12">
            <i data-lucide="search-x" class="w-12 h-12 mx-auto mb-4 text-gray-300 dark:text-gray-600"></i>
            <p class="text-gray-500 dark:text-gray-400 mb-2">No attributes match your filters.</p>
            <button type="button" @click="resetFilters()" class="text-primary-600 hover:text-primary-800 text-sm">
                Reset Filters
            </button>
        </div>

        <!-- Empty state (when no attributes exist at all) -->
        {% if not attributes %}
        <div class="px-6 py-12 text-center">
            <div class="flex flex-col items-center">
                <i data-lucide="tag" class="w-12 h-12 text-gray-300 dark:text-gray-600 mb-4"></i>
                <p class="text-gray-500 dark:text-gray-400 mb-2">No attributes found</p>
                <p class="text-sm text-gray-400 dark:text-gray-500 mb-4">
                    Create attributes like Size, Color, Material to use across categories
                </p>
                <a href="{% url 'inventory:standalone_attribute_create' %}"
                   class="inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                    Create Attribute
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function attributeTable() {
    // Build attributes array from Django template
    const rawAttributes = [
        {% for attr in attributes %}
        {
            id: {{ attr.id }},
            code: "{{ attr.code|escapejs }}",
            name: "{{ attr.name|escapejs }}",
            classification: "{{ attr.classification|escapejs }}",
            type: "{{ attr.data_type|escapejs }}",
            typeDisplay: "{{ attr.get_data_type_display|escapejs }}",
            isActive: {{ attr.is_active|yesno:"true,false" }},
            status: {{ attr.is_active|yesno:"'active','inactive'" }},
            usedIn: {{ attr.category_usages.count|default:0 }},
            editUrl: "{% url 'inventory:standalone_attribute_update' pk=attr.pk %}",
            deleteUrl: "{% url 'inventory:standalone_attribute_delete' pk=attr.pk %}",
            visible: true
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    return {
        attributes: rawAttributes,
        sortField: 'name',
        sortDir: 'asc',
        filters: {
            code: '',
            name: '',
            classification: '',
            type: '',
            status: ''
        },
        visibleCount: rawAttributes.length,

        get sortedAttributes() {
            return [...this.attributes].sort((a, b) => {
                let aVal = a[this.sortField];
                let bVal = b[this.sortField];

                // Handle numeric sorting for usedIn
                if (this.sortField === 'usedIn') {
                    aVal = Number(aVal) || 0;
                    bVal = Number(bVal) || 0;
                    return this.sortDir === 'asc' ? aVal - bVal : bVal - aVal;
                }

                // String sorting
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();

                if (aVal < bVal) return this.sortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return this.sortDir === 'asc' ? 1 : -1;
                return 0;
            });
        },

        sortBy(field) {
            if (this.sortField === field) {
                this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                this.sortField = field;
                this.sortDir = 'asc';
            }
            // Re-initialize Lucide icons after sort
            this.$nextTick(() => {
                if (typeof lucide !== 'undefined') lucide.createIcons();
            });
        },

        applyFilters() {
            let count = 0;
            this.attributes.forEach(attr => {
                const matchCode = !this.filters.code ||
                    attr.code.toLowerCase().includes(this.filters.code.toLowerCase());
                const matchName = !this.filters.name ||
                    attr.name.toLowerCase().includes(this.filters.name.toLowerCase());
                const matchClass = !this.filters.classification ||
                    attr.classification === this.filters.classification;
                const matchType = !this.filters.type ||
                    attr.type === this.filters.type;
                const matchStatus = !this.filters.status ||
                    attr.status === this.filters.status;

                attr.visible = matchCode && matchName && matchClass && matchType && matchStatus;
                if (attr.visible) count++;
            });
            this.visibleCount = count;
        },

        resetFilters() {
            this.filters = { code: '', name: '', classification: '', type: '', status: '' };
            this.attributes.forEach(attr => attr.visible = true);
            this.visibleCount = this.attributes.length;
        },

        init() {
            // Re-initialize Lucide icons
            this.$nextTick(() => {
                if (typeof lucide !== 'undefined') lucide.createIcons();
            });
        }
    }
}
</script>
{% endblock %}
