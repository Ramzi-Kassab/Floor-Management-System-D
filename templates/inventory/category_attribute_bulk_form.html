{% extends "base.html" %}

{% block title %}{{ page_title }} - ARDT FMS{% endblock %}

{% block page_header %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{ page_title }}</h1>
        <p class="text-gray-600 dark:text-gray-400">
            {% if phase == 'select' %}
            Select attributes to add or edit for this category
            {% else %}
            Configure how each attribute will be used in this category
            {% endif %}
        </p>
    </div>
    <a href="{% url 'inventory:category_detail' category.pk %}" class="inline-flex items-center px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800">
        <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>Back to Category
    </a>
</div>
{% endblock %}

{% block content %}
{% if phase == 'select' %}
<!-- ============================================== -->
<!-- PHASE 1: ATTRIBUTE SELECTION                   -->
<!-- ============================================== -->
<div x-data="attributeSelector()" class="space-y-4">
    <form method="post" id="selectionForm">
        {% csrf_token %}
        <input type="hidden" name="category" value="{{ category.pk }}">
        <input type="hidden" name="phase" value="select">

        <!-- Quick Actions Bar -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4">
            <div class="flex flex-wrap gap-4 items-center justify-between">
                <div class="flex items-center gap-4">
                    <button type="button" @click="selectAllVisible()" class="px-3 py-2 text-sm bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 rounded-lg hover:bg-primary-200 dark:hover:bg-primary-900/50">
                        <i data-lucide="check-square" class="w-4 h-4 inline mr-1"></i>Select Visible
                    </button>
                    <button type="button" @click="clearSelection()" class="px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                        <i data-lucide="x-square" class="w-4 h-4 inline mr-1"></i>Clear
                    </button>
                    <button type="button" @click="resetFilters()" class="px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                        <i data-lucide="filter-x" class="w-4 h-4 inline mr-1"></i>Reset Filters
                    </button>
                </div>
                <div class="flex items-center gap-4 text-sm">
                    <span class="text-gray-500 dark:text-gray-400">
                        Showing <span class="font-medium" x-text="visibleCount"></span> of {{ attributes|length }}
                    </span>
                    <span class="font-medium text-primary-600 dark:text-primary-400">
                        <span x-text="selectedCount"></span> selected
                    </span>
                </div>
            </div>
        </div>

        <!-- Attributes Table with Sortable/Filterable Headers -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
            <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
                <table class="w-full text-sm" id="attributesTable">
                    <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                        <!-- Header Row with Sort -->
                        <tr class="border-b border-gray-200 dark:border-gray-600">
                            <th class="px-4 py-3 text-left w-12">
                                <input type="checkbox" @click="toggleAll($event)" x-ref="selectAllCheckbox"
                                       class="rounded border-gray-300 dark:border-gray-600 text-primary-600 focus:ring-primary-500">
                            </th>
                            <th class="px-4 py-2 text-left cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                                @click="sortBy('code')">
                                <div class="flex items-center gap-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                                    Code
                                    <span x-show="sortField === 'code'" class="text-primary-600">
                                        <i x-show="sortDir === 'asc'" data-lucide="chevron-up" class="w-4 h-4"></i>
                                        <i x-show="sortDir === 'desc'" data-lucide="chevron-down" class="w-4 h-4"></i>
                                    </span>
                                    <i x-show="sortField !== 'code'" data-lucide="chevrons-up-down" class="w-4 h-4 opacity-30"></i>
                                </div>
                            </th>
                            <th class="px-4 py-2 text-left cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                                @click="sortBy('name')">
                                <div class="flex items-center gap-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                                    Name
                                    <span x-show="sortField === 'name'" class="text-primary-600">
                                        <i x-show="sortDir === 'asc'" data-lucide="chevron-up" class="w-4 h-4"></i>
                                        <i x-show="sortDir === 'desc'" data-lucide="chevron-down" class="w-4 h-4"></i>
                                    </span>
                                    <i x-show="sortField !== 'name'" data-lucide="chevrons-up-down" class="w-4 h-4 opacity-30"></i>
                                </div>
                            </th>
                            <th class="px-4 py-2 text-left cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                                @click="sortBy('classification')">
                                <div class="flex items-center gap-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                                    Classification
                                    <span x-show="sortField === 'classification'" class="text-primary-600">
                                        <i x-show="sortDir === 'asc'" data-lucide="chevron-up" class="w-4 h-4"></i>
                                        <i x-show="sortDir === 'desc'" data-lucide="chevron-down" class="w-4 h-4"></i>
                                    </span>
                                    <i x-show="sortField !== 'classification'" data-lucide="chevrons-up-down" class="w-4 h-4 opacity-30"></i>
                                </div>
                            </th>
                            <th class="px-4 py-2 text-left cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                                @click="sortBy('type')">
                                <div class="flex items-center gap-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                                    Suggested Type
                                    <span x-show="sortField === 'type'" class="text-primary-600">
                                        <i x-show="sortDir === 'asc'" data-lucide="chevron-up" class="w-4 h-4"></i>
                                        <i x-show="sortDir === 'desc'" data-lucide="chevron-down" class="w-4 h-4"></i>
                                    </span>
                                    <i x-show="sortField !== 'type'" data-lucide="chevrons-up-down" class="w-4 h-4 opacity-30"></i>
                                </div>
                            </th>
                        </tr>
                        <!-- Filter Row -->
                        <tr class="bg-gray-100 dark:bg-gray-600/50">
                            <th class="px-4 py-2"></th>
                            <th class="px-4 py-2">
                                <input type="text" x-model="filters.code" @input="applyFilters()"
                                       placeholder="Filter..."
                                       class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-primary-500">
                            </th>
                            <th class="px-4 py-2">
                                <input type="text" x-model="filters.name" @input="applyFilters()"
                                       placeholder="Filter..."
                                       class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-primary-500">
                            </th>
                            <th class="px-4 py-2">
                                <select x-model="filters.classification" @change="applyFilters()"
                                        class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-primary-500">
                                    <option value="">All</option>
                                    {% for value, label in classifications %}
                                    <option value="{{ value }}">{{ value }}</option>
                                    {% endfor %}
                                </select>
                            </th>
                            <th class="px-4 py-2">
                                <select x-model="filters.type" @change="applyFilters()"
                                        class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-primary-500">
                                    <option value="">All</option>
                                    {% for value, label in attribute_types %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                        <template x-for="attr in sortedAttributes" :key="attr.id">
                            <tr x-show="attr.visible"
                                class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                                <td class="px-4 py-3">
                                    <input type="checkbox" name="selected_attributes" :value="attr.id"
                                           x-model="attr.selected" @change="updateCount()"
                                           class="attr-checkbox rounded border-gray-300 dark:border-gray-600 text-primary-600 focus:ring-primary-500">
                                </td>
                                <td class="px-4 py-3">
                                    <code class="px-2 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono" x-text="attr.code"></code>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="font-medium text-gray-900 dark:text-white" x-text="attr.name"></span>
                                    <span x-show="attr.existing" class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                        Linked
                                    </span>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200"
                                          x-text="attr.classification"></span>
                                </td>
                                <td class="px-4 py-3 text-gray-500 dark:text-gray-400" x-text="attr.typeDisplay"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- No results message -->
            <div x-show="visibleCount === 0" class="text-center py-8 text-gray-500 dark:text-gray-400">
                <i data-lucide="search-x" class="w-10 h-10 mx-auto mb-2 opacity-50"></i>
                <p>No attributes match your filters.</p>
                <button type="button" @click="resetFilters()" class="mt-2 text-primary-600 hover:text-primary-800 text-sm">
                    Reset Filters
                </button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end space-x-3 mt-6">
            <a href="{% url 'inventory:category_detail' category.pk %}" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900">
                Cancel
            </a>
            <button type="submit" :disabled="selectedCount === 0"
                    class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed">
                Configure Selected (<span x-text="selectedCount"></span>)
            </button>
        </div>
    </form>
</div>

<script>
function attributeSelector() {
    // Build set of existing attribute IDs (already linked to this category)
    const existingIds = new Set([{% for id in existing_attr_ids %}{{ id }}{% if not forloop.last %},{% endif %}{% endfor %}]);

    // Build attributes array from Django template
    const rawAttributes = [
        {% for attr in attributes %}
        {
            id: {{ attr.id }},
            code: "{{ attr.code|escapejs }}",
            name: "{{ attr.name|escapejs }}",
            classification: "{{ attr.classification }}",
            type: "{{ attr.data_type }}",
            typeDisplay: "{{ attr.get_data_type_display }}",
            visible: true,
            selected: existingIds.has({{ attr.id }}),  // Pre-check existing
            existing: existingIds.has({{ attr.id }})   // Flag for badge
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    return {
        attributes: rawAttributes,
        sortField: 'classification',
        sortDir: 'asc',
        filters: {
            code: '',
            name: '',
            classification: '',
            type: ''
        },
        selectedCount: rawAttributes.filter(a => a.selected).length,  // Count pre-selected
        visibleCount: rawAttributes.length,

        get sortedAttributes() {
            return [...this.attributes].sort((a, b) => {
                let aVal = a[this.sortField] || '';
                let bVal = b[this.sortField] || '';
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();

                if (aVal < bVal) return this.sortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return this.sortDir === 'asc' ? 1 : -1;
                return 0;
            });
        },

        sortBy(field) {
            if (this.sortField === field) {
                this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                this.sortField = field;
                this.sortDir = 'asc';
            }
            // Re-initialize Lucide icons after sort
            this.$nextTick(() => {
                if (typeof lucide !== 'undefined') lucide.createIcons();
            });
        },

        applyFilters() {
            let count = 0;
            this.attributes.forEach(attr => {
                const matchCode = !this.filters.code ||
                    attr.code.toLowerCase().includes(this.filters.code.toLowerCase());
                const matchName = !this.filters.name ||
                    attr.name.toLowerCase().includes(this.filters.name.toLowerCase());
                const matchClass = !this.filters.classification ||
                    attr.classification === this.filters.classification;
                const matchType = !this.filters.type ||
                    attr.type === this.filters.type;

                attr.visible = matchCode && matchName && matchClass && matchType;
                if (attr.visible) count++;
            });
            this.visibleCount = count;
        },

        resetFilters() {
            this.filters = { code: '', name: '', classification: '', type: '' };
            this.attributes.forEach(attr => attr.visible = true);
            this.visibleCount = this.attributes.length;
        },

        updateCount() {
            this.selectedCount = this.attributes.filter(a => a.selected).length;
        },

        selectAllVisible() {
            this.attributes.forEach(attr => {
                if (attr.visible) attr.selected = true;
            });
            this.updateCount();
        },

        clearSelection() {
            this.attributes.forEach(attr => attr.selected = false);
            this.updateCount();
        },

        toggleAll(event) {
            const checked = event.target.checked;
            this.attributes.forEach(attr => {
                if (attr.visible) attr.selected = checked;
            });
            this.updateCount();
        },

        init() {
            // Re-initialize Lucide icons
            this.$nextTick(() => {
                if (typeof lucide !== 'undefined') lucide.createIcons();
            });
        }
    }
}
</script>

{% else %}
<!-- ============================================== -->
<!-- PHASE 2: ATTRIBUTE CONFIGURATION               -->
<!-- ============================================== -->
<div x-data="attributeConfigurator()" class="space-y-4">
    <form method="post" id="configForm">
        {% csrf_token %}
        <input type="hidden" name="category" value="{{ category.pk }}">
        <input type="hidden" name="phase" value="configure">

        <!-- Info Card -->
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
            <div class="flex items-start gap-3">
                <i data-lucide="info" class="w-5 h-5 text-blue-600 dark:text-blue-400 mt-0.5"></i>
                <div class="text-sm text-blue-800 dark:text-blue-200">
                    <p class="font-medium mb-1">Configure {{ selected_attributes|length }} Attributes</p>
                    <p>Set the type, unit, validation rules, and display options for each attribute. Fields marked with * apply only to specific types.</p>
                </div>
            </div>
        </div>

        <!-- Configuration Table -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Attribute</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Type</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Unit</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Min</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Max</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Options</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Default</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Rules</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Req</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Name</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Order</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700" id="configTableBody">
                        {% for attr in selected_attributes %}
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 config-row"
                            data-attr-id="{{ attr.id }}"
                            x-data="rowConfig({{ attr.id }})" x-init="initRow()">
                            <input type="hidden" name="attribute_id" value="{{ attr.id }}">

                            <!-- Attribute Name -->
                            <td class="px-3 py-3">
                                <div class="flex items-center gap-2">
                                    <div>
                                        <div class="font-medium text-gray-900 dark:text-white">{{ attr.name }}</div>
                                        <code class="text-xs text-gray-500">{{ attr.code }}</code>
                                    </div>
                                    <span class="existing-badge hidden inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                        Edit
                                    </span>
                                </div>
                            </td>

                            <!-- Type -->
                            <td class="px-3 py-3">
                                <select name="type_{{ attr.id }}" x-model="attrType"
                                        class="type-select w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    {% for value, label in attribute_types %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </td>

                            <!-- Unit (for NUMBER) -->
                            <td class="px-3 py-3">
                                <select name="unit_{{ attr.id }}" :disabled="attrType !== 'NUMBER'"
                                        class="unit-select w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white disabled:opacity-50">
                                    <option value="">-</option>
                                    {% regroup units by get_unit_type_display as unit_groups %}
                                    {% for group in unit_groups %}
                                    <optgroup label="{{ group.grouper }}">
                                        {% for unit in group.list %}
                                        <option value="{{ unit.id }}">{{ unit.code }} - {{ unit.name }}</option>
                                        {% endfor %}
                                    </optgroup>
                                    {% endfor %}
                                </select>
                            </td>

                            <!-- Min Value -->
                            <td class="px-3 py-3">
                                <input type="number" name="min_{{ attr.id }}" step="any"
                                       :disabled="attrType !== 'NUMBER'"
                                       placeholder="-"
                                       class="min-input w-20 px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white disabled:opacity-50">
                            </td>

                            <!-- Max Value -->
                            <td class="px-3 py-3">
                                <input type="number" name="max_{{ attr.id }}" step="any"
                                       :disabled="attrType !== 'NUMBER'"
                                       placeholder="-"
                                       class="max-input w-20 px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white disabled:opacity-50">
                            </td>

                            <!-- Options (for TEXT and NUMBER) -->
                            <td class="px-3 py-3">
                                <input type="text" name="options_{{ attr.id }}"
                                       :disabled="attrType === 'BOOLEAN' || attrType === 'DATE'"
                                       placeholder="Option1, Option2, ..."
                                       class="options-input w-36 px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white disabled:opacity-50">
                            </td>

                            <!-- Default Value -->
                            <td class="px-3 py-3">
                                <input type="text" name="default_{{ attr.id }}"
                                       placeholder="-"
                                       class="default-input w-24 px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </td>

                            <!-- Conditional Rules -->
                            <td class="px-3 py-3 text-center">
                                <input type="hidden" name="rules_{{ attr.id }}" class="rules-input" value="">
                                <button type="button"
                                        onclick="openRuleBuilder({{ attr.id }}, '{{ attr.code|escapejs }}', '{{ attr.name|escapejs }}')"
                                        class="rules-btn px-2 py-1 text-xs rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400">
                                    <i data-lucide="git-branch" class="w-3 h-3 inline"></i>
                                    <span class="rules-count"></span>
                                </button>
                            </td>

                            <!-- Required -->
                            <td class="px-3 py-3 text-center">
                                <input type="checkbox" name="required_{{ attr.id }}"
                                       class="required-checkbox rounded border-gray-300 dark:border-gray-600 text-primary-600 focus:ring-primary-500">
                            </td>

                            <!-- Use in Name -->
                            <td class="px-3 py-3 text-center">
                                <input type="checkbox" name="in_name_{{ attr.id }}"
                                       class="inname-checkbox rounded border-gray-300 dark:border-gray-600 text-primary-600 focus:ring-primary-500">
                            </td>

                            <!-- Display Order -->
                            <td class="px-3 py-3 text-center">
                                <input type="number" name="order_{{ attr.id }}" value="{{ forloop.counter0 }}"
                                       class="order-input w-16 px-2 py-1.5 text-sm text-center border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Legend -->
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 mt-4 text-sm">
            <p class="font-medium text-gray-700 dark:text-gray-300 mb-2">Column Guide:</p>
            <ul class="grid grid-cols-2 md:grid-cols-3 gap-2 text-gray-600 dark:text-gray-400">
                <li><strong>Type:</strong> Text (with options=dropdown), Number (with options=common values), Yes/No, Date</li>
                <li><strong>Unit:</strong> For NUMBER type only (mm, kg, months, etc.)</li>
                <li><strong>Min/Max:</strong> For NUMBER type validation</li>
                <li><strong>Options:</strong> Comma-separated values for dropdown (TEXT) or common values (NUMBER)</li>
                <li><strong>Default:</strong> Pre-filled value when creating new items</li>
                <li><strong>Rules:</strong> Conditional formulas (e.g., IF shape=Machete THEN rotatability=0)</li>
                <li><strong>Req:</strong> Must have a value when creating items</li>
                <li><strong>Name:</strong> Include in auto-generated item name</li>
            </ul>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between mt-6">
            <a href="{% url 'inventory:category_attribute_bulk_create' %}?category={{ category.pk }}"
               class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900 inline-flex items-center">
                <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>Back to Selection
            </a>
            <div class="space-x-3">
                <a href="{% url 'inventory:category_detail' category.pk %}" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900">
                    Cancel
                </a>
                <button type="submit" class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                    Save Changes ({{ selected_attributes|length }} Attributes)
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Rule Builder Modal -->
<div id="ruleBuilderModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
        <!-- Modal Header -->
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Conditional Rules</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400">For: <span id="ruleAttrName" class="font-medium"></span></p>
            </div>
            <button type="button" onclick="closeRuleBuilder()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="p-6 overflow-y-auto max-h-[60vh]">
            <input type="hidden" id="ruleAttrId" value="">

            <!-- Lock Option -->
            <div class="mb-4 flex items-center gap-3">
                <input type="checkbox" id="ruleLocked" class="rounded border-gray-300 text-primary-600">
                <label for="ruleLocked" class="text-sm text-gray-700 dark:text-gray-300">
                    <strong>Lock value</strong> - User cannot change the calculated value
                </label>
            </div>

            <!-- Rules List -->
            <div id="rulesList" class="space-y-4">
                <!-- Rules will be dynamically added here -->
            </div>

            <!-- Add Rule Button -->
            <button type="button" onclick="addRule()" class="mt-4 px-4 py-2 text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">
                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>Add Rule
            </button>

            <!-- Help Text -->
            <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-sm">
                <p class="font-medium text-blue-800 dark:text-blue-200 mb-2">How Rules Work:</p>
                <ul class="text-blue-700 dark:text-blue-300 space-y-1">
                    <li>• Each rule has conditions (IF) and a result (THEN)</li>
                    <li>• Multiple conditions in a rule use AND logic</li>
                    <li>• First matching rule sets the value</li>
                    <li>• If locked, user sees message but cannot change value</li>
                </ul>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
            <button type="button" onclick="closeRuleBuilder()" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900">
                Cancel
            </button>
            <button type="button" onclick="saveRules()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                Save Rules
            </button>
        </div>
    </div>
</div>

<!-- Rule Template (hidden) -->
<template id="ruleTemplate">
    <div class="rule-item p-4 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700/50">
        <div class="flex items-center justify-between mb-3">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Rule <span class="rule-number"></span></span>
            <button type="button" onclick="removeRule(this)" class="text-red-500 hover:text-red-700 text-sm">
                <i data-lucide="trash-2" class="w-4 h-4 inline"></i>
            </button>
        </div>

        <!-- Conditions -->
        <div class="conditions-list space-y-2 mb-3">
            <!-- Conditions added dynamically -->
        </div>
        <button type="button" onclick="addCondition(this)" class="text-xs text-primary-600 hover:text-primary-800">
            <i data-lucide="plus" class="w-3 h-3 inline"></i> Add AND condition
        </button>

        <!-- Result -->
        <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600 flex items-center gap-2">
            <span class="text-sm text-gray-600 dark:text-gray-400">THEN set value to:</span>
            <input type="text" class="rule-result px-3 py-1.5 text-sm border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700 w-24" placeholder="value">
        </div>

        <!-- Lock Message -->
        <div class="mt-2 flex items-center gap-2">
            <span class="text-sm text-gray-600 dark:text-gray-400">Message:</span>
            <input type="text" class="rule-message flex-1 px-3 py-1.5 text-sm border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700" placeholder="Why this value is set (shown when locked)">
        </div>
    </div>
</template>

<!-- Condition Template (hidden) -->
<template id="conditionTemplate">
    <div class="condition-item flex items-center gap-2 flex-wrap">
        <span class="text-xs text-gray-500 condition-prefix hidden">AND</span>
        <span class="text-xs text-gray-500">IF</span>
        <select class="cond-attr px-2 py-1 text-xs border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700">
            <option value="">Select attribute...</option>
        </select>
        <select class="cond-op px-2 py-1 text-xs border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700">
            <option value="eq">equals</option>
            <option value="ne">not equals</option>
            <option value="in">is one of</option>
            <option value="nin">is not one of</option>
            <option value="contains">contains</option>
            <option value="gt">greater than</option>
            <option value="gte">greater or equal</option>
            <option value="lt">less than</option>
            <option value="lte">less or equal</option>
            <option value="empty">is empty</option>
            <option value="not_empty">is not empty</option>
        </select>
        <input type="text" class="cond-value px-2 py-1 text-xs border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700 w-32" placeholder="value(s)">
        <button type="button" onclick="removeCondition(this)" class="text-red-400 hover:text-red-600">
            <i data-lucide="x" class="w-3 h-3"></i>
        </button>
    </div>
</template>

<script>
// Available attributes for rule conditions (populated from selected attributes)
let availableAttributes = [
    {% for attr in selected_attributes %}
    { id: {{ attr.id }}, code: "{{ attr.code|escapejs }}", name: "{{ attr.name|escapejs }}" }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Current rules being edited
let currentRules = { rules: [], locked: false };
let currentAttrId = null;

function openRuleBuilder(attrId, attrCode, attrName) {
    currentAttrId = attrId;
    document.getElementById('ruleAttrName').textContent = `${attrName} (${attrCode})`;
    document.getElementById('ruleAttrId').value = attrId;

    // Load existing rules from hidden input
    const rulesInput = document.querySelector(`input[name="rules_${attrId}"]`);
    try {
        currentRules = rulesInput.value ? JSON.parse(rulesInput.value) : { rules: [], locked: false };
    } catch {
        currentRules = { rules: [], locked: false };
    }

    // Set locked checkbox
    document.getElementById('ruleLocked').checked = currentRules.locked || false;

    // Render existing rules
    renderRules();

    // Show modal
    document.getElementById('ruleBuilderModal').classList.remove('hidden');
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

function closeRuleBuilder() {
    document.getElementById('ruleBuilderModal').classList.add('hidden');
    currentAttrId = null;
    currentRules = { rules: [], locked: false };
}

function renderRules() {
    const container = document.getElementById('rulesList');
    container.innerHTML = '';

    if (currentRules.rules && currentRules.rules.length > 0) {
        currentRules.rules.forEach((rule, idx) => {
            addRuleElement(rule, idx + 1);
        });
    }
}

function addRule() {
    const idx = document.querySelectorAll('#rulesList .rule-item').length + 1;
    addRuleElement({ conditions: [{}], result: '', message: '' }, idx);
}

function addRuleElement(ruleData, index) {
    const template = document.getElementById('ruleTemplate');
    const clone = template.content.cloneNode(true);
    const ruleEl = clone.querySelector('.rule-item');

    ruleEl.querySelector('.rule-number').textContent = index;
    ruleEl.querySelector('.rule-result').value = ruleData.result || '';
    ruleEl.querySelector('.rule-message').value = ruleData.message || '';

    const condList = ruleEl.querySelector('.conditions-list');

    // Add conditions
    (ruleData.conditions || [{}]).forEach((cond, condIdx) => {
        addConditionElement(condList, cond, condIdx > 0);
    });

    document.getElementById('rulesList').appendChild(ruleEl);
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

function addCondition(btn) {
    const ruleItem = btn.closest('.rule-item');
    const condList = ruleItem.querySelector('.conditions-list');
    addConditionElement(condList, {}, true);
}

function addConditionElement(container, condData, showAnd) {
    const template = document.getElementById('conditionTemplate');
    const clone = template.content.cloneNode(true);
    const condEl = clone.querySelector('.condition-item');

    // Show AND prefix if not first condition
    if (showAnd) {
        condEl.querySelector('.condition-prefix').classList.remove('hidden');
    }

    // Populate attribute dropdown (exclude current attribute)
    const attrSelect = condEl.querySelector('.cond-attr');
    availableAttributes.forEach(attr => {
        if (attr.id !== currentAttrId) {
            const opt = document.createElement('option');
            opt.value = attr.code;
            opt.textContent = attr.name;
            if (condData.attr === attr.code) opt.selected = true;
            attrSelect.appendChild(opt);
        }
    });

    // Set operator and value
    if (condData.op) {
        condEl.querySelector('.cond-op').value = condData.op;
    }
    if (condData.value !== undefined) {
        const val = Array.isArray(condData.value) ? condData.value.join(', ') : condData.value;
        condEl.querySelector('.cond-value').value = val;
    }

    container.appendChild(condEl);
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

function removeRule(btn) {
    btn.closest('.rule-item').remove();
    // Renumber rules
    document.querySelectorAll('#rulesList .rule-item').forEach((el, idx) => {
        el.querySelector('.rule-number').textContent = idx + 1;
    });
}

function removeCondition(btn) {
    const condItem = btn.closest('.condition-item');
    const condList = condItem.closest('.conditions-list');
    condItem.remove();

    // Update AND prefix visibility
    const conditions = condList.querySelectorAll('.condition-item');
    conditions.forEach((c, idx) => {
        const prefix = c.querySelector('.condition-prefix');
        if (idx === 0) {
            prefix.classList.add('hidden');
        } else {
            prefix.classList.remove('hidden');
        }
    });
}

function saveRules() {
    const rules = [];

    document.querySelectorAll('#rulesList .rule-item').forEach(ruleEl => {
        const conditions = [];

        ruleEl.querySelectorAll('.conditions-list .condition-item').forEach(condEl => {
            const attr = condEl.querySelector('.cond-attr').value;
            const op = condEl.querySelector('.cond-op').value;
            let value = condEl.querySelector('.cond-value').value.trim();

            if (attr) {
                // Parse comma-separated values for 'in' and 'nin' operators
                if ((op === 'in' || op === 'nin') && value.includes(',')) {
                    value = value.split(',').map(v => v.trim());
                }
                conditions.push({ attr, op, value });
            }
        });

        const result = ruleEl.querySelector('.rule-result').value.trim();
        const message = ruleEl.querySelector('.rule-message').value.trim();

        if (conditions.length > 0 && result) {
            rules.push({ conditions, result, message });
        }
    });

    currentRules = {
        rules: rules,
        locked: document.getElementById('ruleLocked').checked
    };

    // Save to hidden input
    const rulesInput = document.querySelector(`input[name="rules_${currentAttrId}"]`);
    rulesInput.value = rules.length > 0 ? JSON.stringify(currentRules) : '';

    // Update button appearance
    updateRulesButton(currentAttrId, rules.length);

    closeRuleBuilder();
}

function updateRulesButton(attrId, ruleCount) {
    const row = document.querySelector(`tr[data-attr-id="${attrId}"]`);
    if (row) {
        const btn = row.querySelector('.rules-btn');
        const countSpan = btn.querySelector('.rules-count');
        if (ruleCount > 0) {
            btn.classList.add('bg-primary-100', 'dark:bg-primary-900/30', 'border-primary-300', 'text-primary-700');
            btn.classList.remove('border-gray-300', 'text-gray-600');
            countSpan.textContent = ruleCount;
        } else {
            btn.classList.remove('bg-primary-100', 'dark:bg-primary-900/30', 'border-primary-300', 'text-primary-700');
            btn.classList.add('border-gray-300', 'text-gray-600');
            countSpan.textContent = '';
        }
    }
}
</script>

<script>
// Global existing configs - accessible to row components
const existingConfigs = {
    {% for attr_id, cat_attr in existing_cat_attrs.items %}
    {{ attr_id }}: {
        type: "{{ cat_attr.attribute_type }}",
        unit: "{{ cat_attr.unit_id|default:'' }}",
        min: "{{ cat_attr.min_value|default:'' }}",
        max: "{{ cat_attr.max_value|default:'' }}",
        options: "{% if cat_attr.options %}{{ cat_attr.options|escapejs }}{% endif %}",
        defaultValue: "{{ cat_attr.default_value|default:''|escapejs }}",
        rules: {% if cat_attr.conditional_rules %}{{ cat_attr.conditional_rules|safe }}{% else %}null{% endif %},
        required: {{ cat_attr.is_required|yesno:"true,false" }},
        inName: {{ cat_attr.is_used_in_name|yesno:"true,false" }},
        order: {{ cat_attr.display_order|default:0 }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};

// Row-level Alpine component
function rowConfig(attrId) {
    const config = existingConfigs[attrId];
    return {
        attrType: config ? config.type : 'TEXT',
        isExisting: !!config,

        initRow() {
            if (!config) return;

            const row = this.$el;

            // Mark as existing
            row.classList.add('bg-green-50', 'dark:bg-green-900/10');
            row.querySelector('.existing-badge')?.classList.remove('hidden');

            // Set unit
            const unitSelect = row.querySelector('.unit-select');
            if (unitSelect && config.unit) {
                unitSelect.value = config.unit;
            }

            // Set min/max
            const minInput = row.querySelector('.min-input');
            const maxInput = row.querySelector('.max-input');
            if (minInput && config.min) minInput.value = config.min;
            if (maxInput && config.max) maxInput.value = config.max;

            // Set options
            const optionsInput = row.querySelector('.options-input');
            if (optionsInput && config.options) {
                try {
                    const opts = JSON.parse(config.options);
                    if (Array.isArray(opts)) {
                        optionsInput.value = opts.map(o => typeof o === 'object' ? o.value : o).join(', ');
                    } else {
                        optionsInput.value = config.options;
                    }
                } catch {
                    optionsInput.value = config.options;
                }
            }

            // Set default value
            const defaultInput = row.querySelector('.default-input');
            if (defaultInput && config.defaultValue) {
                defaultInput.value = config.defaultValue;
            }

            // Set conditional rules
            if (config.rules) {
                const rulesInput = row.querySelector('.rules-input');
                if (rulesInput) {
                    rulesInput.value = JSON.stringify(config.rules);
                    const ruleCount = config.rules.rules ? config.rules.rules.length : 0;
                    updateRulesButton(attrId, ruleCount);
                }
            }

            // Set checkboxes
            const reqCheckbox = row.querySelector('.required-checkbox');
            const nameCheckbox = row.querySelector('.inname-checkbox');
            if (reqCheckbox) reqCheckbox.checked = config.required;
            if (nameCheckbox) nameCheckbox.checked = config.inName;

            // Set order
            const orderInput = row.querySelector('.order-input');
            if (orderInput) orderInput.value = config.order;
        }
    }
}

function attributeConfigurator() {
    return {
        init() {
            // Sort rows by display order after all rows initialize
            this.$nextTick(() => {
                this.sortRowsByOrder();
            });
        },

        sortRowsByOrder() {
            const tbody = document.getElementById('configTableBody');
            const rows = Array.from(tbody.querySelectorAll('.config-row'));

            rows.sort((a, b) => {
                const orderA = parseInt(a.querySelector('.order-input')?.value || 0);
                const orderB = parseInt(b.querySelector('.order-input')?.value || 0);
                return orderA - orderB;
            });

            rows.forEach(row => tbody.appendChild(row));
        }
    }
}
</script>
{% endif %}
{% endblock %}
