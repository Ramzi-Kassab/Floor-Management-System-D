{% extends "base.html" %}

{% block title %}{{ page_title }} - ARDT FMS{% endblock %}

{% block page_header %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{ page_title }}</h1>
        <p class="text-gray-600 dark:text-gray-400">
            {% if phase == 'select' %}
            Select attributes to add to this category
            {% else %}
            Configure how each attribute will be used in this category
            {% endif %}
        </p>
    </div>
    <a href="{% url 'inventory:category_detail' category.pk %}" class="inline-flex items-center px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800">
        <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>Back to Category
    </a>
</div>
{% endblock %}

{% block content %}
{% if phase == 'select' %}
<!-- ============================================== -->
<!-- PHASE 1: ATTRIBUTE SELECTION                   -->
<!-- ============================================== -->
<div x-data="attributeSelector()" class="space-y-4">
    <form method="post" id="selectionForm">
        {% csrf_token %}
        <input type="hidden" name="category" value="{{ category.pk }}">
        <input type="hidden" name="phase" value="select">

        <!-- Quick Actions Bar -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4">
            <div class="flex flex-wrap gap-4 items-center justify-between">
                <div class="flex items-center gap-4">
                    <button type="button" @click="selectAllVisible()" class="px-3 py-2 text-sm bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 rounded-lg hover:bg-primary-200 dark:hover:bg-primary-900/50">
                        <i data-lucide="check-square" class="w-4 h-4 inline mr-1"></i>Select Visible
                    </button>
                    <button type="button" @click="clearSelection()" class="px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                        <i data-lucide="x-square" class="w-4 h-4 inline mr-1"></i>Clear
                    </button>
                    <button type="button" @click="resetFilters()" class="px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                        <i data-lucide="filter-x" class="w-4 h-4 inline mr-1"></i>Reset Filters
                    </button>
                </div>
                <div class="flex items-center gap-4 text-sm">
                    <span class="text-gray-500 dark:text-gray-400">
                        Showing <span class="font-medium" x-text="visibleCount"></span> of {{ attributes|length }}
                    </span>
                    <span class="font-medium text-primary-600 dark:text-primary-400">
                        <span x-text="selectedCount"></span> selected
                    </span>
                </div>
            </div>
        </div>

        <!-- Attributes Table with Sortable/Filterable Headers -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
            <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
                <table class="w-full text-sm" id="attributesTable">
                    <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                        <!-- Header Row with Sort -->
                        <tr class="border-b border-gray-200 dark:border-gray-600">
                            <th class="px-4 py-3 text-left w-12">
                                <input type="checkbox" @click="toggleAll($event)" x-ref="selectAllCheckbox"
                                       class="rounded border-gray-300 dark:border-gray-600 text-primary-600 focus:ring-primary-500">
                            </th>
                            <th class="px-4 py-2 text-left cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                                @click="sortBy('code')">
                                <div class="flex items-center gap-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                                    Code
                                    <span x-show="sortField === 'code'" class="text-primary-600">
                                        <i x-show="sortDir === 'asc'" data-lucide="chevron-up" class="w-4 h-4"></i>
                                        <i x-show="sortDir === 'desc'" data-lucide="chevron-down" class="w-4 h-4"></i>
                                    </span>
                                    <i x-show="sortField !== 'code'" data-lucide="chevrons-up-down" class="w-4 h-4 opacity-30"></i>
                                </div>
                            </th>
                            <th class="px-4 py-2 text-left cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                                @click="sortBy('name')">
                                <div class="flex items-center gap-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                                    Name
                                    <span x-show="sortField === 'name'" class="text-primary-600">
                                        <i x-show="sortDir === 'asc'" data-lucide="chevron-up" class="w-4 h-4"></i>
                                        <i x-show="sortDir === 'desc'" data-lucide="chevron-down" class="w-4 h-4"></i>
                                    </span>
                                    <i x-show="sortField !== 'name'" data-lucide="chevrons-up-down" class="w-4 h-4 opacity-30"></i>
                                </div>
                            </th>
                            <th class="px-4 py-2 text-left cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                                @click="sortBy('classification')">
                                <div class="flex items-center gap-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                                    Classification
                                    <span x-show="sortField === 'classification'" class="text-primary-600">
                                        <i x-show="sortDir === 'asc'" data-lucide="chevron-up" class="w-4 h-4"></i>
                                        <i x-show="sortDir === 'desc'" data-lucide="chevron-down" class="w-4 h-4"></i>
                                    </span>
                                    <i x-show="sortField !== 'classification'" data-lucide="chevrons-up-down" class="w-4 h-4 opacity-30"></i>
                                </div>
                            </th>
                            <th class="px-4 py-2 text-left cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                                @click="sortBy('type')">
                                <div class="flex items-center gap-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                                    Suggested Type
                                    <span x-show="sortField === 'type'" class="text-primary-600">
                                        <i x-show="sortDir === 'asc'" data-lucide="chevron-up" class="w-4 h-4"></i>
                                        <i x-show="sortDir === 'desc'" data-lucide="chevron-down" class="w-4 h-4"></i>
                                    </span>
                                    <i x-show="sortField !== 'type'" data-lucide="chevrons-up-down" class="w-4 h-4 opacity-30"></i>
                                </div>
                            </th>
                        </tr>
                        <!-- Filter Row -->
                        <tr class="bg-gray-100 dark:bg-gray-600/50">
                            <th class="px-4 py-2"></th>
                            <th class="px-4 py-2">
                                <input type="text" x-model="filters.code" @input="applyFilters()"
                                       placeholder="Filter..."
                                       class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-primary-500">
                            </th>
                            <th class="px-4 py-2">
                                <input type="text" x-model="filters.name" @input="applyFilters()"
                                       placeholder="Filter..."
                                       class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-primary-500">
                            </th>
                            <th class="px-4 py-2">
                                <select x-model="filters.classification" @change="applyFilters()"
                                        class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-primary-500">
                                    <option value="">All</option>
                                    {% for value, label in classifications %}
                                    <option value="{{ value }}">{{ value }}</option>
                                    {% endfor %}
                                </select>
                            </th>
                            <th class="px-4 py-2">
                                <select x-model="filters.type" @change="applyFilters()"
                                        class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-500 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-primary-500">
                                    <option value="">All</option>
                                    {% for value, label in attribute_types %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                        <template x-for="attr in sortedAttributes" :key="attr.id">
                            <tr x-show="attr.visible"
                                class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                                <td class="px-4 py-3">
                                    <input type="checkbox" name="selected_attributes" :value="attr.id"
                                           x-model="attr.selected" @change="updateCount()"
                                           class="attr-checkbox rounded border-gray-300 dark:border-gray-600 text-primary-600 focus:ring-primary-500">
                                </td>
                                <td class="px-4 py-3">
                                    <code class="px-2 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono" x-text="attr.code"></code>
                                </td>
                                <td class="px-4 py-3 font-medium text-gray-900 dark:text-white" x-text="attr.name"></td>
                                <td class="px-4 py-3">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200"
                                          x-text="attr.classification"></span>
                                </td>
                                <td class="px-4 py-3 text-gray-500 dark:text-gray-400" x-text="attr.typeDisplay"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- No results message -->
            <div x-show="visibleCount === 0" class="text-center py-8 text-gray-500 dark:text-gray-400">
                <i data-lucide="search-x" class="w-10 h-10 mx-auto mb-2 opacity-50"></i>
                <p>No attributes match your filters.</p>
                <button type="button" @click="resetFilters()" class="mt-2 text-primary-600 hover:text-primary-800 text-sm">
                    Reset Filters
                </button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end space-x-3 mt-6">
            <a href="{% url 'inventory:category_detail' category.pk %}" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900">
                Cancel
            </a>
            <button type="submit" :disabled="selectedCount === 0"
                    class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed">
                Configure Selected (<span x-text="selectedCount"></span>)
            </button>
        </div>
    </form>
</div>

<script>
function attributeSelector() {
    // Build attributes array from Django template
    const rawAttributes = [
        {% for attr in attributes %}
        {
            id: {{ attr.id }},
            code: "{{ attr.code|escapejs }}",
            name: "{{ attr.name|escapejs }}",
            classification: "{{ attr.classification }}",
            type: "{{ attr.data_type }}",
            typeDisplay: "{{ attr.get_data_type_display }}",
            visible: true,
            selected: false
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    return {
        attributes: rawAttributes,
        sortField: 'classification',
        sortDir: 'asc',
        filters: {
            code: '',
            name: '',
            classification: '',
            type: ''
        },
        selectedCount: 0,
        visibleCount: rawAttributes.length,

        get sortedAttributes() {
            return [...this.attributes].sort((a, b) => {
                let aVal = a[this.sortField] || '';
                let bVal = b[this.sortField] || '';
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();

                if (aVal < bVal) return this.sortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return this.sortDir === 'asc' ? 1 : -1;
                return 0;
            });
        },

        sortBy(field) {
            if (this.sortField === field) {
                this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                this.sortField = field;
                this.sortDir = 'asc';
            }
            // Re-initialize Lucide icons after sort
            this.$nextTick(() => {
                if (typeof lucide !== 'undefined') lucide.createIcons();
            });
        },

        applyFilters() {
            let count = 0;
            this.attributes.forEach(attr => {
                const matchCode = !this.filters.code ||
                    attr.code.toLowerCase().includes(this.filters.code.toLowerCase());
                const matchName = !this.filters.name ||
                    attr.name.toLowerCase().includes(this.filters.name.toLowerCase());
                const matchClass = !this.filters.classification ||
                    attr.classification === this.filters.classification;
                const matchType = !this.filters.type ||
                    attr.type === this.filters.type;

                attr.visible = matchCode && matchName && matchClass && matchType;
                if (attr.visible) count++;
            });
            this.visibleCount = count;
        },

        resetFilters() {
            this.filters = { code: '', name: '', classification: '', type: '' };
            this.attributes.forEach(attr => attr.visible = true);
            this.visibleCount = this.attributes.length;
        },

        updateCount() {
            this.selectedCount = this.attributes.filter(a => a.selected).length;
        },

        selectAllVisible() {
            this.attributes.forEach(attr => {
                if (attr.visible) attr.selected = true;
            });
            this.updateCount();
        },

        clearSelection() {
            this.attributes.forEach(attr => attr.selected = false);
            this.updateCount();
        },

        toggleAll(event) {
            const checked = event.target.checked;
            this.attributes.forEach(attr => {
                if (attr.visible) attr.selected = checked;
            });
            this.updateCount();
        },

        init() {
            // Re-initialize Lucide icons
            this.$nextTick(() => {
                if (typeof lucide !== 'undefined') lucide.createIcons();
            });
        }
    }
}
</script>

{% else %}
<!-- ============================================== -->
<!-- PHASE 2: ATTRIBUTE CONFIGURATION               -->
<!-- ============================================== -->
<div x-data="attributeConfigurator()" class="space-y-4">
    <form method="post" id="configForm">
        {% csrf_token %}
        <input type="hidden" name="category" value="{{ category.pk }}">
        <input type="hidden" name="phase" value="configure">

        <!-- Info Card -->
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
            <div class="flex items-start gap-3">
                <i data-lucide="info" class="w-5 h-5 text-blue-600 dark:text-blue-400 mt-0.5"></i>
                <div class="text-sm text-blue-800 dark:text-blue-200">
                    <p class="font-medium mb-1">Configure {{ selected_attributes|length }} Attributes</p>
                    <p>Set the type, unit, validation rules, and display options for each attribute. Fields marked with * apply only to specific types.</p>
                </div>
            </div>
        </div>

        <!-- Configuration Table -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Attribute</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Type *</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Unit</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Min</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Max</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Options (for SELECT/TEXT)</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Req</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Name</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Order</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                        {% for attr in selected_attributes %}
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50" x-data="{ attrType: '{{ attr.data_type }}' }">
                            <input type="hidden" name="attribute_id" value="{{ attr.id }}">

                            <!-- Attribute Name -->
                            <td class="px-3 py-3">
                                <div class="font-medium text-gray-900 dark:text-white">{{ attr.name }}</div>
                                <code class="text-xs text-gray-500">{{ attr.code }}</code>
                            </td>

                            <!-- Type -->
                            <td class="px-3 py-3">
                                <select name="type_{{ attr.id }}" x-model="attrType"
                                        class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    {% for value, label in attribute_types %}
                                    <option value="{{ value }}" {% if attr.data_type == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </td>

                            <!-- Unit (for NUMBER) -->
                            <td class="px-3 py-3">
                                <select name="unit_{{ attr.id }}" :disabled="attrType !== 'NUMBER'"
                                        class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white disabled:opacity-50">
                                    <option value="">-</option>
                                    {% regroup units by get_unit_type_display as unit_groups %}
                                    {% for group in unit_groups %}
                                    <optgroup label="{{ group.grouper }}">
                                        {% for unit in group.list %}
                                        <option value="{{ unit.id }}">{{ unit.code }} - {{ unit.name }}</option>
                                        {% endfor %}
                                    </optgroup>
                                    {% endfor %}
                                </select>
                            </td>

                            <!-- Min Value -->
                            <td class="px-3 py-3">
                                <input type="number" name="min_{{ attr.id }}" step="any"
                                       :disabled="attrType !== 'NUMBER'"
                                       placeholder="-"
                                       class="w-20 px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white disabled:opacity-50">
                            </td>

                            <!-- Max Value -->
                            <td class="px-3 py-3">
                                <input type="number" name="max_{{ attr.id }}" step="any"
                                       :disabled="attrType !== 'NUMBER'"
                                       placeholder="-"
                                       class="w-20 px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white disabled:opacity-50">
                            </td>

                            <!-- Options (for SELECT/TEXT) -->
                            <td class="px-3 py-3">
                                <input type="text" name="options_{{ attr.id }}"
                                       :disabled="attrType === 'NUMBER' || attrType === 'BOOLEAN' || attrType === 'DATE'"
                                       placeholder="Option1, Option2, ..."
                                       class="w-40 px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white disabled:opacity-50">
                            </td>

                            <!-- Required -->
                            <td class="px-3 py-3 text-center">
                                <input type="checkbox" name="required_{{ attr.id }}"
                                       class="rounded border-gray-300 dark:border-gray-600 text-primary-600 focus:ring-primary-500">
                            </td>

                            <!-- Use in Name -->
                            <td class="px-3 py-3 text-center">
                                <input type="checkbox" name="in_name_{{ attr.id }}"
                                       class="rounded border-gray-300 dark:border-gray-600 text-primary-600 focus:ring-primary-500">
                            </td>

                            <!-- Display Order -->
                            <td class="px-3 py-3 text-center">
                                <input type="number" name="order_{{ attr.id }}" value="{{ forloop.counter0 }}"
                                       class="w-16 px-2 py-1.5 text-sm text-center border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Legend -->
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 mt-4 text-sm">
            <p class="font-medium text-gray-700 dark:text-gray-300 mb-2">Column Guide:</p>
            <ul class="grid grid-cols-2 md:grid-cols-3 gap-2 text-gray-600 dark:text-gray-400">
                <li><strong>Type:</strong> How the value is entered (text, number, dropdown, etc.)</li>
                <li><strong>Unit:</strong> For NUMBER type only (mm, kg, psi, etc.)</li>
                <li><strong>Min/Max:</strong> For NUMBER type validation</li>
                <li><strong>Options:</strong> For SELECT type (comma-separated values)</li>
                <li><strong>Req:</strong> Must have a value when creating items</li>
                <li><strong>Name:</strong> Include in auto-generated item name</li>
            </ul>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between mt-6">
            <a href="{% url 'inventory:category_attribute_bulk_create' %}?category={{ category.pk }}"
               class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900 inline-flex items-center">
                <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>Back to Selection
            </a>
            <div class="space-x-3">
                <a href="{% url 'inventory:category_detail' category.pk %}" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900">
                    Cancel
                </a>
                <button type="submit" class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                    Save {{ selected_attributes|length }} Attributes
                </button>
            </div>
        </div>
    </form>
</div>

<script>
function attributeConfigurator() {
    return {
        // Can add interactive features here if needed
    }
}
</script>
{% endif %}
{% endblock %}
