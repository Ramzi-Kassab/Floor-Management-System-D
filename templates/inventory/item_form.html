{% extends "base.html" %}

{% block title %}{{ page_title }} - ARDT FMS{% endblock %}

{% block page_header %}
<div class="flex items-center justify-between mb-4">
    <h1 class="text-xl font-bold text-gray-900 dark:text-white">{{ form_title }}</h1>
    <a href="{% url 'inventory:item_list' %}" class="inline-flex items-center px-3 py-1.5 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800">
        <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i>Back
    </a>
</div>
{% endblock %}

{% block content %}
<div x-data="itemForm()" x-init="init()">
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="name_manually_set" x-model="nameManuallySet">

        <!-- Main Grid: 3 columns on desktop -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">

            <!-- LEFT COLUMN: Category, Name, Attributes (8 cols) -->
            <div class="lg:col-span-8 space-y-4">

                <!-- Category & Name Section -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Category -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Category *</label>
                            <select name="category" id="id_category" x-model="selectedCategory" @change="onCategoryChange()"
                                class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Category</option>
                                {% for category in categories %}
                                <option value="{{ category.pk }}"
                                        data-item-type="{{ category.item_type }}"
                                        data-name-template="{{ category.name_template|escapejs }}"
                                        data-name-template-config='{{ category.name_template_config|default:""|escapejs }}'
                                        {% if form.category.value|stringformat:"s" == category.pk|stringformat:"s" %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                                {% for child in category.children.all %}
                                <option value="{{ child.pk }}"
                                        data-item-type="{{ child.item_type }}"
                                        data-name-template="{{ child.name_template|escapejs }}"
                                        data-name-template-config='{{ child.name_template_config|default:""|escapejs }}'
                                        {% if form.category.value|stringformat:"s" == child.pk|stringformat:"s" %}selected{% endif %}>
                                    &nbsp;&nbsp;└ {{ child.name }}
                                </option>
                                {% endfor %}
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Item Type (auto-set, read-only display) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Item Type</label>
                            <div class="px-3 py-2 text-sm bg-gray-100 dark:bg-gray-700 rounded-lg text-gray-600 dark:text-gray-300" x-text="itemTypeLabel || 'Auto-set from category'"></div>
                            <input type="hidden" name="item_type" x-model="itemType">
                        </div>

                        <!-- Name Field (Full Width, Primary) -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Name *
                                <span x-show="!nameManuallySet && nameTemplate" class="ml-1 text-xs text-green-600">(Auto)</span>
                                <button type="button" x-show="nameManuallySet" @click="nameManuallySet = false; generateName()"
                                    class="ml-1 text-xs text-blue-600 hover:text-blue-800">[Reset]</button>
                            </label>
                            <input type="text" name="name" id="id_name" x-model="itemName" required
                                @input="nameManuallySet = true"
                                :class="{'ring-2 ring-green-400': !nameManuallySet && nameTemplate}"
                                class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500"
                                placeholder="Auto-generated from attributes">
                            <p class="text-xs text-gray-500 mt-0.5" x-show="nameTemplate" x-cloak>
                                Template: <span x-text="nameTemplate" class="font-mono text-blue-600"></span>
                            </p>
                            {% if form.name.errors %}<p class="text-red-600 text-xs mt-0.5">{{ form.name.errors.0 }}</p>{% endif %}
                        </div>

                        <!-- Description -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
                            <textarea name="description" rows="2"
                                class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">{{ form.description.value|default:'' }}</textarea>
                        </div>
                    </div>
                </div>

                <!-- Category Attributes (Dynamic) -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4" x-show="attributes.length > 0" x-cloak>
                    <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">
                        Specifications
                        <span class="text-xs font-normal text-gray-500" x-text="'(' + attributes.length + ')'"></span>
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                        <template x-for="attr in attributes" :key="attr.id">
                            <div :class="{'bg-blue-50 dark:bg-blue-900/20 p-2 rounded': attr.is_used_in_name}">
                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                                    <span x-text="attr.name"></span>
                                    <span x-show="attr.is_required" class="text-red-500">*</span>
                                    <span x-show="attr.unit" class="text-gray-400" x-text="'(' + attr.unit + ')'"></span>
                                </label>

                                <!-- SELECT/DROPDOWN: Show when has options (regardless of type) -->
                                <template x-if="hasOptions(attr)">
                                    <select :name="'attr_' + attr.id" x-model="attributeValues[attr.code]"
                                        :required="attr.is_required"
                                        @change="onAttributeChange(attr)"
                                        class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">-</option>
                                        <template x-for="opt in getOptions(attr)" :key="opt.value">
                                            <option :value="opt.value" x-text="opt.label"></option>
                                        </template>
                                    </select>
                                </template>

                                <!-- TEXT: No options -->
                                <template x-if="!hasOptions(attr) && attr.attribute_type === 'TEXT'">
                                    <input type="text" :name="'attr_' + attr.id" x-model="attributeValues[attr.code]"
                                        :required="attr.is_required"
                                        @input="onAttributeChange(attr)"
                                        class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </template>

                                <!-- NUMBER: No options, with min/max validation -->
                                <template x-if="!hasOptions(attr) && attr.attribute_type === 'NUMBER'">
                                    <div>
                                        <input type="number" :name="'attr_' + attr.id" x-model="attributeValues[attr.code]"
                                            :required="attr.is_required" :min="attr.min_value" :max="attr.max_value" step="any"
                                            @input="onAttributeChange(attr); validateNumber($event, attr)"
                                            class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <template x-if="attr.min_value || attr.max_value">
                                            <p class="text-xs text-gray-400 mt-0.5">
                                                <span x-show="attr.min_value" x-text="'Min: ' + attr.min_value"></span>
                                                <span x-show="attr.min_value && attr.max_value"> - </span>
                                                <span x-show="attr.max_value" x-text="'Max: ' + attr.max_value"></span>
                                            </p>
                                        </template>
                                    </div>
                                </template>

                                <!-- BOOLEAN -->
                                <template x-if="!hasOptions(attr) && attr.attribute_type === 'BOOLEAN'">
                                    <div class="flex items-center mt-1">
                                        <input type="checkbox" :name="'attr_' + attr.id" x-model="attributeValues[attr.code]"
                                            @change="onAttributeChange(attr)"
                                            class="rounded border-gray-300 text-blue-600">
                                        <span class="ml-1 text-xs text-gray-600 dark:text-gray-400">Yes</span>
                                    </div>
                                </template>

                                <!-- DATE -->
                                <template x-if="!hasOptions(attr) && attr.attribute_type === 'DATE'">
                                    <input type="date" :name="'attr_' + attr.id" x-model="attributeValues[attr.code]"
                                        :required="attr.is_required"
                                        @input="onAttributeChange(attr)"
                                        class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </template>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Cost & Stock Section (Merged for compactness) -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <!-- Cost -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Cost</label>
                            <div class="flex">
                                <input type="number" name="standard_cost" x-model="standardCost" step="0.01" min="0"
                                    @input="updateCostConversion()"
                                    class="flex-1 px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded-l bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <button type="button" @click="toggleCurrency()"
                                    :class="currency === 'SAR' ? 'bg-blue-600 text-white' : 'bg-green-600 text-white'"
                                    class="px-2 py-1.5 text-xs font-medium rounded-r" x-text="currency"></button>
                            </div>
                            <input type="hidden" name="currency" x-model="currency">
                            <p class="text-xs text-gray-500 mt-0.5" x-text="'≈ ' + (currency === 'SAR' ? '$' + convertedCost.toFixed(2) : 'SAR ' + convertedCost.toFixed(2))"></p>
                        </div>

                        <!-- Min Stock (replaces Reorder Point) -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Min Stock</label>
                            <input type="number" name="min_stock" x-model="minStock" min="0" :step="isEachUnit ? 1 : 0.001"
                                class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                value="{{ form.min_stock.value|default:'0' }}">
                            <p class="text-xs text-gray-500">Reorder when below</p>
                        </div>

                        <!-- Max Stock -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Max Stock</label>
                            <input type="number" name="max_stock" x-model="maxStock" min="0" :step="isEachUnit ? 1 : 0.001"
                                class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                value="{{ form.max_stock.value|default:'' }}">
                        </div>

                        <!-- Reorder Qty -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Reorder Qty
                                <button type="button" @click="calculateSmartReorder()" class="text-blue-600 text-xs ml-1">[Auto]</button>
                            </label>
                            <input type="number" name="reorder_quantity" x-model="reorderQty" min="0" :step="isEachUnit ? 1 : 0.001"
                                class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                value="{{ form.reorder_quantity.value|default:'0' }}">
                        </div>
                    </div>
                </div>

                <!-- Packaging Section (Simplified) -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
                    <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-2">
                        Packaging
                        <span class="text-xs font-normal text-gray-500">(if bought in bulk)</span>
                    </h3>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Buy As</label>
                            <select name="purchase_uom" x-model="purchaseUom"
                                class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Same as release</option>
                                {% for uom in packaging_uoms %}
                                <option value="{{ uom.pk }}" {% if form.purchase_uom.value|stringformat:"s" == uom.pk|stringformat:"s" %}selected{% endif %}>
                                    {{ uom.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Issue As</label>
                            <select name="release_uom" x-model="releaseUom"
                                class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Select unit</option>
                                {% for uom in packaging_uoms %}
                                <option value="{{ uom.pk }}" {% if form.release_uom.value|stringformat:"s" == uom.pk|stringformat:"s" %}selected{% endif %}>
                                    {{ uom.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Qty per Package</label>
                            <input type="number" name="purchase_to_release_factor" x-model="conversionFactor" min="1" step="1"
                                class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                placeholder="e.g., 100">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1" x-show="purchaseUom && conversionFactor > 1" x-cloak>
                        1 package = <span x-text="conversionFactor"></span> units
                    </p>
                </div>

                <!-- Legacy References (Auto-synced from attributes) -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
                    <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-2">
                        Legacy System References
                        <span x-show="sapMatNumber || erpItemNumber" class="text-xs text-green-600 font-normal ml-1">(Auto-synced)</span>
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                                SAP MAT Number
                                <span x-show="sapMatNumber" class="text-green-600 text-xs ml-1">✓</span>
                            </label>
                            <input type="text" name="mat_number" x-model="sapMatNumber" readonly
                                :class="{'bg-green-50 dark:bg-green-900/20 border-green-300': sapMatNumber}"
                                class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-300"
                                placeholder="From HDBS Code attribute">
                            <p class="text-xs text-gray-500 mt-0.5">Halliburton items only</p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                                ERP Item Number
                                <span x-show="erpItemNumber" class="text-green-600 text-xs ml-1">✓</span>
                            </label>
                            <input type="text" name="item_number" x-model="erpItemNumber" readonly
                                :class="{'bg-green-50 dark:bg-green-900/20 border-green-300': erpItemNumber}"
                                class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-300"
                                placeholder="From Item Number attribute">
                        </div>
                    </div>
                </div>

            </div>

            <!-- RIGHT COLUMN: Image, Tracking, Actions (4 cols) -->
            <div class="lg:col-span-4 space-y-4">

                <!-- Image (Smaller) -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
                    <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-2">Image</h3>
                    <div class="relative aspect-[4/3] max-h-32 mx-auto">
                        <div class="w-full h-full bg-gray-100 dark:bg-gray-700 rounded border-2 border-dashed border-gray-300 dark:border-gray-600 flex items-center justify-center cursor-pointer"
                             x-show="!imagePreview && !hasExistingImage"
                             @click="$refs.imageInput.click()">
                            <div class="text-center p-2">
                                <i data-lucide="image-plus" class="w-8 h-8 mx-auto text-gray-400"></i>
                                <p class="text-xs text-gray-500 mt-1">Click to upload</p>
                            </div>
                        </div>
                        <div x-show="imagePreview" x-cloak class="w-full h-full rounded overflow-hidden relative">
                            <img :src="imagePreview" class="w-full h-full object-contain">
                            <button type="button" @click="clearImage()"
                                class="absolute top-1 right-1 p-1 bg-red-500 text-white rounded-full hover:bg-red-600">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                        {% if object.image %}
                        <div x-show="hasExistingImage && !imagePreview" class="w-full h-full rounded overflow-hidden relative">
                            <img src="{{ object.image.url }}" class="w-full h-full object-contain">
                            <button type="button" @click="hasExistingImage = false"
                                class="absolute top-1 right-1 p-1 bg-red-500 text-white rounded-full hover:bg-red-600">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    <input type="file" name="image" x-ref="imageInput" @change="previewImage($event)" accept="image/*" class="hidden">
                </div>

                <!-- Tracking Options -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
                    <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-2">Tracking</h3>
                    <div class="space-y-2">
                        <label class="flex items-center text-sm">
                            <input type="checkbox" name="is_active" {% if form.is_active.value %}checked{% endif %}
                                class="rounded border-gray-300 text-blue-600 mr-2">
                            Active
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" name="is_serialized" {% if form.is_serialized.value %}checked{% endif %}
                                class="rounded border-gray-300 text-blue-600 mr-2">
                            Serial Number Tracking
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" name="is_lot_controlled" {% if form.is_lot_controlled.value %}checked{% endif %}
                                class="rounded border-gray-300 text-blue-600 mr-2">
                            Lot/Batch Tracking
                        </label>
                    </div>
                </div>

                <!-- Similar Items (Only on Edit) -->
                {% if object %}
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
                    <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-2">
                        Related Items
                        <button type="button" @click="showRelatedModal = true" class="text-xs text-blue-600 ml-1">+ Add</button>
                    </h3>
                    {% if object.related_to.exists %}
                    <div class="space-y-1">
                        {% for rel in object.related_to.all %}
                        <div class="flex items-center justify-between text-xs p-1.5 bg-gray-50 dark:bg-gray-700 rounded">
                            <a href="{% url 'inventory:item_update' rel.to_item.pk %}" class="text-blue-600 hover:underline truncate">
                                {{ rel.to_item.name|truncatechars:25 }}
                            </a>
                            <span class="px-1 py-0.5 rounded text-xs
                                {% if rel.status == 'EQUAL' %}bg-green-100 text-green-800
                                {% elif rel.status == 'OBSOLETE' %}bg-red-100 text-red-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ rel.get_status_display }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-xs text-gray-500">No related items</p>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Save Button -->
                <div class="flex flex-col gap-2">
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                        {% if object %}Update{% else %}Create{% endif %} Item
                    </button>
                    <a href="{% url 'inventory:item_list' %}" class="w-full px-4 py-2 text-center text-gray-600 dark:text-gray-400 hover:text-gray-800 text-sm">
                        Cancel
                    </a>
                </div>

            </div>
        </div>

        <!-- Hidden fields for removed/auto-generated fields -->
        <input type="hidden" name="code" value="{{ form.code.value|default:'' }}">
        <input type="hidden" name="reorder_point" x-model="minStock">
        <input type="hidden" name="unit" value="{{ form.unit.value|default:'EA' }}">
        <input type="hidden" name="lead_time_days" value="{{ form.lead_time_days.value|default:'0' }}">
        <input type="hidden" name="floor_location" value="">
        <input type="hidden" name="issued_to_floor" value="0">
        <input type="hidden" name="estimated_consumption_per_day" value="">
        <input type="hidden" name="floor_reorder_point" value="">
    </form>
</div>

<script>
function itemForm() {
    // Clone data passed from server (if cloning an item)
    const cloneData = {{ clone_data|safe|default:"{}" }};

    return {
        selectedCategory: '{{ form.category.value|default:"" }}',
        itemType: '{{ form.item_type.value|default:"COMPONENT" }}',
        itemTypeLabel: '',
        itemName: '{{ form.name.value|default:""|escapejs }}',
        nameManuallySet: {{ form.instance.name_manually_set|yesno:"true,false,false" }},
        nameTemplate: '',
        nameTemplateConfig: null,
        attributes: [],
        attributeValues: {},
        existingAttributeValues: {{ existing_attribute_values|safe|default:"{}" }},

        // Cost
        standardCost: parseFloat('{{ form.standard_cost.value|default:"0" }}') || 0,
        currency: '{{ form.currency.value|default:"SAR" }}',
        convertedCost: 0,
        exchangeRate: 3.75,

        // Stock
        minStock: parseFloat('{{ form.min_stock.value|default:"0" }}') || 0,
        maxStock: parseFloat('{{ form.max_stock.value|default:"" }}') || '',
        reorderQty: parseFloat('{{ form.reorder_quantity.value|default:"0" }}') || 0,
        isEachUnit: true,

        // Packaging
        purchaseUom: '{{ form.purchase_uom.value|default:"" }}',
        releaseUom: '{{ form.release_uom.value|default:"" }}',
        conversionFactor: parseFloat('{{ form.purchase_to_release_factor.value|default:"1" }}') || 1,

        // Legacy References (auto-synced from attributes)
        sapMatNumber: '{{ form.mat_number.value|default:""|escapejs }}',
        erpItemNumber: '{{ form.item_number.value|default:""|escapejs }}',

        // Image
        imagePreview: null,
        hasExistingImage: {{ object.image|yesno:"true,false,false" }},

        // Modal
        showRelatedModal: false,

        init() {
            // Apply clone data if present
            if (cloneData && cloneData.category_id) {
                this.applyCloneData(cloneData);
            }

            if (this.selectedCategory) {
                this.loadAttributes();
                this.setItemTypeFromCategory();
            }
            this.updateCostConversion();
            this.syncLegacyReferences();
        },

        applyCloneData(data) {
            // Set category (will trigger attribute loading)
            if (data.category_id) {
                this.selectedCategory = String(data.category_id);
            }
            // Set basic fields
            if (data.name) {
                this.itemName = data.name;
                this.nameManuallySet = true; // Don't auto-generate for cloned items
            }
            if (data.item_type) {
                this.itemType = data.item_type;
            }

            // Cost fields
            if (data.standard_cost !== null && data.standard_cost !== undefined) {
                this.standardCost = parseFloat(data.standard_cost) || 0;
            }
            if (data.currency) {
                this.currency = data.currency;
            }

            // Stock fields
            if (data.min_stock !== null && data.min_stock !== undefined) {
                this.minStock = parseFloat(data.min_stock) || 0;
            }
            if (data.max_stock !== null && data.max_stock !== undefined) {
                this.maxStock = parseFloat(data.max_stock) || '';
            }
            if (data.reorder_quantity !== null && data.reorder_quantity !== undefined) {
                this.reorderQty = parseFloat(data.reorder_quantity) || 0;
            }

            // Packaging
            if (data.purchase_uom_id) {
                this.purchaseUom = String(data.purchase_uom_id);
            }
            if (data.release_uom_id) {
                this.releaseUom = String(data.release_uom_id);
            }
            if (data.purchase_to_release_factor) {
                this.conversionFactor = parseFloat(data.purchase_to_release_factor) || 1;
            }

            // Legacy refs
            if (data.mat_number) {
                this.sapMatNumber = data.mat_number;
            }
            if (data.item_number) {
                this.erpItemNumber = data.item_number;
            }

            // Pre-fill description textarea
            if (data.description) {
                const descField = document.querySelector('textarea[name="description"]');
                if (descField) descField.value = data.description;
            }

            // Set checkbox states
            this.$nextTick(() => {
                const checkboxes = {
                    'is_active': data.is_active,
                    'is_serialized': data.is_serialized,
                    'is_lot_controlled': data.is_lot_controlled
                };
                for (const [name, checked] of Object.entries(checkboxes)) {
                    const cb = document.querySelector(`input[name="${name}"]`);
                    if (cb) cb.checked = !!checked;
                }
            });
        },

        setItemTypeFromCategory() {
            const select = document.getElementById('id_category');
            const option = select.options[select.selectedIndex];
            if (option && option.value) {
                this.itemType = option.dataset.itemType || 'COMPONENT';
                this.nameTemplate = option.dataset.nameTemplate || '';
                try {
                    this.nameTemplateConfig = option.dataset.nameTemplateConfig ? JSON.parse(option.dataset.nameTemplateConfig) : null;
                } catch(e) {
                    this.nameTemplateConfig = null;
                }
                // Set human-readable label
                const typeLabels = {
                    'RAW_MATERIAL': 'Raw Material',
                    'COMPONENT': 'Component',
                    'CONSUMABLE': 'Consumable',
                    'TOOL': 'Tool',
                    'SPARE_PART': 'Spare Part',
                    'FINISHED_GOOD': 'Finished Good',
                    'STOCK_ITEM': 'Stock Item',
                    'NON_STOCK': 'Non-Stock Item',
                    'SERVICE': 'Service'
                };
                this.itemTypeLabel = typeLabels[this.itemType] || this.itemType;
            }
        },

        onCategoryChange() {
            this.setItemTypeFromCategory();
            if (this.selectedCategory) {
                this.loadAttributes();
                if (!this.nameManuallySet) {
                    this.$nextTick(() => this.generateName());
                }
            } else {
                this.attributes = [];
                this.attributeValues = {};
                this.nameTemplate = '';
            }
        },

        async loadAttributes() {
            if (!this.selectedCategory) return;
            try {
                const response = await fetch(`/inventory/api/category/${this.selectedCategory}/attributes/`);
                const data = await response.json();
                this.attributes = data.attributes || [];
                this.nameTemplate = data.name_template || '';
                this.nameTemplateConfig = data.name_template_config || null;

                this.attributeValues = {};
                this.attributes.forEach(attr => {
                    if (this.existingAttributeValues[attr.code] !== undefined) {
                        this.attributeValues[attr.code] = this.existingAttributeValues[attr.code];
                    } else {
                        this.attributeValues[attr.code] = attr.attribute_type === 'BOOLEAN' ? false : '';
                    }
                });

                // Sync legacy references from loaded attributes
                this.syncLegacyReferences();

                if (!this.nameManuallySet && (this.nameTemplate || this.nameTemplateConfig)) {
                    this.$nextTick(() => this.generateName());
                }
            } catch (error) {
                console.error('Error loading attributes:', error);
            }
        },

        generateName() {
            // First check if we have structured config
            if (this.nameTemplateConfig && this.nameTemplateConfig.parts) {
                const generated = this.evaluateStructuredTemplate(this.nameTemplateConfig);
                if (generated) this.itemName = generated;
                return;
            }

            if (!this.nameTemplate) return;

            // Simple template replacement
            let name = this.nameTemplate;
            this.attributes.forEach(attr => {
                const placeholder = '{' + attr.code + '}';
                let value = this.attributeValues[attr.code] || '';

                if (attr.attribute_type === 'NUMBER' && value && attr.unit) {
                    value = value + attr.unit;
                }
                if (attr.attribute_type === 'BOOLEAN') {
                    value = value ? 'Yes' : 'No';
                }

                name = name.replace(placeholder, value);
            });

            name = name.replace(/\{[^}]+\}/g, '').replace(/\s+/g, ' ').trim();
            if (name) this.itemName = name;
        },

        evaluateStructuredTemplate(config) {
            if (!config.parts) return '';

            // Get separator from config (default to space)
            const separator = config.separator === 'custom' ? (config.customSeparator || '') : (config.separator ?? ' ');

            const evaluatedParts = [];
            for (const part of config.parts) {
                const val = this.evaluatePart(part);
                // Skip empty values and N/A values
                if (val && val !== 'N/A' && val !== 'n/a' && val !== 'NA' && val.trim() !== '') {
                    evaluatedParts.push(val);
                }
            }

            // Join with separator, handling text parts intelligently
            let result = '';
            for (let i = 0; i < evaluatedParts.length; i++) {
                const val = evaluatedParts[i];
                if (i > 0) {
                    // Don't add separator if previous value ends with separator-like chars
                    // or current value starts with them
                    const prevVal = evaluatedParts[i - 1];
                    const skipSep = /[\s\-_,.]$/.test(prevVal) || /^[\s\-_,.]/.test(val);
                    if (!skipSep) {
                        result += separator;
                    }
                }
                result += val;
            }

            return result.replace(/\s+/g, ' ').trim();
        },

        evaluatePart(part) {
            if (part.type === 'text') {
                return part.value || '';
            }
            if (part.type === 'attr') {
                const attr = this.attributes.find(a => a.code === part.code);
                let val = this.attributeValues[part.code] || '';
                // Skip N/A values
                if (val === 'N/A' || val === 'n/a' || val === 'NA') {
                    return '';
                }
                if (attr && attr.attribute_type === 'NUMBER' && val && attr.unit) {
                    val = val + attr.unit;
                }
                return val;
            }
            if (part.type === 'conditional') {
                // Handle new structure with conditions array
                if (part.conditions && Array.isArray(part.conditions)) {
                    const conditionsMet = this.evaluateConditions(part.conditions);
                    if (conditionsMet) {
                        // Try each THEN option until one works (all attributes have values)
                        return this.evaluateFallbackOptions(part.then || []);
                    } else {
                        // Try each ELSE option until one works
                        return this.evaluateFallbackOptions(part.else || []);
                    }
                }
                // Legacy format: single if/then/else
                if (this.evaluateCondition(part.if)) {
                    return part.then ? this.evaluatePart(part.then) : '';
                } else {
                    return part.else ? this.evaluatePart(part.else) : '';
                }
            }
            return '';
        },

        // Evaluate multiple conditions with AND/OR logic
        evaluateConditions(conditions) {
            if (!conditions || conditions.length === 0) return false;

            let result = this.evaluateSingleCondition(conditions[0]);

            for (let i = 1; i < conditions.length; i++) {
                const cond = conditions[i];
                const condResult = this.evaluateSingleCondition(cond);

                if (cond.logic === 'OR') {
                    result = result || condResult;
                } else {
                    // Default to AND
                    result = result && condResult;
                }
            }

            return result;
        },

        evaluateSingleCondition(cond) {
            if (!cond || !cond.attr) return false;
            let val = this.attributeValues[cond.attr];
            // Treat N/A as empty
            if (val === 'N/A' || val === 'n/a' || val === 'NA') {
                val = '';
            }
            switch (cond.op) {
                case 'not_empty': return val !== '' && val !== null && val !== undefined;
                case 'empty': return val === '' || val === null || val === undefined;
                case 'eq': return val == cond.value;
                case 'ne': return val != cond.value;
                case 'contains': return val && String(val).toLowerCase().includes(String(cond.value).toLowerCase());
                case 'gt': return parseFloat(val) > parseFloat(cond.value);
                case 'gte': return parseFloat(val) >= parseFloat(cond.value);
                case 'lt': return parseFloat(val) < parseFloat(cond.value);
                case 'lte': return parseFloat(val) <= parseFloat(cond.value);
                case 'in': {
                    const options = String(cond.value).split(',').map(s => s.trim().toLowerCase());
                    return options.includes(String(val).toLowerCase());
                }
                default: return false;
            }
        },

        // Try each option until one works (all attributes have values)
        evaluateFallbackOptions(options) {
            if (!options || options.length === 0) return '';

            for (const opt of options) {
                const template = opt.template || '';
                // Check if all placeholders can be filled
                const placeholders = template.match(/\{([^}]+)\}/g) || [];
                let allFilled = true;
                let result = template;

                for (const ph of placeholders) {
                    const code = ph.slice(1, -1); // Remove { and }
                    let val = this.attributeValues[code] || '';
                    // Skip N/A values
                    if (val === 'N/A' || val === 'n/a' || val === 'NA') {
                        val = '';
                    }
                    if (!val) {
                        allFilled = false;
                        break;
                    }
                    const attr = this.attributes.find(a => a.code === code);
                    if (attr && attr.attribute_type === 'NUMBER' && val && attr.unit) {
                        val = val + attr.unit;
                    }
                    result = result.replace(ph, val);
                }

                if (allFilled) {
                    return result;
                }
            }

            return ''; // No option worked
        },

        evaluateCondition(cond) {
            return this.evaluateSingleCondition(cond);
        },

        getOptions(attr) {
            if (!attr.options) return [];

            let opts = attr.options;

            // If it's a string, try to parse it
            if (typeof opts === 'string') {
                opts = opts.trim();
                if (!opts) return [];

                // Try JSON parse first (handles ["a","b"] format)
                try {
                    opts = JSON.parse(opts);
                } catch(e) {
                    // Check if it looks like a Python-style array with single quotes: ['a','b']
                    if (opts.startsWith('[') && opts.endsWith(']')) {
                        // Remove brackets and split
                        opts = opts.slice(1, -1);
                        opts = opts.split(',').map(s => s.trim().replace(/^['"]|['"]$/g, ''));
                    } else {
                        // Comma-separated: a, b, c or a,b,c
                        opts = opts.split(',').map(s => s.trim());
                    }
                }
            }

            // Ensure it's an array
            if (!Array.isArray(opts)) {
                opts = [opts];
            }

            // Clean and normalize each option
            return opts
                .map(opt => {
                    if (typeof opt === 'string') {
                        // Remove any remaining quotes and trim
                        const cleaned = opt.replace(/^['"]|['"]$/g, '').trim();
                        return cleaned ? { value: cleaned, label: cleaned } : null;
                    } else if (opt && typeof opt === 'object') {
                        return opt;
                    }
                    return null;
                })
                .filter(opt => opt !== null);
        },

        hasOptions(attr) {
            const opts = this.getOptions(attr);
            return opts && opts.length > 0;
        },

        validateNumber(event, attr) {
            const input = event.target;
            const value = parseFloat(input.value);

            if (isNaN(value)) return;

            let error = '';
            if (attr.min_value !== null && value < parseFloat(attr.min_value)) {
                error = `Value must be at least ${attr.min_value}`;
                input.classList.add('border-red-500');
            } else if (attr.max_value !== null && value > parseFloat(attr.max_value)) {
                error = `Value must be at most ${attr.max_value}`;
                input.classList.add('border-red-500');
            } else {
                input.classList.remove('border-red-500');
            }

            // Update validation message
            const errorEl = input.parentElement.querySelector('.validation-error');
            if (error) {
                if (!errorEl) {
                    const msg = document.createElement('p');
                    msg.className = 'validation-error text-xs text-red-500 mt-0.5';
                    msg.textContent = error;
                    input.parentElement.appendChild(msg);
                } else {
                    errorEl.textContent = error;
                }
            } else if (errorEl) {
                errorEl.remove();
            }
        },

        toggleCurrency() {
            this.currency = this.currency === 'SAR' ? 'USD' : 'SAR';
            this.updateCostConversion();
        },

        updateCostConversion() {
            this.convertedCost = this.currency === 'SAR'
                ? this.standardCost / this.exchangeRate
                : this.standardCost * this.exchangeRate;
        },

        calculateSmartReorder() {
            if (this.maxStock && this.minStock) {
                this.reorderQty = Math.max(0, this.maxStock - this.minStock);
            } else if (this.conversionFactor > 1) {
                this.reorderQty = this.conversionFactor;
            }
        },

        previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.imagePreview = e.target.result;
                    this.hasExistingImage = false;
                };
                reader.readAsDataURL(file);
            }
        },

        clearImage() {
            this.imagePreview = null;
            this.$refs.imageInput.value = '';
        },

        // Auto-sync legacy references from attributes
        syncLegacyReferences() {
            // Map attribute codes to legacy fields
            // hdbs_code / HDBS_CODE -> SAP MAT Number (Halliburton items)
            // item_number / ITEM_NUMBER -> ERP Item Number
            const hdbsValue = this.attributeValues['hdbs_code'] || this.attributeValues['HDBS_CODE'] ||
                              this.attributeValues['hdbs'] || this.attributeValues['HDBS'] || '';
            const itemNumValue = this.attributeValues['item_number'] || this.attributeValues['ITEM_NUMBER'] ||
                                 this.attributeValues['item_num'] || this.attributeValues['ITEM_NUM'] || '';

            if (hdbsValue) {
                this.sapMatNumber = hdbsValue;
            }
            if (itemNumValue) {
                this.erpItemNumber = itemNumValue;
            }
        },

        // Called when any attribute value changes
        onAttributeChange(attr) {
            // Update name if this attribute is used in name
            if (attr.is_used_in_name && !this.nameManuallySet) {
                this.generateName();
            }
            // Sync legacy references
            this.syncLegacyReferences();
        }
    }
}
</script>
{% endblock %}
