{% extends "base.html" %}

{% block title %}{{ page_title }} - ARDT FMS{% endblock %}

{% block page_header %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{ form_title }}</h1>
        <p class="text-gray-600 dark:text-gray-400">Configure category settings, code generation, and name templates</p>
    </div>
    <a href="{% url 'inventory:category_list' %}" class="inline-flex items-center px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800">
        <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>Back
    </a>
</div>
{% endblock %}

{% block content %}
<div x-data="categoryForm()" class="max-w-2xl">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
        <form method="post" @submit="handleSubmit($event)">
            {% csrf_token %}
            <!-- Hidden field for sync options -->
            <input type="hidden" name="sync_to_children" x-model="syncToChildren">

            <div class="space-y-6">
                <!-- Basic Information -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Basic Information</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Code *</label>
                            {{ form.code }}
                            {% if form.code.errors %}<p class="text-red-600 text-sm mt-1">{{ form.code.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Name *</label>
                            {{ form.name }}
                            {% if form.name.errors %}<p class="text-red-600 text-sm mt-1">{{ form.name.errors.0 }}</p>{% endif %}
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Parent Category</label>
                        {{ form.parent }}
                        <p class="text-xs text-gray-500 mt-1">Optional - for hierarchical categories</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Default Item Type *</label>
                        <div @change="trackChange('item_type')">{{ form.item_type }}</div>
                        <p class="text-xs text-gray-500 mt-1">Auto-selected when creating items in this category</p>
                    </div>
                </div>

                <!-- Code Generation -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Code Generation</h3>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Code Prefix</label>
                        {{ form.code_prefix }}
                        <p class="text-xs text-gray-500 mt-1">{{ form.code_prefix.help_text }}</p>
                        {% if parent_category %}
                        <div class="mt-2 p-2 bg-blue-50 dark:bg-blue-900/30 rounded text-xs text-blue-700 dark:text-blue-300">
                            <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                            Parent prefix: <span class="font-mono">{{ parent_category.code_prefix|default:parent_category.code }}</span>
                            — Consider extending it (e.g., {{ parent_category.code_prefix|default:parent_category.code|slice:":3" }}3, {{ parent_category.code_prefix|default:parent_category.code|slice:":3" }}4)
                        </div>
                        {% endif %}
                        {% if form.code_prefix.errors %}<p class="text-red-600 text-sm mt-1">{{ form.code_prefix.errors.0 }}</p>{% endif %}
                    </div>
                </div>

                <!-- Name Template -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-6" x-data="nameTemplateBuilder()">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Auto-Generated Name</h3>

                    <!-- Hidden field for the actual template string -->
                    <input type="hidden" name="name_template" x-model="templateString">
                    <input type="hidden" name="name_template_config" x-model="templateConfigJson">

                    <!-- Template Preview -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Name Template Preview</label>
                        <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-[40px] flex flex-wrap items-center gap-1" id="templatePreview">
                            <template x-if="templateParts.length === 0">
                                <span class="text-gray-400 text-sm italic">Click attributes below to build the template...</span>
                            </template>
                            <template x-for="(part, idx) in templateParts" :key="idx">
                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-sm"
                                      :class="{
                                          'bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-200': part.type === 'attr',
                                          'bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300': part.type === 'text',
                                          'bg-purple-100 dark:bg-purple-900/50 text-purple-800 dark:text-purple-200': part.type === 'conditional'
                                      }">
                                    <span x-text="getPartDisplay(part)"></span>
                                    <button type="button" @click="removePart(idx)" class="hover:text-red-500">
                                        <i data-lucide="x" class="w-3 h-3"></i>
                                    </button>
                                </span>
                            </template>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Result: <code class="bg-gray-200 dark:bg-gray-600 px-1 rounded" x-text="templateString || '(empty)'"></code></p>
                    </div>

                    <!-- Available Attributes -->
                    {% if own_attributes %}
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Available Attributes (click to add)</label>
                        <div class="flex flex-wrap gap-2">
                            {% for attr in own_attributes %}
                            <button type="button"
                                    @click="addAttr('{{ attr.attribute.code }}', '{{ attr.attribute.name }}')"
                                    class="px-3 py-1.5 text-xs bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg border border-blue-200 dark:border-blue-800 hover:bg-blue-100 dark:hover:bg-blue-900/50 transition">
                                <span class="font-medium">{{ attr.attribute.name }}</span>
                                <code class="ml-1 text-blue-500">{{ attr.attribute.code }}</code>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="mb-4 p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg text-sm text-amber-700 dark:text-amber-300">
                        <i data-lucide="alert-triangle" class="w-4 h-4 inline mr-1"></i>
                        Add attributes to this category first to use them in the name template.
                    </div>
                    {% endif %}

                    <!-- Add Text / Conditional -->
                    <div class="flex gap-2 mb-4">
                        <button type="button" @click="showTextInput = !showTextInput"
                                class="px-3 py-1.5 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">
                            <i data-lucide="type" class="w-3 h-3 inline mr-1"></i>Add Text
                        </button>
                        <button type="button" @click="showCondModal = true"
                                class="px-3 py-1.5 text-xs bg-purple-50 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/50">
                            <i data-lucide="git-branch" class="w-3 h-3 inline mr-1"></i>Add Conditional
                        </button>
                        <button type="button" @click="clearTemplate()"
                                class="px-3 py-1.5 text-xs bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/50 ml-auto">
                            <i data-lucide="trash-2" class="w-3 h-3 inline mr-1"></i>Clear
                        </button>
                    </div>

                    <!-- Text Input (hidden by default) -->
                    <div x-show="showTextInput" x-cloak class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="flex gap-2">
                            <input type="text" x-model="newText" placeholder="Enter text (e.g., 'mm', ' - ', 'Cutter ')"
                                   class="flex-1 px-3 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800">
                            <button type="button" @click="addText()" class="px-3 py-1.5 bg-gray-600 text-white text-sm rounded">Add</button>
                            <button type="button" @click="showTextInput = false" class="px-3 py-1.5 text-gray-500 text-sm">Cancel</button>
                        </div>
                    </div>

                    <!-- Conditional Modal -->
                    <div x-show="showCondModal" x-cloak class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 max-w-md w-full mx-4">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Add Conditional Part</h4>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm text-gray-700 dark:text-gray-300 mb-1">IF attribute:</label>
                                    <select x-model="condAttr" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                                        <option value="">Select attribute...</option>
                                        {% for attr in own_attributes %}
                                        <option value="{{ attr.attribute.code }}">{{ attr.attribute.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-700 dark:text-gray-300 mb-1">Condition:</label>
                                    <select x-model="condOp" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                                        <option value="not_empty">is not empty</option>
                                        <option value="empty">is empty</option>
                                        <option value="eq">equals value:</option>
                                    </select>
                                    <input x-show="condOp === 'eq'" type="text" x-model="condValue" placeholder="value"
                                           class="mt-2 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-700 dark:text-gray-300 mb-1">THEN use:</label>
                                    <select x-model="condThen" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                                        <option value="">Same attribute</option>
                                        {% for attr in own_attributes %}
                                        <option value="{{ attr.attribute.code }}">{{ attr.attribute.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-700 dark:text-gray-300 mb-1">ELSE (optional):</label>
                                    <select x-model="condElse" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                                        <option value="">Nothing (skip)</option>
                                        {% for attr in own_attributes %}
                                        <option value="{{ attr.attribute.code }}">{{ attr.attribute.name }}</option>
                                        {% endfor %}
                                        <option value="_text_">Custom text...</option>
                                    </select>
                                    <input x-show="condElse === '_text_'" type="text" x-model="condElseText" placeholder="fallback text"
                                           class="mt-2 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                                </div>
                            </div>

                            <div class="flex justify-end gap-3 mt-6">
                                <button type="button" @click="showCondModal = false" class="px-4 py-2 text-gray-600">Cancel</button>
                                <button type="button" @click="addConditional()" class="px-4 py-2 bg-purple-600 text-white rounded-lg">Add</button>
                            </div>
                        </div>
                    </div>

                    {% if parent_category and parent_category.name_template %}
                    <div class="mt-2 p-2 bg-blue-50 dark:bg-blue-900/30 rounded text-xs text-blue-700 dark:text-blue-300">
                        <i data-lucide="git-merge" class="w-3 h-3 inline mr-1"></i>
                        Inherited from parent: <code class="bg-blue-100 dark:bg-blue-800 px-1 rounded">{{ parent_category.name_template }}</code>
                    </div>
                    {% endif %}
                </div>

                <!-- Description -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</label>
                    {{ form.description }}
                </div>

                <!-- Status -->
                <div class="flex items-center" @change="trackChange('is_active')">
                    {{ form.is_active }}
                    <label class="ml-2 text-sm text-gray-700 dark:text-gray-300">Active</label>
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                <a href="{% url 'inventory:category_list' %}" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900">Cancel</a>
                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    {% if object %}Update{% else %}Create{% endif %} Category
                </button>
            </div>
        </form>
    </div>

    {% if object %}
    <!-- Child Categories Section -->
    {% if child_categories %}
    <div class="mt-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                <i data-lucide="git-branch" class="w-5 h-5 inline mr-2 text-gray-400"></i>
                Child Categories ({{ child_categories|length }})
            </h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="text-left text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700">
                        <th class="pb-2 font-medium">Code</th>
                        <th class="pb-2 font-medium">Name</th>
                        <th class="pb-2 font-medium">Prefix</th>
                        <th class="pb-2 font-medium">Items</th>
                        <th class="pb-2 font-medium text-center">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                    {% for child in child_categories %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30">
                        <td class="py-2 font-mono text-xs">
                            <a href="{% url 'inventory:category_update' child.pk %}" class="text-blue-600 hover:text-blue-800">{{ child.code }}</a>
                        </td>
                        <td class="py-2">{{ child.name }}</td>
                        <td class="py-2 font-mono text-xs">{{ child.code_prefix|default:"-" }}</td>
                        <td class="py-2">{{ child.items.count }}</td>
                        <td class="py-2 text-center">
                            {% if child.is_active %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Active</span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-400">Inactive</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Inherited Attributes Section (if has parent) -->
    {% if inherited_attributes %}
    <div class="mt-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                <i data-lucide="git-merge" class="w-5 h-5 inline mr-2 text-purple-500"></i>
                Inherited Attributes from Parent
            </h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="text-left text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700">
                        <th class="pb-2 font-medium">Code</th>
                        <th class="pb-2 font-medium">Name</th>
                        <th class="pb-2 font-medium">Type</th>
                        <th class="pb-2 font-medium">From</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                    {% for attr in inherited_attributes %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30 bg-purple-50/30 dark:bg-purple-900/10">
                        <td class="py-2 font-mono text-xs">{{ attr.code }}</td>
                        <td class="py-2">{{ attr.name }}</td>
                        <td class="py-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                                {% if attr.attribute_type == 'NUMBER' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                                {% elif attr.attribute_type == 'SELECT' %}bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200
                                {% elif attr.attribute_type == 'BOOLEAN' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                                {% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300{% endif %}">
                                {{ attr.get_attribute_type_display }}
                            </span>
                        </td>
                        <td class="py-2 text-gray-500">{{ attr.category.code }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-3">
            <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
            Inherited attributes are defined on the parent category. Items in this category will have access to these attributes.
        </p>
    </div>
    {% endif %}

    <!-- Category's Own Attributes Section -->
    <div class="mt-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Category Attributes</h3>
            <div class="flex items-center gap-2">
                <a href="{% url 'inventory:category_attribute_bulk_create' %}?category={{ object.pk }}" class="inline-flex items-center px-3 py-1.5 bg-primary-600 text-white text-sm rounded-lg hover:bg-primary-700">
                    <i data-lucide="layers" class="w-4 h-4 mr-1"></i>Bulk Add
                </a>
                <a href="{% url 'inventory:category_attribute_create' %}?category={{ object.pk }}" class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 text-sm rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                    <i data-lucide="plus" class="w-4 h-4 mr-1"></i>Add Single
                </a>
            </div>
        </div>

        {% if own_attributes %}
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="text-left text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700">
                        <th class="pb-2 font-medium">Code</th>
                        <th class="pb-2 font-medium">Name</th>
                        <th class="pb-2 font-medium">Type</th>
                        <th class="pb-2 font-medium">Unit</th>
                        <th class="pb-2 font-medium text-center">Required</th>
                        <th class="pb-2 font-medium text-center">In Name</th>
                        <th class="pb-2 font-medium text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                    {% for attr in own_attributes %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30">
                        <td class="py-2 font-mono text-xs">{{ attr.code }}</td>
                        <td class="py-2">{{ attr.name }}</td>
                        <td class="py-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                                {% if attr.attribute_type == 'NUMBER' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                                {% elif attr.attribute_type == 'SELECT' %}bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200
                                {% elif attr.attribute_type == 'BOOLEAN' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                                {% elif attr.attribute_type == 'DATE' %}bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200
                                {% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300{% endif %}">
                                {{ attr.get_attribute_type_display }}
                            </span>
                        </td>
                        <td class="py-2 text-gray-500">{{ attr.unit|default:"-" }}</td>
                        <td class="py-2 text-center">
                            {% if attr.is_required %}
                            <i data-lucide="check" class="w-4 h-4 text-green-600 inline"></i>
                            {% else %}
                            <i data-lucide="minus" class="w-4 h-4 text-gray-400 inline"></i>
                            {% endif %}
                        </td>
                        <td class="py-2 text-center">
                            {% if attr.is_used_in_name %}
                            <i data-lucide="check" class="w-4 h-4 text-green-600 inline"></i>
                            {% else %}
                            <i data-lucide="minus" class="w-4 h-4 text-gray-400 inline"></i>
                            {% endif %}
                        </td>
                        <td class="py-2 text-right">
                            <a href="{% url 'inventory:category_attribute_update' attr.pk %}" class="text-blue-600 hover:text-blue-800 text-xs">Edit</a>
                            <a href="{% url 'inventory:category_attribute_delete' attr.pk %}" class="text-red-600 hover:text-red-800 text-xs ml-2">Delete</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            <i data-lucide="sliders" class="w-10 h-10 mx-auto mb-2 opacity-50"></i>
            <p>No attributes defined for this category.</p>
            <p class="text-sm">Add attributes to enable smart item naming and validation.</p>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Sync Confirmation Modal -->
    <div x-show="showSyncModal" x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         aria-labelledby="modal-title"
         role="dialog"
         aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="showSyncModal"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
                 @click="showSyncModal = false"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div x-show="showSyncModal"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 class="relative inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">

                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900 sm:mx-0 sm:h-10 sm:w-10">
                        <i data-lucide="git-branch" class="h-6 w-6 text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title">
                            Sync Changes to Child Categories?
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                You've modified inheritable fields. Do you want to apply these changes to all child categories?
                            </p>
                            <div class="mt-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-sm">
                                <p class="font-medium text-gray-700 dark:text-gray-300 mb-2">Changed fields:</p>
                                <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 space-y-1">
                                    <template x-for="field in changedFields" :key="field">
                                        <li x-text="fieldLabels[field]"></li>
                                    </template>
                                </ul>
                            </div>
                            {% if child_categories %}
                            <div class="mt-3 text-xs text-gray-500">
                                <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                                This will update {{ child_categories|length }} child categor{{ child_categories|length|pluralize:"y,ies" }}.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse gap-3">
                    <button type="button" @click="confirmSync(true)"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:w-auto sm:text-sm">
                        Yes, Sync All
                    </button>
                    <button type="button" @click="confirmSync(false)"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">
                        No, This Category Only
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Name Template Builder
function nameTemplateBuilder() {
    // Parse existing template from form
    const existingTemplate = '{{ object.name_template|default:""|escapejs }}';
    const existingConfig = {% if object.name_template_config %}{{ object.name_template_config|safe }}{% else %}null{% endif %};

    // Initialize parts from config or parse from string
    let initialParts = [];
    if (existingConfig && existingConfig.parts) {
        initialParts = existingConfig.parts;
    } else if (existingTemplate) {
        // Parse simple template string into parts
        const regex = /\{([^}]+)\}|([^{]+)/g;
        let match;
        while ((match = regex.exec(existingTemplate)) !== null) {
            if (match[1]) {
                initialParts.push({ type: 'attr', code: match[1] });
            } else if (match[2]) {
                initialParts.push({ type: 'text', value: match[2] });
            }
        }
    }

    return {
        templateParts: initialParts,
        showTextInput: false,
        showCondModal: false,
        newText: '',
        // Conditional form fields
        condAttr: '',
        condOp: 'not_empty',
        condValue: '',
        condThen: '',
        condElse: '',
        condElseText: '',

        get templateString() {
            return this.templateParts.map(part => {
                if (part.type === 'attr') {
                    return `{${part.code}}`;
                } else if (part.type === 'text') {
                    return part.value;
                } else if (part.type === 'conditional') {
                    // For simple string, just use the main attribute
                    return `{${part.if.attr}}`;
                }
                return '';
            }).join('');
        },

        get templateConfigJson() {
            if (this.templateParts.length === 0) return '';
            return JSON.stringify({ parts: this.templateParts });
        },

        getPartDisplay(part) {
            if (part.type === 'attr') {
                return `{${part.code}}`;
            } else if (part.type === 'text') {
                return `"${part.value}"`;
            } else if (part.type === 'conditional') {
                let display = `IF ${part.if.attr} ${part.if.op}`;
                if (part.if.value) display += ` "${part.if.value}"`;
                display += ` → {${part.then.code || part.if.attr}}`;
                if (part.else) {
                    display += ` ELSE ${part.else.type === 'text' ? `"${part.else.value}"` : `{${part.else.code}}`}`;
                }
                return display;
            }
            return '';
        },

        addAttr(code, name) {
            this.templateParts.push({ type: 'attr', code: code });
            this.refreshIcons();
        },

        addText() {
            if (this.newText) {
                this.templateParts.push({ type: 'text', value: this.newText });
                this.newText = '';
                this.showTextInput = false;
                this.refreshIcons();
            }
        },

        addConditional() {
            if (!this.condAttr) return;

            const cond = {
                type: 'conditional',
                if: {
                    attr: this.condAttr,
                    op: this.condOp
                },
                then: {
                    type: 'attr',
                    code: this.condThen || this.condAttr
                }
            };

            if (this.condOp === 'eq' && this.condValue) {
                cond.if.value = this.condValue;
            }

            if (this.condElse) {
                if (this.condElse === '_text_') {
                    cond.else = { type: 'text', value: this.condElseText };
                } else {
                    cond.else = { type: 'attr', code: this.condElse };
                }
            }

            this.templateParts.push(cond);

            // Reset form
            this.condAttr = '';
            this.condOp = 'not_empty';
            this.condValue = '';
            this.condThen = '';
            this.condElse = '';
            this.condElseText = '';
            this.showCondModal = false;
            this.refreshIcons();
        },

        removePart(idx) {
            this.templateParts.splice(idx, 1);
            this.refreshIcons();
        },

        clearTemplate() {
            this.templateParts = [];
            this.refreshIcons();
        },

        refreshIcons() {
            this.$nextTick(() => {
                if (typeof lucide !== 'undefined') lucide.createIcons();
            });
        }
    }
}

function categoryForm() {
    return {
        showSyncModal: false,
        changedFields: [],
        syncToChildren: '',
        pendingSubmit: null,
        hasChildren: {{ child_categories|length|default:0 }} > 0,
        fieldLabels: {
            'item_type': 'Default Item Type',
            'name_template': 'Name Template',
            'is_active': 'Active Status'
        },

        trackChange(field) {
            if (!this.changedFields.includes(field)) {
                this.changedFields.push(field);
            }
        },

        handleSubmit(event) {
            // Only show modal if there are children and inheritable fields were changed
            if (this.hasChildren && this.changedFields.length > 0) {
                event.preventDefault();
                this.pendingSubmit = event.target;
                this.showSyncModal = true;
            }
            // Otherwise let the form submit normally
        },

        confirmSync(shouldSync) {
            this.syncToChildren = shouldSync ? this.changedFields.join(',') : '';
            this.showSyncModal = false;
            if (this.pendingSubmit) {
                this.pendingSubmit.submit();
            }
        }
    }
}
</script>

<style>
[x-cloak] { display: none !important; }
</style>
{% endblock %}
