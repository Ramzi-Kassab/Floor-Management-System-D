{% extends "base.html" %}

{% block title %}{{ page_title }} - ARDT FMS{% endblock %}

{% block page_header %}
<div class="flex items-center gap-4 mb-6">
    {% if hdbs_type %}
    <a href="{% url 'technology:hdbs_type_detail' hdbs_type.pk %}" class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
        <i data-lucide="arrow-left" class="w-5 h-5"></i>
    </a>
    {% else %}
    <a href="{% url 'technology:hdbs_type_list' %}" class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
        <i data-lucide="arrow-left" class="w-5 h-5"></i>
    </a>
    {% endif %}
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{ page_title }}</h1>
        <p class="text-gray-600 dark:text-gray-400">SMI Type - Client-facing naming{% if hdbs_type %} for {{ hdbs_type.hdbs_name }}{% endif %}</p>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="max-w-3xl">
    <form method="post" class="space-y-6">
        {% csrf_token %}

        <!-- SMI Information -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white flex items-center gap-2">
                    <i data-lucide="tag" class="w-5 h-5 text-blue-500"></i>
                    SMI Type Information
                </h3>
            </div>
            <div class="px-6 py-4 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">HDBS Type <span class="text-red-500">*</span></label>
                        <div class="mt-1">{{ form.hdbs_type }}</div>
                        <p class="mt-1 text-xs text-gray-500">Internal HDBS type</p>
                        {% if form.hdbs_type.errors %}<p class="mt-1 text-sm text-red-600">{{ form.hdbs_type.errors.0 }}</p>{% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Size</label>
                        <div class="mt-1">{{ form.size }}</div>
                        <p class="mt-1 text-xs text-gray-500">Specific size (or leave blank for all)</p>
                        {% if form.size.errors %}<p class="mt-1 text-sm text-red-600">{{ form.size.errors.0 }}</p>{% endif %}
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">SMI Name <span class="text-red-500">*</span></label>
                    <div class="mt-1">{{ form.smi_name }}</div>
                    <p class="mt-1 text-xs text-gray-500">Client-facing name (e.g., FX55)</p>
                    {% if form.smi_name.errors %}<p class="mt-1 text-sm text-red-600">{{ form.smi_name.errors.0 }}</p>{% endif %}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                    <div class="mt-1">{{ form.description }}</div>
                    <p class="mt-1 text-xs text-gray-500">Optional notes about this SMI type</p>
                    {% if form.description.errors %}<p class="mt-1 text-sm text-red-600">{{ form.description.errors.0 }}</p>{% endif %}
                </div>
            </div>
        </div>

        <!-- Status -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white flex items-center gap-2">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    Status
                </h3>
            </div>
            <div class="px-6 py-4">
                <div class="flex items-center gap-3">
                    {{ form.is_active }}
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Active</label>
                </div>
                <p class="mt-1 text-xs text-gray-500 ml-6">Inactive SMI types won't appear in selection dropdowns</p>
            </div>
        </div>

        <!-- Info Box -->
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
            <div class="flex gap-3">
                <i data-lucide="info" class="w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0"></i>
                <div>
                    <p class="text-sm text-blue-800 dark:text-blue-200 font-medium">About SMI Types</p>
                    <p class="text-sm text-blue-600 dark:text-blue-300 mt-1">
                        <strong>SMI</strong> is the client-facing naming convention. Multiple SMI types can map to the same HDBS type (1-to-many relationship).
                    </p>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-end gap-3">
            {% if hdbs_type %}
            <a href="{% url 'technology:hdbs_type_detail' hdbs_type.pk %}" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600">Cancel</a>
            {% else %}
            <a href="{% url 'technology:hdbs_type_list' %}" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600">Cancel</a>
            {% endif %}
            <button type="submit" class="px-6 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 flex items-center gap-2">
                <i data-lucide="save" class="w-4 h-4"></i>
                {{ submit_text }}
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const hdbsSelect = document.getElementById('id_hdbs_type');
    const sizeSelect = document.getElementById('id_size');

    if (!hdbsSelect || !sizeSelect) return;

    // Store all original size options
    const allSizeOptions = Array.from(sizeSelect.options).map(opt => ({
        value: opt.value,
        text: opt.text
    }));

    function updateSizeOptions(hdbsId) {
        if (!hdbsId) {
            // No HDBS selected - show all sizes
            sizeSelect.innerHTML = '';
            allSizeOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.text = opt.text;
                sizeSelect.appendChild(option);
            });
            return;
        }

        // Fetch HDBS type details to get its sizes
        fetch(`{% url "technology:api_hdbs_types" %}?show_inactive=1`)
            .then(r => r.json())
            .then(data => {
                const hdbs = data.hdbs_types.find(h => h.id == hdbsId);
                if (!hdbs) return;

                const allowedSizeIds = hdbs.sizes.map(s => s.id.toString());

                // Update size dropdown
                const currentValue = sizeSelect.value;
                sizeSelect.innerHTML = '';

                // Add empty option
                const emptyOpt = document.createElement('option');
                emptyOpt.value = '';
                emptyOpt.text = '---------';
                sizeSelect.appendChild(emptyOpt);

                if (allowedSizeIds.length === 0) {
                    // HDBS has no sizes - show all sizes
                    allSizeOptions.forEach(opt => {
                        if (opt.value) {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.text = opt.text;
                            sizeSelect.appendChild(option);
                        }
                    });
                } else {
                    // Only show sizes that belong to this HDBS type
                    allSizeOptions.forEach(opt => {
                        if (opt.value && allowedSizeIds.includes(opt.value)) {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.text = opt.text;
                            sizeSelect.appendChild(option);
                        }
                    });
                }

                // Restore selection if still valid
                if (Array.from(sizeSelect.options).some(o => o.value === currentValue)) {
                    sizeSelect.value = currentValue;
                }
            });
    }

    // Listen for HDBS type changes
    hdbsSelect.addEventListener('change', function() {
        updateSizeOptions(this.value);
    });

    // Initial update if HDBS is pre-selected
    if (hdbsSelect.value) {
        updateSizeOptions(hdbsSelect.value);
    }
});
</script>
{% endblock %}
