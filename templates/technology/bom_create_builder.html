{% extends "base.html" %}

{% block title %}Create BOM - ARDT FMS{% endblock %}

{% block extra_css %}
<style>
    .filter-dropdown {
        position: fixed;
        z-index: 9999;
        min-width: 200px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        display: none;
    }
    .dark .filter-dropdown {
        background: #1f2937;
        border-color: #374151;
    }
    .filter-dropdown.active {
        display: block;
    }
    .th-filter {
        position: relative;
        cursor: pointer;
        user-select: none;
    }
    .th-filter:hover {
        background: rgba(59, 130, 246, 0.1);
    }
    .design-row {
        cursor: pointer;
        transition: background-color 0.15s;
    }
    .design-row:hover {
        background: rgba(59, 130, 246, 0.1);
    }
    .design-row.selected {
        background: rgba(147, 51, 234, 0.15) !important;
    }
    .dark .design-row.selected {
        background: rgba(147, 51, 234, 0.3) !important;
    }
</style>
{% endblock %}

{% block page_header %}
<div class="flex flex-col md:flex-row md:items-start md:justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Create BOM</h1>
        <p class="text-gray-600 dark:text-gray-400">Select a Design (L3/L4 MAT) to start creating a new BOM via Cutter Map</p>
    </div>
    <div class="mt-4 md:mt-0">
        <a href="{% url 'technology:bom_list' %}" class="inline-flex items-center px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800">
            <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>Back to BOMs
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Column: Design Selection -->
    <div class="lg:col-span-2">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                    <i data-lucide="layers" class="w-5 h-5 mr-2 text-purple-600"></i>
                    Select Design (L3/L4 MAT)
                </h2>
                <span class="text-xs text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">
                    {{ designs|length }} designs available
                </span>
            </div>

            <!-- Search Box -->
            <div class="mb-4">
                <input type="text" id="design-search" placeholder="Search by MAT, HDBS Type, or Size..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                    oninput="filterDesigns(this.value)">
            </div>

            <!-- Design Selection Table -->
            <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                <div class="max-h-[500px] overflow-y-auto">
                    <table class="w-full text-sm" id="design-table">
                        <thead class="bg-gray-50 dark:bg-gray-700/50 sticky top-0">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase w-12"></th>
                                <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Level</th>
                                <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase">MAT No.</th>
                                <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase">HDBS Type</th>
                                <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Size</th>
                                <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Status</th>
                                <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase">BOMs</th>
                            </tr>
                        </thead>
                        <tbody id="design-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                            {% for design in designs %}
                            <tr class="design-row hover:bg-gray-50 dark:hover:bg-gray-700/30"
                                data-design-id="{{ design.pk }}"
                                data-level="L{{ design.order_level }}"
                                data-mat="{{ design.mat_no|lower }}"
                                data-hdbs="{{ design.hdbs_type|lower }}"
                                data-size="{{ design.size.size_decimal|default:'' }}"
                                onclick="selectDesign(this)">
                                <td class="px-3 py-3">
                                    <div class="w-5 h-5 rounded-full border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center design-check">
                                    </div>
                                </td>
                                <td class="px-3 py-3">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                                        {% if design.order_level == '3' %}bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300
                                        {% else %}bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300{% endif %}">
                                        L{{ design.order_level }}
                                    </span>
                                </td>
                                <td class="px-3 py-3 font-mono font-medium text-gray-900 dark:text-white">{{ design.mat_no }}</td>
                                <td class="px-3 py-3 text-gray-700 dark:text-gray-300">{{ design.hdbs_type }}</td>
                                <td class="px-3 py-3 text-gray-700 dark:text-gray-300">{{ design.size.size_display|default:"-" }}</td>
                                <td class="px-3 py-3">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                                        {% if design.status == 'ACTIVE' %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                        {{ design.status }}
                                    </span>
                                </td>
                                <td class="px-3 py-3 text-gray-500">{{ design.boms.count }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="px-3 py-8 text-center text-gray-500">
                                    No designs found. <a href="{% url 'technology:design_create' %}?from=bom_create" class="text-purple-600 hover:underline">Create a new Design</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Results count -->
            <div class="mt-3 flex items-center justify-between text-sm text-gray-500">
                <span id="design-count">Showing {{ designs|length }} designs</span>
                <a href="{% url 'technology:design_create' %}?from=bom_create" class="text-purple-600 hover:text-purple-800 text-sm">
                    <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>Create New Design
                </a>
            </div>
        </div>
    </div>

    <!-- Right Column: Selected Design & Action -->
    <div class="space-y-6">
        <!-- Selected Design Card -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Selected Design</h3>

            <!-- No Selection State -->
            <div id="no-selection" class="text-center py-8">
                <div class="w-16 h-16 mx-auto rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center mb-4">
                    <i data-lucide="mouse-pointer-click" class="w-8 h-8 text-gray-400"></i>
                </div>
                <p class="text-gray-500 dark:text-gray-400">Click on a Design from the table to select it</p>
            </div>

            <!-- Selection Made State -->
            <div id="design-selected" class="hidden">
                <div class="space-y-3 mb-6">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">Level:</span>
                        <span id="selected-level" class="font-medium text-gray-900 dark:text-white">-</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">MAT No.:</span>
                        <span id="selected-mat" class="font-mono font-medium text-purple-600 dark:text-purple-400">-</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">HDBS Type:</span>
                        <span id="selected-hdbs" class="font-medium text-gray-900 dark:text-white">-</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">Size:</span>
                        <span id="selected-size" class="font-medium text-gray-900 dark:text-white">-</span>
                    </div>
                </div>

                <hr class="border-gray-200 dark:border-gray-700 mb-6">

                <!-- Action Button -->
                <button type="button" onclick="openCutterMap()"
                    class="w-full px-4 py-4 bg-purple-600 text-white rounded-xl hover:bg-purple-700 font-medium transition-all flex items-center justify-center gap-3 shadow-lg hover:shadow-xl">
                    <i data-lucide="file-scan" class="w-6 h-6"></i>
                    <span class="text-lg">Open Cutter Map</span>
                </button>

                <p class="text-xs text-center text-gray-500 mt-3">
                    Import PDF to extract BOM data for this design
                </p>

                <button type="button" onclick="clearSelection()"
                    class="w-full mt-4 px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 text-sm">
                    Clear Selection
                </button>
            </div>
        </div>

        <!-- Help Card -->
        <div class="bg-purple-50 dark:bg-purple-900/20 rounded-xl p-6 border border-purple-200 dark:border-purple-800">
            <h3 class="text-sm font-semibold text-purple-800 dark:text-purple-300 mb-3 flex items-center">
                <i data-lucide="info" class="w-4 h-4 mr-2"></i>
                How it works
            </h3>
            <ol class="text-xs text-purple-700 dark:text-purple-400 space-y-2 list-decimal list-inside">
                <li>Select a Design (L3/L4 MAT) from the table</li>
                <li>Click "Open Cutter Map" to upload a PDF</li>
                <li>Extract and edit BOM data from the PDF</li>
                <li>The L5 MAT code is extracted from the PDF</li>
                <li>Click "Create BOM" to save to the system</li>
            </ol>
        </div>

        <!-- Quick Links -->
        <div class="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-6">
            <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Quick Links</h3>
            <ul class="text-sm space-y-2">
                <li>
                    <a href="{% url 'technology:design_list' %}" class="text-blue-600 hover:text-blue-800 flex items-center">
                        <i data-lucide="layers" class="w-4 h-4 mr-2"></i>View All Designs
                    </a>
                </li>
                <li>
                    <a href="{% url 'technology:design_create' %}?from=bom_create" class="text-blue-600 hover:text-blue-800 flex items-center">
                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i>Create New Design
                    </a>
                </li>
                <li>
                    <a href="{% url 'cutter_map:index' %}" class="text-blue-600 hover:text-blue-800 flex items-center">
                        <i data-lucide="file-scan" class="w-4 h-4 mr-2"></i>Cutter Map (Direct)
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>

<script>
    // Store selected design info
    let selectedDesign = null;

    // Select a design from the table
    function selectDesign(row) {
        // Remove selection from all rows
        document.querySelectorAll('.design-row').forEach(r => {
            r.classList.remove('selected');
            r.querySelector('.design-check').innerHTML = '';
        });

        // Add selection to clicked row
        row.classList.add('selected');
        row.querySelector('.design-check').innerHTML = '<i data-lucide="check" class="w-4 h-4 text-purple-600"></i>';

        // Store design info
        selectedDesign = {
            id: row.dataset.designId,
            level: row.dataset.level.toUpperCase(),
            mat: row.querySelector('td:nth-child(3)').textContent.trim(),
            hdbs: row.querySelector('td:nth-child(4)').textContent.trim(),
            size: row.querySelector('td:nth-child(5)').textContent.trim()
        };

        // Update sidebar
        document.getElementById('no-selection').classList.add('hidden');
        document.getElementById('design-selected').classList.remove('hidden');
        document.getElementById('selected-level').textContent = selectedDesign.level;
        document.getElementById('selected-mat').textContent = selectedDesign.mat;
        document.getElementById('selected-hdbs').textContent = selectedDesign.hdbs;
        document.getElementById('selected-size').textContent = selectedDesign.size || '-';

        // Re-render lucide icons
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    // Clear selection
    function clearSelection() {
        document.querySelectorAll('.design-row').forEach(r => {
            r.classList.remove('selected');
            r.querySelector('.design-check').innerHTML = '';
        });

        selectedDesign = null;

        document.getElementById('no-selection').classList.remove('hidden');
        document.getElementById('design-selected').classList.add('hidden');
    }

    // Filter designs by search text
    function filterDesigns(searchText) {
        const search = searchText.toLowerCase().trim();
        const rows = document.querySelectorAll('.design-row');
        let visibleCount = 0;

        rows.forEach(row => {
            const mat = row.dataset.mat || '';
            const hdbs = row.dataset.hdbs || '';
            const size = row.dataset.size || '';
            const level = row.dataset.level || '';

            const matches = !search ||
                mat.includes(search) ||
                hdbs.includes(search) ||
                size.includes(search) ||
                level.includes(search);

            row.style.display = matches ? '' : 'none';
            if (matches) visibleCount++;
        });

        document.getElementById('design-count').textContent = `Showing ${visibleCount} designs`;
    }

    // Open Cutter Map with selected design
    function openCutterMap() {
        if (!selectedDesign) {
            alert('Please select a design first.');
            return;
        }

        // Build URL with design context
        const params = new URLSearchParams({
            design_id: selectedDesign.id,
            design_mat: selectedDesign.mat,
            design_hdbs: selectedDesign.hdbs,
            design_size: selectedDesign.size,
            design_level: selectedDesign.level,  // Include L3/L4 level
            from: 'bom_create'
        });

        window.location.href = `/cutter-map/?${params.toString()}`;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof lucide !== 'undefined') lucide.createIcons();

        // Check for new_design query parameter (coming back from design create)
        const urlParams = new URLSearchParams(window.location.search);
        const newDesignId = urlParams.get('new_design');

        if (newDesignId) {
            // Find and click the row with this design ID
            const row = document.querySelector(`.design-row[data-design-id="${newDesignId}"]`);
            if (row) {
                // Scroll to the row
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Select it after a brief delay for visibility
                setTimeout(() => {
                    selectDesign(row);
                    // Show options dialog instead of alert
                    showNewDesignDialog(row);
                }, 500);
            }
            // Clean up URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    });

    // Show dialog with options after design creation
    function showNewDesignDialog(row) {
        const matNo = row.querySelector('td:nth-child(3)').textContent.trim();
        const level = selectedDesign.level;
        const hdbs = selectedDesign.hdbs;
        const size = selectedDesign.size;

        const dialog = document.createElement('div');
        dialog.className = 'fixed inset-0 z-50 flex items-center justify-center';
        dialog.innerHTML = `
            <div class="fixed inset-0 bg-black/50" onclick="this.parentElement.remove()"></div>
            <div class="relative bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full mx-4 p-6 z-10">
                <div class="flex items-center gap-3 mb-4">
                    <div class="p-2 bg-green-100 dark:bg-green-900/30 rounded-lg">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Design Created!</h3>
                        <p class="text-sm text-gray-500">
                            <span class="inline-block px-2 py-0.5 text-xs font-bold rounded ${level === 'L3' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}">${level}</span>
                            ${matNo}
                        </p>
                    </div>
                </div>

                <p class="text-sm text-gray-600 dark:text-gray-300 mb-6">
                    What would you like to do next?
                </p>

                <div class="space-y-3">
                    <button onclick="goToCutterMapWithDesign(); this.closest('.fixed').remove();"
                            class="w-full flex items-center gap-3 px-4 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <div class="text-left">
                            <div class="font-medium">Open Cutter Map</div>
                            <div class="text-xs text-purple-200">Import PDF and create BOM</div>
                        </div>
                    </button>

                    <button onclick="this.closest('.fixed').remove();"
                            class="w-full flex items-center gap-3 px-4 py-3 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                        </svg>
                        <div class="text-left">
                            <div class="font-medium">Stay Here</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Continue selecting designs</div>
                        </div>
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(dialog);
    }

    // Navigate to Cutter Map with selected design
    function goToCutterMapWithDesign() {
        if (selectedDesign) {
            openCutterMap();
        }
    }
</script>
{% endblock %}
