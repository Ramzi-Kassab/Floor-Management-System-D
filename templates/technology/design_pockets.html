{% extends "base.html" %}

{% block title %}{{ page_title }} - ARDT FMS{% endblock %}

{% block page_header %}
<div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
    <div class="flex items-center gap-4">
        <a href="{% url 'technology:design_detail' design.pk %}" class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
        </a>
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{ page_title }}</h1>
            <p class="text-gray-600 dark:text-gray-400">{{ design.description|default:"Configure pocket layout and features" }}</p>
        </div>
    </div>
    <div class="mt-4 md:mt-0 flex gap-2">
        <a href="{% url 'technology:design_update' design.pk %}" class="inline-flex items-center px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">
            <i data-lucide="edit" class="w-4 h-4 mr-2"></i>Edit Design
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div x-data="pocketsLayout()" class="space-y-6">
    <!-- Tab Navigation -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm">
        <div class="border-b border-gray-200 dark:border-gray-700">
            <nav class="flex -mb-px">
                <button @click="activeTab = 'config'"
                        :class="activeTab === 'config' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400'"
                        class="px-6 py-3 border-b-2 font-medium text-sm">
                    <i data-lucide="settings" class="w-4 h-4 inline mr-2"></i>Configuration & Grid
                </button>
                <button @click="activeTab = 'locations'"
                        :class="activeTab === 'locations' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400'"
                        class="px-6 py-3 border-b-2 font-medium text-sm">
                    <i data-lucide="map-pin" class="w-4 h-4 inline mr-2"></i>Pockets Locations
                    <span class="ml-1 px-1.5 py-0.5 text-xs bg-gray-200 dark:bg-gray-600 rounded">Soon</span>
                </button>
                <button @click="activeTab = 'engagements'"
                        :class="activeTab === 'engagements' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400'"
                        class="px-6 py-3 border-b-2 font-medium text-sm">
                    <i data-lucide="layers" class="w-4 h-4 inline mr-2"></i>Engagements
                    <span class="ml-1 px-1.5 py-0.5 text-xs bg-gray-200 dark:bg-gray-600 rounded">Soon</span>
                </button>
            </nav>
        </div>
    </div>

    <!-- Tab 1: Configuration & Grid -->
    <div x-show="activeTab === 'config'" class="space-y-6">
        <!-- Section 1: Design Info (Editable) -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                    <i data-lucide="info" class="w-5 h-5"></i>
                    Design Information
                </h2>
            </div>
            <div class="px-6 py-4">
                <form method="post" action="{% url 'technology:design_pockets_update_info' design.pk %}" class="grid grid-cols-2 md:grid-cols-5 gap-6">
                    {% csrf_token %}
                    <div>
                        <dt class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">MAT No.</dt>
                        <dd class="mt-1 text-lg font-mono font-medium text-gray-900 dark:text-white">{{ design.mat_no }}</dd>
                    </div>
                    <div>
                        <dt class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Blades Count</dt>
                        <dd class="mt-1 text-lg font-bold text-blue-600 dark:text-blue-400">{{ design.no_of_blades|default:"--" }}</dd>
                    </div>
                    <div>
                        <dt class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Total Pockets Count</dt>
                        <dd class="mt-1 text-lg font-bold text-green-600 dark:text-green-400">{{ design.total_pockets_count|default:"--" }}</dd>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase block">Rows Count</label>
                        <input type="number" name="pocket_rows_count"
                               value="{{ design.pocket_rows_count|default:1 }}"
                               min="1" max="4"
                               class="mt-1 w-full px-3 py-2 text-lg font-bold text-purple-600 dark:text-purple-400 bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg focus:ring-2 focus:ring-purple-500"
                               @change="$el.form.submit()">
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase block">Pocket Layout No.</label>
                        <input type="text" name="pocket_layout_number"
                               value="{{ design.pocket_layout_number|default:'' }}"
                               placeholder="e.g., PL-001"
                               class="mt-1 w-full px-3 py-2 text-lg font-mono text-orange-600 dark:text-orange-400 bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg focus:ring-2 focus:ring-orange-500"
                               @blur="$el.form.submit()">
                    </div>
                </form>
            </div>
        </div>

        <!-- Section 2: Pocket Sizes Configuration Table -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                    <i data-lucide="list" class="w-5 h-5"></i>
                    Pocket Size Configuration
                </h2>
                <button @click="addConfigRow()" class="inline-flex items-center px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                    <i data-lucide="plus" class="w-4 h-4 mr-1"></i>Add Size
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase w-24">Order</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Pocket Size</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase w-24">L/M/S</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Pocket Shape</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase w-24">Count</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase w-20">Row</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase w-32">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        {% for config in pocket_configs %}
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50" data-config-id="{{ config.pk }}">
                            <!-- Order with color background -->
                            <td class="px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <div class="flex flex-col">
                                        <button type="button"
                                                onclick="reorderConfig({{ config.pk }}, 'up')"
                                                class="p-0.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 {% if forloop.first %}opacity-30 cursor-not-allowed{% endif %}">
                                            <i data-lucide="chevron-up" class="w-4 h-4"></i>
                                        </button>
                                        <button type="button"
                                                onclick="reorderConfig({{ config.pk }}, 'down')"
                                                class="p-0.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 {% if forloop.last %}opacity-30 cursor-not-allowed{% endif %}">
                                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                    <span class="w-8 h-8 flex items-center justify-center rounded font-bold text-white text-sm"
                                          style="background-color: {{ config.display_color }}">
                                        {{ config.order }}
                                    </span>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-gray-900 dark:text-white font-medium">{{ config.pocket_size.display_name }}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-0.5 text-xs font-medium rounded
                                    {% if config.length_type == 'L' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                                    {% elif config.length_type == 'M' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200
                                    {% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200{% endif %}">
                                    {{ config.get_length_type_display }}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-gray-900 dark:text-white">
                                {{ config.pocket_shape.name }}
                            </td>
                            <td class="px-4 py-3 text-gray-900 dark:text-white font-bold">{{ config.count }}</td>
                            <td class="px-4 py-3">
                                <select class="w-16 px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                        onchange="updateConfigRow({{ config.pk }}, this.value)">
                                    {% for i in "1234"|make_list %}
                                    <option value="{{ i }}" {% if config.row_number|default:1 == i|add:0 %}selected{% endif %}>{{ i }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <form method="post" action="{% url 'technology:pocket_config_delete' design.pk config.pk %}" class="inline">
                                    {% csrf_token %}
                                    <button type="submit" class="text-red-600 hover:text-red-800 dark:text-red-400" onclick="return confirm('Delete this configuration?')">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                <p>No pocket configurations defined yet</p>
                                <p class="text-sm">Click "Add Size" to start configuring pocket sizes</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    {% if pocket_configs %}
                    <tfoot class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <td colspan="4" class="px-4 py-3 text-right font-medium text-gray-700 dark:text-gray-300">Total:</td>
                            <td class="px-4 py-3 font-bold text-gray-900 dark:text-white">{{ config_total }}</td>
                            <td colspan="2" class="px-4 py-3">
                                {% if design.total_pockets_count %}
                                    {% if config_total == design.total_pockets_count %}
                                    <span class="text-green-600 dark:text-green-400 text-sm"><i data-lucide="check-circle" class="w-4 h-4 inline"></i> Matches</span>
                                    {% else %}
                                    <span class="text-red-600 dark:text-red-400 text-sm"><i data-lucide="alert-circle" class="w-4 h-4 inline"></i> Expected: {{ design.total_pockets_count }}</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                    </tfoot>
                    {% endif %}
                </table>
            </div>
        </div>

        <!-- Section 3: Pockets Grid -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                    <i data-lucide="grid-3x3" class="w-5 h-5"></i>
                    Pockets Grid
                </h2>
                <div class="flex items-center gap-4">
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        {{ design.no_of_blades|default:0 }} Blades Ã— {{ design.pocket_rows_count|default:1 }} Row{{ design.pocket_rows_count|default:1|pluralize }}
                    </div>
                </div>
            </div>

            <!-- Grid Legend -->
            {% if pocket_configs %}
            <div class="px-6 py-3 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50">
                <div class="flex flex-wrap gap-3">
                    {% for config in pocket_configs %}
                    <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800 cursor-pointer hover:ring-2 hover:ring-blue-500"
                         @click="selectedConfigId = {{ config.pk }}; selectedConfigColor = '{{ config.display_color }}'"
                         :class="selectedConfigId === {{ config.pk }} ? 'ring-2 ring-blue-500' : ''">
                        <div class="w-6 h-6 rounded flex items-center justify-center text-white text-xs font-bold" style="background-color: {{ config.display_color }}">{{ config.order }}</div>
                        <span class="text-sm text-gray-700 dark:text-gray-300">{{ config.pocket_size.display_name }}</span>
                        <span class="text-xs text-gray-500">({{ config.count }})</span>
                    </div>
                    {% endfor %}
                </div>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">Click a configuration above, then click cells in the grid to assign</p>
            </div>
            {% endif %}

            <div class="p-6 overflow-x-auto">
                {% if design.no_of_blades and pocket_configs %}
                <div class="space-y-6">
                    {% for row_num in "1234"|make_list %}
                    {% if row_num|add:0 <= design.pocket_rows_count|default:1 %}
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg">
                        <div class="px-4 py-2 bg-gray-100 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Row {{ row_num }}</span>
                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                <span>Sequence: </span>
                                <span x-text="getRowSequence({{ row_num }})" class="font-mono"></span>
                            </div>
                        </div>
                        <div class="p-4">
                            <!-- Pocket Numbers Header -->
                            <div class="flex mb-2">
                                <div class="w-16 flex-shrink-0"></div>
                                <div class="flex gap-1">
                                    <template x-for="col in 20" :key="col">
                                        <div class="w-10 text-center text-xs text-gray-500 dark:text-gray-400 font-medium" x-text="col"></div>
                                    </template>
                                </div>
                            </div>
                            <!-- Blade Rows -->
                            {% for blade_num in "123456789"|make_list %}
                            {% if blade_num|add:0 <= design.no_of_blades %}
                            <div class="flex items-center mb-1">
                                <div class="w-16 flex-shrink-0 font-medium text-gray-900 dark:text-white text-sm">B{{ blade_num }}</div>
                                <div class="flex gap-1">
                                    <template x-for="col in 20" :key="col">
                                        <div class="w-10 h-10 border border-dashed border-gray-300 dark:border-gray-600 rounded flex items-center justify-center text-xs cursor-pointer transition-all"
                                             :style="getCellStyle({{ blade_num }}, {{ row_num }}, col)"
                                             :class="getCellClass({{ blade_num }}, {{ row_num }}, col)"
                                             @click="assignPocket({{ blade_num }}, {{ row_num }}, col)">
                                        </div>
                                    </template>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                            <!-- Row Total Sequence -->
                            <div class="flex items-center mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                                <div class="w-16 flex-shrink-0 text-xs text-gray-500 dark:text-gray-400">Total</div>
                                <div class="flex gap-1">
                                    <template x-for="col in 20" :key="col">
                                        <div class="w-10 text-center text-xs font-mono text-gray-600 dark:text-gray-400"
                                             x-text="getColumnTotal({{ row_num }}, col)">
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                    <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                    <p class="text-lg font-medium">Cannot display grid</p>
                    <p class="text-sm mt-2">
                        {% if not design.no_of_blades %}
                        Please set the number of blades in the design first.
                        {% elif not pocket_configs %}
                        Please add pocket size configurations above first.
                        {% endif %}
                    </p>
                    {% if not design.no_of_blades %}
                    <a href="{% url 'technology:design_update' design.pk %}" class="inline-flex items-center mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i data-lucide="edit" class="w-4 h-4 mr-2"></i>Edit Design
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Tab 2: Pockets Locations on Blade -->
    <div x-show="activeTab === 'locations'" class="space-y-6">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-12 text-center">
            <i data-lucide="map-pin" class="w-16 h-16 mx-auto text-gray-300 dark:text-gray-600 mb-4"></i>
            <h3 class="text-xl font-medium text-gray-900 dark:text-white mb-2">Pockets Locations on Blade</h3>
            <p class="text-gray-500 dark:text-gray-400 max-w-md mx-auto">
                This tab will allow you to define the physical location of each pocket on the blade profile.
                Configure radial positions, back rake, side rake, and exposure for each cutter pocket.
            </p>
        </div>
    </div>

    <!-- Tab 3: Engagements -->
    <div x-show="activeTab === 'engagements'" class="space-y-6">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-12 text-center">
            <i data-lucide="layers" class="w-16 h-16 mx-auto text-gray-300 dark:text-gray-600 mb-4"></i>
            <h3 class="text-xl font-medium text-gray-900 dark:text-white mb-2">Engagements</h3>
            <p class="text-gray-500 dark:text-gray-400 max-w-md mx-auto">
                This tab will allow you to define the full engagement sequence for cutters.
                Set the order in which cutters engage the formation during drilling.
            </p>
        </div>
    </div>

    <!-- Add Config Modal -->
    <div x-show="showAddModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black bg-opacity-50" @click="showAddModal = false"></div>
            <div class="relative bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-lg w-full p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Add Pocket Configuration</h3>
                <form method="post" action="{% url 'technology:pocket_config_create' design.pk %}">
                    {% csrf_token %}
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pocket Size</label>
                            <select name="pocket_size" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required>
                                <option value="">Select size...</option>
                                {% for size in pocket_sizes %}
                                <option value="{{ size.id }}">{{ size.display_name }}</option>
                                {% empty %}
                                <option disabled>Run: python manage.py seed_pocket_sizes</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Length (L/M/S)</label>
                                <select name="length_type" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required>
                                    {% for value, label in length_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Count</label>
                                <input type="number" name="count" min="1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Row</label>
                                <select name="row_number" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pocket Shape</label>
                            <select name="pocket_shape" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required>
                                <option value="">Select shape...</option>
                                {% for shape in pocket_shapes %}
                                <option value="{{ shape.id }}">{{ shape.name }}</option>
                                {% empty %}
                                <option disabled>Run: python manage.py seed_pocket_shapes</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button type="button" @click="showAddModal = false" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Add Configuration
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function pocketsLayout() {
    return {
        activeTab: 'config',
        showAddModal: false,
        selectedConfigId: null,
        selectedConfigColor: null,
        gridData: {}, // Store grid assignments: {blade_row_col: configId}

        init() {
            // Load existing grid data from server if available
            this.loadGridData();
        },

        loadGridData() {
            // TODO: Load from server via AJAX
            // For now, initialize empty
        },

        addConfigRow() {
            this.showAddModal = true;
        },

        assignPocket(blade, row, col) {
            if (!this.selectedConfigId) {
                alert('Please select a pocket configuration from the legend first');
                return;
            }
            const key = `${blade}_${row}_${col}`;
            if (this.gridData[key] === this.selectedConfigId) {
                // Click again to unassign
                delete this.gridData[key];
            } else {
                this.gridData[key] = this.selectedConfigId;
            }
            // TODO: Save to server via AJAX
        },

        getCellStyle(blade, row, col) {
            const key = `${blade}_${row}_${col}`;
            const configId = this.gridData[key];
            if (configId && configId === this.selectedConfigId) {
                return `background-color: ${this.selectedConfigColor}`;
            }
            // Find color from configs
            const configColors = {
                {% for config in pocket_configs %}
                {{ config.pk }}: '{{ config.display_color }}',
                {% endfor %}
            };
            if (configId && configColors[configId]) {
                return `background-color: ${configColors[configId]}`;
            }
            return '';
        },

        getCellClass(blade, row, col) {
            const key = `${blade}_${row}_${col}`;
            if (this.gridData[key]) {
                return 'border-solid border-2';
            }
            return 'hover:bg-gray-100 dark:hover:bg-gray-700';
        },

        getRowSequence(row) {
            // Get sequence of assigned pockets for a row
            let seq = [];
            for (let blade = 1; blade <= 9; blade++) {
                for (let col = 1; col <= 20; col++) {
                    const key = `${blade}_${row}_${col}`;
                    if (this.gridData[key]) {
                        seq.push(`B${blade}P${col}`);
                    }
                }
            }
            return seq.length > 0 ? seq.join(', ') : '--';
        },

        getColumnTotal(row, col) {
            let count = 0;
            for (let blade = 1; blade <= 9; blade++) {
                const key = `${blade}_${row}_${col}`;
                if (this.gridData[key]) count++;
            }
            return count > 0 ? count : '';
        }
    }
}

function reorderConfig(configId, direction) {
    // Submit form to reorder
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "technology:pocket_config_reorder" design.pk %}';

    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = '{{ csrf_token }}';
    form.appendChild(csrfInput);

    const configInput = document.createElement('input');
    configInput.type = 'hidden';
    configInput.name = 'config_id';
    configInput.value = configId;
    form.appendChild(configInput);

    const dirInput = document.createElement('input');
    dirInput.type = 'hidden';
    dirInput.name = 'direction';
    dirInput.value = direction;
    form.appendChild(dirInput);

    document.body.appendChild(form);
    form.submit();
}

function updateConfigRow(configId, rowNumber) {
    // Submit form to update row number
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "technology:pocket_config_update_row" design.pk %}';

    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = '{{ csrf_token }}';
    form.appendChild(csrfInput);

    const configInput = document.createElement('input');
    configInput.type = 'hidden';
    configInput.name = 'config_id';
    configInput.value = configId;
    form.appendChild(configInput);

    const rowInput = document.createElement('input');
    rowInput.type = 'hidden';
    rowInput.name = 'row_number';
    rowInput.value = rowNumber;
    form.appendChild(rowInput);

    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}
