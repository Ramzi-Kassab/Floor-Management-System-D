{% extends "base.html" %}

{% block title %}Bills of Materials - ARDT FMS{% endblock %}

{% block breadcrumbs %}
<nav class="flex mb-4" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li><a href="{% url 'dashboard:home' %}" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white">
            <i data-lucide="home" class="w-4 h-4"></i>
        </a></li>
        <li class="flex items-center">
            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
            <a href="{% url 'technology:index' %}" class="ml-1 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white text-sm">Technology</a>
        </li>
        <li class="flex items-center">
            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
            <span class="ml-1 text-gray-700 dark:text-white text-sm font-medium">Bills of Materials</span>
        </li>
    </ol>
</nav>
{% endblock %}

{% block page_header %}
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Bills of Materials</h1>
        <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">Manage BOMs for designs with material tracking</p>
    </div>
    <div class="flex gap-2">
        <a href="{% url 'technology:bom_builder' %}"
           class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
            Create BOM
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
                <i data-lucide="file-text" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i>
            </div>
            <div>
                <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ boms_with_status|length }}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">Total BOMs</p>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-green-100 dark:bg-green-900/30 rounded-lg">
                <i data-lucide="check-circle" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
            </div>
            <div>
                <p class="text-2xl font-bold text-gray-900 dark:text-white" id="stat-ready">0</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">Materials Ready</p>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-amber-100 dark:bg-amber-900/30 rounded-lg">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-600 dark:text-amber-400"></i>
            </div>
            <div>
                <p class="text-2xl font-bold text-gray-900 dark:text-white" id="stat-shortage">0</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">Shortage</p>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <i data-lucide="edit-3" class="w-5 h-5 text-gray-600 dark:text-gray-400"></i>
            </div>
            <div>
                <p class="text-2xl font-bold text-gray-900 dark:text-white" id="stat-draft">0</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">Drafts</p>
            </div>
        </div>
    </div>
</div>

<!-- Filter Form (using django-filter) -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-6">
    <form method="get" class="flex flex-wrap gap-4 items-end">
        <div class="flex-1 min-w-[200px]">
            {{ filter.form.search }}
        </div>
        <div>
            {{ filter.form.design__order_level }}
        </div>
        <div>
            {{ filter.form.design__size }}
        </div>
        <div>
            {{ filter.form.status }}
        </div>
        <div class="flex gap-2">
            <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors text-sm">
                <i data-lucide="filter" class="w-4 h-4 inline mr-1"></i> Filter
            </button>
            <a href="{% url 'technology:bom_list' %}" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition-colors text-sm">
                Clear
            </a>
        </div>
    </form>
</div>

<!-- BOM Table with DataTables -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
    <table id="bom-table" class="w-full">
        <thead>
            <tr>
                <th>BOM Code</th>
                <th>HDBS Type</th>
                <th>SMI Type</th>
                <th>Design MAT</th>
                <th>Level</th>
                <th>Size</th>
                <th>Items</th>
                <th>Materials</th>
                <th>Status</th>
                <th data-sortable="false">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in boms_with_status %}
            <tr data-bom-id="{{ item.bom.pk }}"
                data-materials="{{ item.materials_ready|yesno:'ready,shortage,unknown' }}">
                <!-- BOM Code -->
                <td>
                    <a href="{% url 'technology:bom_detail' item.bom.pk %}" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">
                        {{ item.bom.code }}
                    </a>
                    <p class="text-xs text-gray-500 dark:text-gray-400">{{ item.bom.name|truncatechars:30 }}</p>
                </td>
                <!-- HDBS Type -->
                <td>{{ item.bom.design.hdbs_type|default:"-" }}</td>
                <!-- SMI Type -->
                <td>{{ item.bom.design.smi_type|default:"-" }}</td>
                <!-- Design MAT -->
                <td>
                    <span class="text-xs font-mono">{{ item.bom.design.mat_no|default:"-" }}</span>
                </td>
                <!-- Level -->
                <td class="text-center">
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                        {% if item.bom.design.order_level == '3' %}bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300
                        {% elif item.bom.design.order_level == '4' %}bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-300
                        {% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300{% endif %}">
                        L{{ item.bom.design.order_level }}
                    </span>
                </td>
                <!-- Size -->
                <td class="text-center">{{ item.bom.design.size.size_display|default:"-" }}</td>
                <!-- Items -->
                <td class="text-center">{{ item.line_count }}</td>
                <!-- Materials -->
                <td class="text-center">
                    {% if item.materials_ready == None %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400">
                        <i data-lucide="minus" class="w-3 h-3 mr-1"></i> No Items
                    </span>
                    {% elif item.materials_ready %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">
                        <i data-lucide="check" class="w-3 h-3 mr-1"></i> Ready
                    </span>
                    {% else %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400">
                        <i data-lucide="alert-triangle" class="w-3 h-3 mr-1"></i> Shortage
                    </span>
                    {% endif %}
                </td>
                <!-- Status -->
                <td class="text-center">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs
                        {% if item.bom.status == 'ACTIVE' %}bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400
                        {% elif item.bom.status == 'DRAFT' %}bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300
                        {% else %}bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400{% endif %}">
                        {{ item.bom.get_status_display }}
                    </span>
                </td>
                <!-- Actions -->
                <td class="text-right">
                    <div class="flex items-center justify-end gap-1">
                        <a href="{% url 'technology:bom_detail' item.bom.pk %}"
                           class="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded"
                           title="View">
                            <i data-lucide="eye" class="w-4 h-4"></i>
                        </a>
                        <a href="{% url 'technology:bom_edit' item.bom.pk %}"
                           class="p-1.5 text-gray-500 hover:text-amber-600 hover:bg-amber-50 dark:hover:bg-amber-900/30 rounded"
                           title="Edit">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </a>
                        <button type="button"
                                class="p-1.5 text-gray-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 rounded delete-bom-btn"
                                data-bom-id="{{ item.bom.pk }}"
                                data-bom-code="{{ item.bom.code }}"
                                title="Delete">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="10" class="text-center py-8 text-gray-500 dark:text-gray-400">
                    <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                    <p>No BOMs found</p>
                    <a href="{% url 'technology:bom_builder' %}" class="text-blue-600 hover:underline text-sm">Create your first BOM</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50" style="display: none;">
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4 shadow-xl">
        <div class="flex items-center gap-3 mb-4">
            <div class="p-2 bg-red-100 dark:bg-red-900/30 rounded-full">
                <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600 dark:text-red-400"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Delete BOM</h3>
        </div>
        <p class="text-gray-600 dark:text-gray-400 mb-6">
            Are you sure you want to delete BOM <strong id="delete-bom-code" class="text-gray-900 dark:text-white"></strong>?
            This action cannot be undone.
        </p>
        <div class="flex gap-3 justify-end">
            <button type="button" id="cancel-delete"
                    class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                Cancel
            </button>
            <form id="delete-form" method="post" action="" class="inline">
                {% csrf_token %}
                <button type="submit"
                        class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                    Delete
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize DataTable when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Check if Simple-DataTables is available
    if (typeof simpleDatatables !== 'undefined' && typeof simpleDatatables.DataTable !== 'undefined') {
        const table = new simpleDatatables.DataTable("#bom-table", {
            searchable: true,
            sortable: true,
            perPage: 25,
            perPageSelect: [10, 25, 50, 100],
            labels: {
                placeholder: "Search BOMs...",
                perPage: "per page",
                noRows: "No BOMs found",
                info: "Showing {start} to {end} of {rows} BOMs"
            },
            columns: [
                { select: 9, sortable: false } // Actions column
            ]
        });

        // Re-init Lucide icons after table render
        table.on('datatable.init', function() {
            lucide.createIcons();
            updateStats();
        });
        table.on('datatable.page', function() {
            lucide.createIcons();
        });
        table.on('datatable.sort', function() {
            lucide.createIcons();
        });
        table.on('datatable.search', function() {
            lucide.createIcons();
            updateStats();
        });
    }

    // Update stats
    updateStats();

    // Delete modal
    const deleteModal = document.getElementById('delete-modal');
    document.querySelectorAll('.delete-bom-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('delete-bom-code').textContent = this.dataset.bomCode;
            document.getElementById('delete-form').action = `/technology/boms/${this.dataset.bomId}/delete/`;
            deleteModal.style.display = 'flex';
        });
    });
    document.getElementById('cancel-delete').addEventListener('click', () => {
        deleteModal.style.display = 'none';
    });
    deleteModal.addEventListener('click', e => {
        if (e.target === deleteModal) deleteModal.style.display = 'none';
    });

    // Lucide icons
    lucide.createIcons();
});

// Update statistics
function updateStats() {
    let readyCount = 0, shortageCount = 0, draftCount = 0;
    document.querySelectorAll('#bom-table tbody tr[data-bom-id]').forEach(row => {
        if (row.style.display !== 'none') {
            const materials = row.dataset.materials;
            if (materials === 'ready') readyCount++;
            if (materials === 'shortage') shortageCount++;
            // Check for draft status
            if (row.querySelector('.bg-gray-100.text-gray-700, .dark\\:bg-gray-700.dark\\:text-gray-300')) {
                draftCount++;
            }
        }
    });
    document.getElementById('stat-ready').textContent = readyCount;
    document.getElementById('stat-shortage').textContent = shortageCount;
    document.getElementById('stat-draft').textContent = draftCount;
}
</script>
{% endblock %}
