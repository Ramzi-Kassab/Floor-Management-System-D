{% extends "base.html" %}

{% block title %}Bills of Materials - ARDT FMS{% endblock %}

{% block extra_css %}
<style>
    .filter-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        z-index: 50;
        min-width: 180px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        display: none;
    }
    .dark .filter-dropdown {
        background: #1f2937;
        border-color: #374151;
    }
    .filter-dropdown.active {
        display: block;
    }
    .th-filter {
        position: relative;
        cursor: pointer;
        user-select: none;
    }
    .th-filter:hover {
        background: rgba(59, 130, 246, 0.1);
    }
    .filter-btn {
        opacity: 0.5;
        transition: opacity 0.2s;
    }
    .th-filter:hover .filter-btn,
    .th-filter.filtered .filter-btn {
        opacity: 1;
    }
    .th-filter.filtered .filter-btn {
        color: #3b82f6;
    }
</style>
{% endblock %}

{% block page_header %}
<div class="mb-6">
    <!-- Modern Header -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl p-6 mb-6 shadow-lg">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
            <div class="text-white">
                <h1 class="text-2xl font-bold flex items-center">
                    <i data-lucide="file-stack" class="w-7 h-7 mr-3"></i>
                    Bills of Materials
                </h1>
                <p class="text-blue-100 mt-1">Manage cutter BOMs for drill bit designs</p>
            </div>
            <div class="mt-4 lg:mt-0 flex flex-wrap gap-2">
                <a href="{% url 'inventory:item_list' %}" class="inline-flex items-center px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30 backdrop-blur-sm transition-colors">
                    <i data-lucide="package" class="w-4 h-4 mr-2"></i>Inventory
                </a>
                <a href="{% url 'technology:bom_create' %}" class="inline-flex items-center px-4 py-2 bg-white text-blue-700 rounded-lg hover:bg-blue-50 font-medium shadow-sm transition-colors">
                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i>New BOM
                </a>
            </div>
        </div>

        <!-- Stats Row -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                <div class="text-blue-100 text-sm">Total BOMs</div>
                <div class="text-white text-2xl font-bold">{{ boms_with_status|length }}</div>
            </div>
            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                <div class="text-blue-100 text-sm">Materials Ready</div>
                <div class="text-green-300 text-2xl font-bold" id="stat-ready">0</div>
            </div>
            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                <div class="text-blue-100 text-sm">Shortages</div>
                <div class="text-amber-300 text-2xl font-bold" id="stat-shortage">0</div>
            </div>
            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                <div class="text-blue-100 text-sm">Draft</div>
                <div class="text-white text-2xl font-bold" id="stat-draft">0</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Search Bar -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4">
    <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
            <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                <input type="text" id="global-search"
                       placeholder="Search by MAT No., HDBS Type, SMI Type..."
                       class="w-full pl-11 pr-4 py-2.5 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
        </div>
        <div class="flex gap-2">
            <button type="button" id="clear-all-filters" class="px-4 py-2.5 text-gray-600 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 text-sm">
                Clear Filters
            </button>
            <span class="text-sm text-gray-500 self-center" id="filter-count"></span>
        </div>
    </div>
</div>

<!-- BOM Table -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
    {% if boms_with_status %}
    <div class="overflow-x-auto">
        <table class="w-full text-sm" id="bom-table">
            <thead class="bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700">
                <tr>
                    <!-- L5 MAT No. -->
                    <th class="th-filter px-3 py-2.5 text-left text-xs font-semibold text-gray-500 uppercase" data-column="mat5">
                        <div class="flex items-center justify-between gap-1">
                            <span>L5 MAT No.</span>
                            <button type="button" class="filter-btn p-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded" onclick="toggleFilter(event, 'mat5')">
                                <i data-lucide="filter" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                        <div class="filter-dropdown" id="filter-mat5-dropdown">
                            <div class="p-2 border-b border-gray-200 dark:border-gray-600">
                                <button type="button" class="w-full text-left px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="sortColumn('mat5', 'asc')">
                                    <i data-lucide="arrow-up" class="w-3 h-3 mr-2"></i>Sort A-Z
                                </button>
                                <button type="button" class="w-full text-left px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="sortColumn('mat5', 'desc')">
                                    <i data-lucide="arrow-down" class="w-3 h-3 mr-2"></i>Sort Z-A
                                </button>
                            </div>
                            <div class="p-2">
                                <input type="text" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded dark:bg-gray-700"
                                       placeholder="Filter..." data-filter="mat5" oninput="applyTextFilter('mat5', this.value)">
                            </div>
                        </div>
                    </th>
                    <!-- HDBS Type -->
                    <th class="th-filter px-3 py-2.5 text-left text-xs font-semibold text-gray-500 uppercase" data-column="hdbs">
                        <div class="flex items-center justify-between gap-1">
                            <span>HDBS Type</span>
                            <button type="button" class="filter-btn p-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded" onclick="toggleFilter(event, 'hdbs')">
                                <i data-lucide="filter" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                        <div class="filter-dropdown" id="filter-hdbs-dropdown">
                            <div class="p-2 border-b border-gray-200 dark:border-gray-600">
                                <button type="button" class="w-full text-left px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="sortColumn('hdbs', 'asc')">
                                    <i data-lucide="arrow-up" class="w-3 h-3 mr-2"></i>Sort A-Z
                                </button>
                                <button type="button" class="w-full text-left px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="sortColumn('hdbs', 'desc')">
                                    <i data-lucide="arrow-down" class="w-3 h-3 mr-2"></i>Sort Z-A
                                </button>
                            </div>
                            <div class="p-2">
                                <input type="text" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded dark:bg-gray-700"
                                       placeholder="Filter..." data-filter="hdbs" oninput="applyTextFilter('hdbs', this.value)">
                            </div>
                        </div>
                    </th>
                    <!-- SMI Type -->
                    <th class="th-filter px-3 py-2.5 text-left text-xs font-semibold text-gray-500 uppercase" data-column="smi">
                        <div class="flex items-center justify-between gap-1">
                            <span>SMI Type</span>
                            <button type="button" class="filter-btn p-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded" onclick="toggleFilter(event, 'smi')">
                                <i data-lucide="filter" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                        <div class="filter-dropdown" id="filter-smi-dropdown">
                            <div class="p-2 border-b border-gray-200 dark:border-gray-600">
                                <button type="button" class="w-full text-left px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="sortColumn('smi', 'asc')">
                                    <i data-lucide="arrow-up" class="w-3 h-3 mr-2"></i>Sort A-Z
                                </button>
                                <button type="button" class="w-full text-left px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="sortColumn('smi', 'desc')">
                                    <i data-lucide="arrow-down" class="w-3 h-3 mr-2"></i>Sort Z-A
                                </button>
                            </div>
                            <div class="p-2">
                                <input type="text" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded dark:bg-gray-700"
                                       placeholder="Filter..." data-filter="smi" oninput="applyTextFilter('smi', this.value)">
                            </div>
                        </div>
                    </th>
                    <!-- Level -->
                    <th class="th-filter px-3 py-2.5 text-center text-xs font-semibold text-gray-500 uppercase" data-column="level">
                        <div class="flex items-center justify-center gap-1">
                            <span>Level</span>
                            <button type="button" class="filter-btn p-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded" onclick="toggleFilter(event, 'level')">
                                <i data-lucide="filter" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                        <div class="filter-dropdown" id="filter-level-dropdown">
                            <div class="p-2 border-b border-gray-200 dark:border-gray-600">
                                <button type="button" class="w-full text-left px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="sortColumn('level', 'asc')">
                                    <i data-lucide="arrow-up" class="w-3 h-3 mr-2"></i>Sort 3-4
                                </button>
                                <button type="button" class="w-full text-left px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="sortColumn('level', 'desc')">
                                    <i data-lucide="arrow-down" class="w-3 h-3 mr-2"></i>Sort 4-3
                                </button>
                            </div>
                            <div class="p-2">
                                <label class="flex items-center px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer">
                                    <input type="checkbox" class="level-filter mr-2" value="3" checked onchange="applyLevelFilter()"> Level 3
                                </label>
                                <label class="flex items-center px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer">
                                    <input type="checkbox" class="level-filter mr-2" value="4" checked onchange="applyLevelFilter()"> Level 4
                                </label>
                            </div>
                        </div>
                    </th>
                    <!-- Design MAT -->
                    <th class="th-filter px-3 py-2.5 text-left text-xs font-semibold text-gray-500 uppercase" data-column="mat34">
                        <div class="flex items-center justify-between gap-1">
                            <span>Design MAT</span>
                            <button type="button" class="filter-btn p-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded" onclick="toggleFilter(event, 'mat34')">
                                <i data-lucide="filter" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                        <div class="filter-dropdown" id="filter-mat34-dropdown">
                            <div class="p-2 border-b border-gray-200 dark:border-gray-600">
                                <button type="button" class="w-full text-left px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="sortColumn('mat34', 'asc')">
                                    <i data-lucide="arrow-up" class="w-3 h-3 mr-2"></i>Sort A-Z
                                </button>
                                <button type="button" class="w-full text-left px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="sortColumn('mat34', 'desc')">
                                    <i data-lucide="arrow-down" class="w-3 h-3 mr-2"></i>Sort Z-A
                                </button>
                            </div>
                            <div class="p-2">
                                <input type="text" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded dark:bg-gray-700"
                                       placeholder="Filter..." data-filter="mat34" oninput="applyTextFilter('mat34', this.value)">
                            </div>
                        </div>
                    </th>
                    <!-- Size -->
                    <th class="th-filter px-3 py-2.5 text-center text-xs font-semibold text-gray-500 uppercase" data-column="size">
                        <div class="flex items-center justify-center gap-1">
                            <span>Size</span>
                            <button type="button" class="filter-btn p-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded" onclick="toggleFilter(event, 'size')">
                                <i data-lucide="filter" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                        <div class="filter-dropdown" id="filter-size-dropdown">
                            <div class="p-2 border-b border-gray-200 dark:border-gray-600">
                                <button type="button" class="w-full text-left px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="sortColumn('size', 'asc')">
                                    <i data-lucide="arrow-up" class="w-3 h-3 mr-2"></i>Small-Large
                                </button>
                                <button type="button" class="w-full text-left px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="sortColumn('size', 'desc')">
                                    <i data-lucide="arrow-down" class="w-3 h-3 mr-2"></i>Large-Small
                                </button>
                            </div>
                            <div class="p-2 max-h-40 overflow-y-auto" id="size-filter-options"></div>
                        </div>
                    </th>
                    <!-- Items -->
                    <th class="th-filter px-3 py-2.5 text-center text-xs font-semibold text-gray-500 uppercase" data-column="items">
                        <div class="flex items-center justify-center gap-1">
                            <span>Items</span>
                            <button type="button" class="filter-btn p-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded" onclick="toggleFilter(event, 'items')">
                                <i data-lucide="filter" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                        <div class="filter-dropdown" id="filter-items-dropdown">
                            <div class="p-2">
                                <button type="button" class="w-full text-left px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="sortColumn('items', 'asc')">
                                    <i data-lucide="arrow-up" class="w-3 h-3 mr-2"></i>Low-High
                                </button>
                                <button type="button" class="w-full text-left px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="sortColumn('items', 'desc')">
                                    <i data-lucide="arrow-down" class="w-3 h-3 mr-2"></i>High-Low
                                </button>
                            </div>
                        </div>
                    </th>
                    <!-- Materials -->
                    <th class="th-filter px-3 py-2.5 text-center text-xs font-semibold text-gray-500 uppercase" data-column="materials">
                        <div class="flex items-center justify-center gap-1">
                            <span>Materials</span>
                            <button type="button" class="filter-btn p-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded" onclick="toggleFilter(event, 'materials')">
                                <i data-lucide="filter" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                        <div class="filter-dropdown" id="filter-materials-dropdown">
                            <div class="p-2">
                                <label class="flex items-center px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer">
                                    <input type="checkbox" class="materials-filter mr-2" value="ready" checked onchange="applyMaterialsFilter()"> Ready
                                </label>
                                <label class="flex items-center px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer">
                                    <input type="checkbox" class="materials-filter mr-2" value="shortage" checked onchange="applyMaterialsFilter()"> Shortage
                                </label>
                                <label class="flex items-center px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer">
                                    <input type="checkbox" class="materials-filter mr-2" value="unknown" checked onchange="applyMaterialsFilter()"> Unknown
                                </label>
                            </div>
                        </div>
                    </th>
                    <!-- Status -->
                    <th class="th-filter px-3 py-2.5 text-center text-xs font-semibold text-gray-500 uppercase" data-column="status">
                        <div class="flex items-center justify-center gap-1">
                            <span>Status</span>
                            <button type="button" class="filter-btn p-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded" onclick="toggleFilter(event, 'status')">
                                <i data-lucide="filter" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                        <div class="filter-dropdown" id="filter-status-dropdown">
                            <div class="p-2">
                                <label class="flex items-center px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer">
                                    <input type="checkbox" class="status-filter mr-2" value="DRAFT" checked onchange="applyStatusFilter()"> Draft
                                </label>
                                <label class="flex items-center px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer">
                                    <input type="checkbox" class="status-filter mr-2" value="ACTIVE" checked onchange="applyStatusFilter()"> Active
                                </label>
                            </div>
                        </div>
                    </th>
                    <!-- Actions -->
                    <th class="px-3 py-2.5 text-right text-xs font-semibold text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 dark:divide-gray-700" id="bom-tbody">
                {% for item in boms_with_status %}
                <tr class="hover:bg-blue-50/50 dark:hover:bg-gray-700/30 transition-colors bom-row"
                    data-mat5="{{ item.bom.code|lower }}"
                    data-hdbs="{{ item.bom.design.hdbs_type|default:''|lower }}"
                    data-smi="{{ item.bom.design.smi_type|default:''|lower }}"
                    data-level="{{ item.bom.design.order_level|default:'' }}"
                    data-mat34="{{ item.bom.design.mat_no|default:''|lower }}"
                    data-size="{{ item.bom.design.size.size_decimal|default:0 }}"
                    data-size-display="{{ item.bom.design.size.size_display|default:'' }}"
                    data-items="{{ item.line_count }}"
                    data-materials="{% if item.materials_ready %}ready{% elif item.materials_ready == False %}shortage{% else %}unknown{% endif %}"
                    data-status="{{ item.bom.status }}">
                    <td class="px-3 py-2.5">
                        <a href="{% url 'technology:bom_detail' item.bom.pk %}" class="font-semibold text-blue-600 dark:text-blue-400 hover:underline text-sm">
                            {{ item.bom.code }}
                        </a>
                        <span class="text-xs text-gray-400 ml-1">Rev {{ item.bom.revision }}</span>
                    </td>
                    <td class="px-3 py-2.5">
                        <span class="font-medium text-gray-900 dark:text-white text-sm">{{ item.bom.design.hdbs_type|default:"--" }}</span>
                    </td>
                    <td class="px-3 py-2.5">
                        <span class="text-gray-600 dark:text-gray-400 text-sm">{{ item.bom.design.smi_type|default:"--" }}</span>
                    </td>
                    <td class="px-3 py-2.5 text-center">
                        {% if item.bom.design.order_level %}
                        <span class="inline-flex items-center justify-center w-7 h-7 rounded text-xs font-bold
                            {% if item.bom.design.order_level == '3' %}bg-purple-100 text-purple-700{% else %}bg-indigo-100 text-indigo-700{% endif %}">
                            L{{ item.bom.design.order_level }}
                        </span>
                        {% else %}--{% endif %}
                    </td>
                    <td class="px-3 py-2.5">
                        {% if item.bom.design %}
                        <a href="{% url 'technology:design_detail' item.bom.design.pk %}" class="text-gray-600 dark:text-gray-400 hover:text-blue-600 hover:underline font-mono text-xs">
                            {{ item.bom.design.mat_no|default:"--" }}
                        </a>
                        {% else %}--{% endif %}
                    </td>
                    <td class="px-3 py-2.5 text-center">
                        {% if item.bom.design and item.bom.design.size %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                            {{ item.bom.design.size.size_display }}
                        </span>
                        {% else %}--{% endif %}
                    </td>
                    <td class="px-3 py-2.5 text-center">
                        <span class="text-gray-900 dark:text-white font-medium">{{ item.line_count }}</span>
                    </td>
                    <td class="px-3 py-2.5 text-center">
                        {% if item.materials_ready == True %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-700">
                            <i data-lucide="check" class="w-3 h-3 mr-1"></i>Ready
                        </span>
                        {% elif item.materials_ready == False %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-100 text-amber-700">
                            <i data-lucide="alert-triangle" class="w-3 h-3 mr-1"></i>Shortage
                        </span>
                        {% else %}--{% endif %}
                    </td>
                    <td class="px-3 py-2.5 text-center">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold
                            {% if item.bom.status == 'ACTIVE' %}bg-green-100 text-green-700{% elif item.bom.status == 'DRAFT' %}bg-yellow-100 text-yellow-700{% else %}bg-gray-100 text-gray-600{% endif %}">
                            {{ item.bom.get_status_display }}
                        </span>
                    </td>
                    <td class="px-3 py-2.5">
                        <div class="flex items-center justify-end gap-0.5">
                            <a href="{% url 'technology:bom_builder' item.bom.pk %}" class="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded" title="Builder">
                                <i data-lucide="grid-3x3" class="w-4 h-4"></i>
                            </a>
                            <a href="{% url 'technology:bom_detail' item.bom.pk %}" class="p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded" title="View">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </a>
                            <a href="{% url 'technology:bom_pdf_export' item.bom.pk %}" class="p-1.5 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded" title="PDF">
                                <i data-lucide="file-down" class="w-4 h-4"></i>
                            </a>
                            <button type="button" class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded delete-bom-btn"
                                    data-bom-id="{{ item.bom.pk }}" data-bom-code="{{ item.bom.code }}" title="Delete">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-16">
        <div class="w-20 h-20 mx-auto mb-4 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center">
            <i data-lucide="file-stack" class="w-10 h-10 text-gray-400"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">No BOMs found</h3>
        <p class="text-gray-500 dark:text-gray-400 mb-6 max-w-sm mx-auto">Create your first Bill of Materials to get started.</p>
        <a href="{% url 'technology:bom_create' %}" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-sm">
            <i data-lucide="plus" class="w-5 h-5 mr-2"></i>Create First BOM
        </a>
    </div>
    {% endif %}
</div>

<!-- Quick Links -->
<div class="mt-6 flex flex-wrap gap-3">
    <a href="{% url 'technology:design_list' %}" class="inline-flex items-center px-4 py-2 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-50 text-sm font-medium border border-gray-200 dark:border-gray-700 shadow-sm">
        <i data-lucide="layers" class="w-4 h-4 mr-2 text-purple-500"></i>Designs
    </a>
    <a href="{% url 'technology:hdbs_type_list' %}" class="inline-flex items-center px-4 py-2 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-50 text-sm font-medium border border-gray-200 dark:border-gray-700 shadow-sm">
        <i data-lucide="tag" class="w-4 h-4 mr-2 text-blue-500"></i>HDBS Types
    </a>
    <a href="{% url 'technology:connection_list' %}" class="inline-flex items-center px-4 py-2 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-50 text-sm font-medium border border-gray-200 dark:border-gray-700 shadow-sm">
        <i data-lucide="link" class="w-4 h-4 mr-2 text-green-500"></i>Connections
    </a>
    <a href="{% url 'technology:breaker_slot_list' %}" class="inline-flex items-center px-4 py-2 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-50 text-sm font-medium border border-gray-200 dark:border-gray-700 shadow-sm">
        <i data-lucide="box" class="w-4 h-4 mr-2 text-orange-500"></i>Breaker Slots
    </a>
</div>

<!-- Delete Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6">
        <div class="w-12 h-12 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
            <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white text-center mb-2">Delete BOM?</h3>
        <p class="text-gray-500 dark:text-gray-400 text-center mb-6">
            Delete <span id="delete-bom-code" class="font-semibold text-gray-900 dark:text-white"></span>? This cannot be undone.
        </p>
        <div class="flex gap-3">
            <button type="button" id="cancel-delete" class="flex-1 px-4 py-2.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-xl hover:bg-gray-200 font-medium">Cancel</button>
            <form id="delete-form" method="post" class="flex-1">
                {% csrf_token %}
                <button type="submit" class="w-full px-4 py-2.5 bg-red-600 text-white rounded-xl hover:bg-red-700 font-medium">Delete</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const filters = { mat5: '', hdbs: '', smi: '', mat34: '', level: ['3', '4'], materials: ['ready', 'shortage', 'unknown'], status: ['DRAFT', 'ACTIVE'], size: [] };
let activeDropdown = null;

// Size data from server
const availableSizes = [
    {% for size in sizes %}
    { id: "{{ size.pk }}", decimal: {{ size.size_decimal }}, display: "{{ size.size_display }}" }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Toggle filter dropdown
function toggleFilter(e, column) {
    e.stopPropagation();
    const dropdown = document.getElementById(`filter-${column}-dropdown`);
    if (activeDropdown && activeDropdown !== dropdown) activeDropdown.classList.remove('active');
    dropdown.classList.toggle('active');
    activeDropdown = dropdown.classList.contains('active') ? dropdown : null;
}

document.addEventListener('click', () => {
    if (activeDropdown) { activeDropdown.classList.remove('active'); activeDropdown = null; }
});

// Sort column
function sortColumn(column, direction) {
    const tbody = document.getElementById('bom-tbody');
    const rows = Array.from(tbody.querySelectorAll('.bom-row'));
    rows.sort((a, b) => {
        let aVal = a.dataset[column] || '';
        let bVal = b.dataset[column] || '';
        if (['size', 'items', 'level'].includes(column)) {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
            return direction === 'asc' ? aVal - bVal : bVal - aVal;
        }
        return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    });
    rows.forEach(row => tbody.appendChild(row));
    if (activeDropdown) { activeDropdown.classList.remove('active'); activeDropdown = null; }
}

// Text filter
function applyTextFilter(column, value) {
    filters[column] = value.toLowerCase();
    document.querySelector(`[data-column="${column}"]`).classList.toggle('filtered', value.length > 0);
    applyAllFilters();
}

// Level filter
function applyLevelFilter() {
    filters.level = Array.from(document.querySelectorAll('.level-filter:checked')).map(cb => cb.value);
    document.querySelector('[data-column="level"]').classList.toggle('filtered', filters.level.length < 2);
    applyAllFilters();
}

// Materials filter
function applyMaterialsFilter() {
    filters.materials = Array.from(document.querySelectorAll('.materials-filter:checked')).map(cb => cb.value);
    document.querySelector('[data-column="materials"]').classList.toggle('filtered', filters.materials.length < 3);
    applyAllFilters();
}

// Status filter
function applyStatusFilter() {
    filters.status = Array.from(document.querySelectorAll('.status-filter:checked')).map(cb => cb.value);
    document.querySelector('[data-column="status"]').classList.toggle('filtered', filters.status.length < 2);
    applyAllFilters();
}

// Apply all filters
function applyAllFilters() {
    const globalSearch = document.getElementById('global-search').value.toLowerCase();
    const rows = document.querySelectorAll('.bom-row');
    let visibleCount = 0, readyCount = 0, shortageCount = 0, draftCount = 0;

    rows.forEach(row => {
        let visible = true;

        // Global search
        if (globalSearch) {
            const searchFields = ['mat5', 'hdbs', 'smi', 'mat34'];
            const matches = searchFields.some(f => (row.dataset[f] || '').includes(globalSearch));
            if (!matches) visible = false;
        }

        // Text filters
        ['mat5', 'hdbs', 'smi', 'mat34'].forEach(col => {
            if (filters[col] && !(row.dataset[col] || '').includes(filters[col])) visible = false;
        });

        // Checkbox filters
        if (!filters.level.includes(row.dataset.level) && row.dataset.level) visible = false;
        if (!filters.materials.includes(row.dataset.materials)) visible = false;
        if (!filters.status.includes(row.dataset.status)) visible = false;

        // Size filter (if specific sizes are selected)
        if (filters.size && filters.size.length > 0 && !filters.size.includes('')) {
            const rowSize = row.dataset.size;
            if (rowSize && !filters.size.includes(rowSize)) visible = false;
        }

        row.style.display = visible ? '' : 'none';
        if (visible) {
            visibleCount++;
            if (row.dataset.materials === 'ready') readyCount++;
            if (row.dataset.materials === 'shortage') shortageCount++;
            if (row.dataset.status === 'DRAFT') draftCount++;
        }
    });

    document.getElementById('stat-ready').textContent = readyCount;
    document.getElementById('stat-shortage').textContent = shortageCount;
    document.getElementById('stat-draft').textContent = draftCount;
    document.getElementById('filter-count').textContent = `${visibleCount} of {{ boms_with_status|length }} shown`;
}

// Clear all filters
document.getElementById('clear-all-filters').addEventListener('click', function() {
    document.getElementById('global-search').value = '';
    document.querySelectorAll('[data-filter]').forEach(input => input.value = '');
    document.querySelectorAll('.level-filter, .materials-filter, .status-filter, .size-filter').forEach(cb => cb.checked = true);
    document.querySelectorAll('.th-filter').forEach(th => th.classList.remove('filtered'));
    filters.mat5 = ''; filters.hdbs = ''; filters.smi = ''; filters.mat34 = '';
    filters.level = ['3', '4']; filters.materials = ['ready', 'shortage', 'unknown']; filters.status = ['DRAFT', 'ACTIVE'];
    filters.size = [];  // Reset size filter
    applyAllFilters();
});

// Global search
document.getElementById('global-search').addEventListener('input', applyAllFilters);

// Delete modal
const deleteModal = document.getElementById('delete-modal');
document.querySelectorAll('.delete-bom-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.getElementById('delete-bom-code').textContent = this.dataset.bomCode;
        document.getElementById('delete-form').action = `/technology/boms/${this.dataset.bomId}/delete/`;
        deleteModal.classList.remove('hidden');
    });
});
document.getElementById('cancel-delete').addEventListener('click', () => deleteModal.classList.add('hidden'));
deleteModal.addEventListener('click', e => { if (e.target === deleteModal) deleteModal.classList.add('hidden'); });

// Populate size filter options
function populateSizeFilter() {
    const container = document.getElementById('size-filter-options');
    if (!container || availableSizes.length === 0) return;

    // Get unique sizes from visible rows
    const rowSizes = new Set();
    document.querySelectorAll('.bom-row').forEach(row => {
        const sizeDecimal = row.dataset.size;
        const sizeDisplay = row.dataset.sizeDisplay;
        if (sizeDecimal && sizeDisplay) {
            rowSizes.add(JSON.stringify({ decimal: sizeDecimal, display: sizeDisplay }));
        }
    });

    // Build checkbox list
    let html = '<label class="flex items-center px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer">' +
               '<input type="checkbox" class="size-filter mr-2" value="" checked onchange="applySizeFilter()"> (All)</label>';

    // Use available sizes if we have them, otherwise use sizes from rows
    const sizesToShow = availableSizes.length > 0 ? availableSizes :
        Array.from(rowSizes).map(s => JSON.parse(s)).sort((a, b) => parseFloat(a.decimal) - parseFloat(b.decimal));

    sizesToShow.forEach(size => {
        const value = size.decimal || size.id;
        html += `<label class="flex items-center px-2 py-1 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer">
                   <input type="checkbox" class="size-filter mr-2" value="${value}" checked onchange="applySizeFilter()"> ${size.display}
                 </label>`;
    });

    container.innerHTML = html;

    // Initialize filters.size with all sizes
    filters.size = Array.from(document.querySelectorAll('.size-filter:checked')).map(cb => cb.value);
}

// Size filter
function applySizeFilter() {
    const allCheckbox = document.querySelector('.size-filter[value=""]');
    const sizeCheckboxes = document.querySelectorAll('.size-filter:not([value=""])');

    if (allCheckbox && allCheckbox.checked) {
        // "All" is checked - include all sizes
        filters.size = [];
    } else {
        filters.size = Array.from(sizeCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
    }

    document.querySelector('[data-column="size"]').classList.toggle('filtered', filters.size.length > 0 && filters.size.length < availableSizes.length);
    applyAllFilters();
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    populateSizeFilter();
    applyAllFilters();
    if (typeof lucide !== 'undefined') lucide.createIcons();
});
</script>
{% endblock %}
