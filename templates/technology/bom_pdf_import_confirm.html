{% extends "base.html" %}

{% block title %}Import PDF - {{ bom.code }} - ARDT FMS{% endblock %}

{% block extra_css %}
<style>
    /* Cutter Grid Styles */
    .cutter-grid {
        display: grid;
        grid-template-columns: 40px repeat(5, 1fr);
        gap: 2px;
        font-size: 10px;
    }
    .grid-header {
        background: #1e3a5f;
        color: white;
        padding: 4px 2px;
        text-align: center;
        font-weight: 600;
        font-size: 9px;
    }
    .blade-label {
        background: #7c3aed;
        color: white;
        writing-mode: vertical-rl;
        text-orientation: mixed;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 11px;
        padding: 4px;
    }
    .row-group {
        display: contents;
    }
    .row-label {
        background: #4f46e5;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 10px;
    }
    .grid-cell {
        background: white;
        border: 1px solid #e5e7eb;
        min-height: 36px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        gap: 2px;
        padding: 2px;
        cursor: pointer;
        transition: all 0.15s;
    }
    .grid-cell:hover {
        background: #f0f9ff;
        border-color: #3b82f6;
    }
    .grid-cell.drop-target {
        background: #dbeafe;
        border: 2px dashed #3b82f6;
    }
    .cutter-chip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 18px;
        height: 18px;
        border-radius: 50%;
        color: white;
        font-weight: bold;
        font-size: 10px;
        cursor: grab;
        transition: transform 0.1s;
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .cutter-chip:hover {
        transform: scale(1.15);
    }
    .cutter-chip.dragging {
        opacity: 0.5;
    }

    /* BOM Line Row */
    .bom-line-row {
        transition: background 0.2s;
    }
    .bom-line-row:hover {
        background: #f0f9ff !important;
    }
    .bom-line-row.selected {
        background: #dbeafe !important;
        outline: 2px solid #3b82f6;
    }

    /* Editable cell styling */
    .editable-cell {
        cursor: text;
        padding: 2px 4px;
        border-radius: 4px;
        transition: background 0.15s;
    }
    .editable-cell:hover {
        background: #e5e7eb;
    }
    .editable-cell:focus {
        outline: 2px solid #3b82f6;
        background: white;
    }

    /* PDF Viewer */
    .pdf-viewer-container {
        height: calc(100vh - 200px);
        min-height: 500px;
        background: #374151;
        border-radius: 8px;
        overflow: hidden;
    }

    /* Tab styles */
    .tab-btn {
        padding: 8px 16px;
        border-bottom: 2px solid transparent;
        color: #6b7280;
        font-weight: 500;
        transition: all 0.15s;
    }
    .tab-btn:hover {
        color: #3b82f6;
    }
    .tab-btn.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
    }

    /* Sync indicator */
    .sync-badge {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
</style>
{% endblock %}

{% block page_header %}
<div class="flex flex-col md:flex-row md:items-start md:justify-between mb-4">
    <div>
        <div class="flex items-center gap-3">
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Interactive BOM Import</h1>
            {% if parsed_data.bom_lines %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                <i data-lucide="check" class="w-3.5 h-3.5 mr-1"></i>{{ parsed_data.bom_lines|length }} lines parsed
            </span>
            {% else %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">
                <i data-lucide="alert-triangle" class="w-3.5 h-3.5 mr-1"></i>No lines parsed
            </span>
            {% endif %}
        </div>
        <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">Review, edit, and sync data between BOM lines and cutter grid</p>
    </div>
    <div class="mt-4 md:mt-0 flex flex-wrap gap-2">
        <a href="{% url 'technology:bom_pdf_import' bom.pk %}" class="inline-flex items-center px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 border border-gray-300 rounded-lg">
            <i data-lucide="upload" class="w-4 h-4 mr-2"></i>Upload Different
        </a>
        <a href="{% url 'technology:bom_builder' bom.pk %}" class="inline-flex items-center px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 border border-gray-300 rounded-lg">
            <i data-lucide="x" class="w-4 h-4 mr-2"></i>Cancel
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div x-data="bomImportManager()" x-init="init()" class="space-y-4">
    <!-- View Mode Tabs -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm">
        <div class="flex border-b border-gray-200 dark:border-gray-700">
            <button type="button" @click="viewMode = 'split'"
                    :class="viewMode === 'split' ? 'active' : ''"
                    class="tab-btn flex items-center gap-2">
                <i data-lucide="columns" class="w-4 h-4"></i>
                Split View
            </button>
            <button type="button" @click="viewMode = 'pdf'"
                    :class="viewMode === 'pdf' ? 'active' : ''"
                    class="tab-btn flex items-center gap-2">
                <i data-lucide="file-text" class="w-4 h-4"></i>
                PDF Only
            </button>
            <button type="button" @click="viewMode = 'grid'"
                    :class="viewMode === 'grid' ? 'active' : ''"
                    class="tab-btn flex items-center gap-2">
                <i data-lucide="grid-3x3" class="w-4 h-4"></i>
                Grid Only
            </button>
            <button type="button" @click="viewMode = 'table'"
                    :class="viewMode === 'table' ? 'active' : ''"
                    class="tab-btn flex items-center gap-2">
                <i data-lucide="table" class="w-4 h-4"></i>
                Table Only
            </button>
            <button type="button" @click="showDebug = !showDebug"
                    class="tab-btn flex items-center gap-2 ml-auto"
                    :class="showDebug ? 'active' : ''">
                <i data-lucide="bug" class="w-4 h-4"></i>
                Debug
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="grid gap-4" :class="{
        'grid-cols-1 lg:grid-cols-2': viewMode === 'split',
        'grid-cols-1': viewMode !== 'split'
    }">
        <!-- PDF Viewer Panel -->
        <div x-show="viewMode === 'split' || viewMode === 'pdf'" x-cloak
             class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
            <div class="p-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                    <i data-lucide="file-text" class="w-4 h-4 text-red-500"></i>
                    Original PDF
                </h3>
                {% if bom.source_pdf_file %}
                <a href="{{ bom.source_pdf_file.url }}" target="_blank"
                   class="text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1">
                    <i data-lucide="external-link" class="w-3 h-3"></i>Open in new tab
                </a>
                {% endif %}
            </div>
            <div class="pdf-viewer-container">
                {% if bom.source_pdf_file %}
                <iframe src="{% url 'technology:bom_pdf_serve' bom.pk %}" class="w-full h-full border-0" title="BOM PDF"></iframe>
                {% else %}
                <div class="flex items-center justify-center h-full text-gray-400">
                    <div class="text-center">
                        <i data-lucide="file-x" class="w-16 h-16 mx-auto mb-2 opacity-50"></i>
                        <p>No PDF file available</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Data Panel (Grid + Table) -->
        <div x-show="viewMode === 'split' || viewMode === 'grid' || viewMode === 'table'" x-cloak
             class="space-y-4">

            <!-- Header Info Card -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                        <i data-lucide="info" class="w-4 h-4 text-blue-500"></i>
                        Parsed Header
                    </h3>
                    <span class="text-xs text-gray-500">Target: {{ bom.code }}</span>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                    <div>
                        <span class="text-gray-500 text-xs">Mat Number</span>
                        <p class="font-mono font-medium text-gray-900 dark:text-white">{{ parsed_data.header.mat_number|default:"-" }}</p>
                    </div>
                    <div>
                        <span class="text-gray-500 text-xs">SN Number</span>
                        <p class="font-mono text-gray-900 dark:text-white">{{ parsed_data.header.sn_number|default:"-" }}</p>
                    </div>
                    <div>
                        <span class="text-gray-500 text-xs">Revision</span>
                        <p class="text-gray-900 dark:text-white">{{ parsed_data.header.revision_level|default:"-" }}</p>
                    </div>
                    <div>
                        <span class="text-gray-500 text-xs">Date</span>
                        <p class="text-gray-900 dark:text-white">{{ parsed_data.header.date_created|default:"-" }}</p>
                    </div>
                </div>
            </div>

            <!-- Cutter Grid Card -->
            <div x-show="viewMode === 'split' || viewMode === 'grid'" x-cloak
                 class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                        <i data-lucide="grid-3x3" class="w-4 h-4 text-purple-500"></i>
                        Cutter Grid Layout
                        <span x-show="hasChanges" class="sync-badge inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-amber-100 text-amber-800">
                            <i data-lucide="refresh-cw" class="w-3 h-3 mr-1"></i>Modified
                        </span>
                    </h3>
                    <div class="flex gap-2">
                        <button type="button" @click="rebuildGridFromLines()"
                                class="text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200">
                            <i data-lucide="refresh-cw" class="w-3 h-3 inline mr-1"></i>Rebuild from BOM
                        </button>
                    </div>
                </div>

                <!-- Grid Structure: 7 blades x 4 rows x 5 locations -->
                <div class="overflow-x-auto">
                    <div class="min-w-[600px]">
                        <!-- Header Row -->
                        <div class="cutter-grid mb-1">
                            <div class="grid-header"></div>
                            <div class="grid-header">CONE</div>
                            <div class="grid-header">NOSE</div>
                            <div class="grid-header">SHOULDER</div>
                            <div class="grid-header">GAUGE</div>
                            <div class="grid-header">PAD</div>
                        </div>

                        <!-- Blade Rows -->
                        <template x-for="blade in 7" :key="'blade-'+blade">
                            <div class="mb-2">
                                <div class="flex items-center gap-1 mb-1">
                                    <span class="text-xs font-bold text-purple-600 w-8" x-text="'B' + blade"></span>
                                </div>
                                <template x-for="row in 4" :key="'row-'+blade+'-'+row">
                                    <div class="cutter-grid mb-px">
                                        <div class="row-label text-xs" x-text="'R' + row"></div>
                                        <template x-for="loc in ['CONE', 'NOSE', 'SHOULDER', 'GAUGE', 'PAD']" :key="loc">
                                            <div class="grid-cell"
                                                 :class="{
                                                     'ring-2 ring-blue-400': highlightedOrder && getCuttersAt(blade, row, loc).some(c => c.order_number === highlightedOrder),
                                                     'bg-blue-50': highlightedOrder && getCuttersAt(blade, row, loc).some(c => c.order_number === highlightedOrder)
                                                 }"
                                                 :data-blade="blade"
                                                 :data-row="row"
                                                 :data-location="loc"
                                                 @click="handleCellClick($event, blade, row, loc)"
                                                 @contextmenu.prevent="showCellMenu($event, blade, row, loc)"
                                                 @dragover.prevent="handleDragOver($event)"
                                                 @dragleave="handleDragLeave($event)"
                                                 @drop="handleDrop($event, blade, row, loc)">
                                                <template x-for="(cutter, idx) in getCuttersAt(blade, row, loc)" :key="idx">
                                                    <div class="cutter-chip group relative"
                                                         :style="'background-color: ' + getColorForOrder(cutter.order_number)"
                                                         draggable="true"
                                                         @dragstart="handleDragStart($event, blade, row, loc, idx)"
                                                         @dragend="handleDragEnd($event)"
                                                         @click.stop="showCutterDetails(cutter, blade, row, loc)"
                                                         @contextmenu.stop.prevent="showCutterMenu($event, cutter, blade, row, loc, idx)"
                                                         x-text="cutter.order_number">
                                                        <!-- Enhanced Tooltip -->
                                                        <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block z-50 pointer-events-none">
                                                            <div class="bg-gray-900 text-white text-xs rounded-lg px-3 py-2 whitespace-nowrap shadow-xl">
                                                                <div class="font-bold" x-text="cutter.cutter_type || 'Unknown'"></div>
                                                                <div class="text-gray-300" x-text="'Size: ' + (getLineForOrder(cutter.order_number)?.size || '-')"></div>
                                                                <div class="text-gray-300" x-text="'Chamfer: ' + (cutter.chamfer || '-')"></div>
                                                                <div class="text-gray-300" x-text="'Mat#: ' + (getLineForOrder(cutter.order_number)?.mat_number || '-')"></div>
                                                                <template x-if="getLineForOrder(cutter.order_number)?.inventory_item_code">
                                                                    <div class="text-green-400 flex items-center gap-1 mt-1 border-t border-gray-700 pt-1">
                                                                        <span>âœ“ Linked:</span>
                                                                        <span x-text="getLineForOrder(cutter.order_number)?.inventory_item_code"></span>
                                                                    </div>
                                                                </template>
                                                                <div class="text-blue-300 text-[10px] mt-1">Click for details</div>
                                                            </div>
                                                            <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                                        </div>
                                                    </div>
                                                </template>
                                                <!-- Empty cell indicator - click to add -->
                                                <template x-if="getCuttersAt(blade, row, loc).length === 0">
                                                    <span class="text-gray-300 text-[10px] opacity-0 group-hover:opacity-100 transition-opacity">+</span>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Context Menu (hidden, shown on right-click) -->
                <div x-show="contextMenu.show" x-cloak
                     :style="'left: ' + contextMenu.x + 'px; top: ' + contextMenu.y + 'px'"
                     @click.away="contextMenu.show = false"
                     class="fixed z-50 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 py-1 min-w-[160px]">
                    <template x-if="contextMenu.type === 'cell'">
                        <div>
                            <button @click="addCutterToCell()" class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-4 h-4 text-green-500"></i>Add Cutter Here
                            </button>
                            <button @click="clearCell()" class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                                <i data-lucide="trash" class="w-4 h-4 text-red-500"></i>Clear Cell
                            </button>
                        </div>
                    </template>
                    <template x-if="contextMenu.type === 'cutter'">
                        <div>
                            <button @click="editCutter()" class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                                <i data-lucide="edit" class="w-4 h-4 text-blue-500"></i>Edit Cutter
                            </button>
                            <button @click="duplicateCutter()" class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                                <i data-lucide="copy" class="w-4 h-4 text-purple-500"></i>Duplicate
                            </button>
                            <button @click="removeCutter()" class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2 text-red-600">
                                <i data-lucide="x-circle" class="w-4 h-4"></i>Remove
                            </button>
                        </div>
                    </template>
                </div>

                <!-- Add Cutter Dialog -->
                <div x-show="addCutterDialog.show" x-cloak
                     class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
                     @click.self="addCutterDialog.show = false">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 w-80">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <i data-lucide="plus-circle" class="w-5 h-5 text-green-500"></i>
                            Add Cutter
                            <span class="text-sm font-normal text-gray-500" x-text="'B' + addCutterDialog.blade + 'R' + addCutterDialog.row + ' ' + addCutterDialog.location"></span>
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Order #</label>
                                <select x-model.number="addCutterDialog.orderNumber"
                                        class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                                    <template x-for="line in bomLines" :key="line.order_number">
                                        <option :value="line.order_number" x-text="'#' + line.order_number + ' - ' + line.cutter_type"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="flex gap-2 pt-2">
                                <button @click="confirmAddCutter()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    Add
                                </button>
                                <button @click="addCutterDialog.show = false" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Lookup Modal -->
                <div x-show="inventoryLookup.show" x-cloak
                     class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
                     @click.self="inventoryLookup.show = false"
                     @keydown.escape.window="inventoryLookup.show = false">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 w-[500px] max-h-[80vh] flex flex-col">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <i data-lucide="search" class="w-5 h-5 text-blue-500"></i>
                            Search Inventory
                            <span class="text-sm font-normal text-gray-500" x-text="'for Order #' + (bomLines[inventoryLookup.lineIndex]?.order_number || '')"></span>
                        </h3>
                        <div class="space-y-4 flex-1 overflow-hidden flex flex-col">
                            <!-- Search Input -->
                            <div class="relative">
                                <input type="text" x-model="inventoryLookup.query"
                                       @input.debounce.300ms="searchInventory()"
                                       @keydown.enter.prevent="searchInventory()"
                                       placeholder="Search by code, name, or MAT number..."
                                       class="w-full px-4 py-2 pl-10 border rounded-lg dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-blue-500">
                                <i data-lucide="search" class="w-4 h-4 absolute left-3 top-3 text-gray-400"></i>
                            </div>

                            <!-- Auto-search from BOM line data -->
                            <div class="flex gap-2 text-xs">
                                <button type="button" @click="searchByLineData('type')"
                                        class="px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200">
                                    <span x-text="'Type: ' + (bomLines[inventoryLookup.lineIndex]?.cutter_type || '-')"></span>
                                </button>
                                <button type="button" @click="searchByLineData('size')"
                                        class="px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200">
                                    <span x-text="'Size: ' + (bomLines[inventoryLookup.lineIndex]?.size || '-')"></span>
                                </button>
                                <button type="button" @click="searchByLineData('mat')"
                                        class="px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
                                        x-show="bomLines[inventoryLookup.lineIndex]?.mat_number">
                                    <span x-text="'MAT#: ' + (bomLines[inventoryLookup.lineIndex]?.mat_number || '')"></span>
                                </button>
                            </div>

                            <!-- Results -->
                            <div class="flex-1 overflow-y-auto min-h-[200px] max-h-[300px] border rounded-lg dark:border-gray-700">
                                <template x-if="inventoryLookup.loading">
                                    <div class="flex items-center justify-center h-full text-gray-400">
                                        <i data-lucide="loader-2" class="w-6 h-6 animate-spin mr-2"></i>
                                        Searching...
                                    </div>
                                </template>
                                <template x-if="!inventoryLookup.loading && inventoryLookup.results.length === 0">
                                    <div class="flex items-center justify-center h-full text-gray-400">
                                        <div class="text-center">
                                            <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                            <p x-text="inventoryLookup.query ? 'No items found' : 'Enter search query'"></p>
                                        </div>
                                    </div>
                                </template>
                                <template x-if="!inventoryLookup.loading && inventoryLookup.results.length > 0">
                                    <div class="divide-y divide-gray-200 dark:divide-gray-700">
                                        <template x-for="item in inventoryLookup.results" :key="item.id">
                                            <button type="button"
                                                    @click="selectInventoryItem(item)"
                                                    class="w-full px-4 py-3 text-left hover:bg-blue-50 dark:hover:bg-gray-700 transition-colors">
                                                <div class="flex items-start justify-between">
                                                    <div class="flex-1">
                                                        <div class="font-medium text-gray-900 dark:text-white" x-text="item.code"></div>
                                                        <div class="text-sm text-gray-600 dark:text-gray-400 line-clamp-1" x-text="item.name"></div>
                                                    </div>
                                                    <div class="text-right text-xs text-gray-500 ml-2">
                                                        <div x-show="item.mat_number" x-text="'MAT: ' + item.mat_number" class="font-mono"></div>
                                                        <div x-show="item.category" x-text="item.category"></div>
                                                    </div>
                                                </div>
                                            </button>
                                        </template>
                                    </div>
                                </template>
                            </div>

                            <!-- Actions -->
                            <div class="flex gap-2 pt-2">
                                <button type="button" @click="inventoryLookup.show = false"
                                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grid Legend -->
                <div class="mt-3 flex flex-wrap gap-2 text-xs">
                    <span class="text-gray-500">Legend:</span>
                    <template x-for="line in bomLines" :key="line.order_number">
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full"
                              :style="'background-color: ' + line.color_code + '20; color: ' + line.color_code">
                            <span class="w-3 h-3 rounded-full" :style="'background-color: ' + line.color_code"></span>
                            <span x-text="line.order_number + ': ' + line.cutter_type"></span>
                            <template x-if="line.inventory_item_id">
                                <i data-lucide="link" class="w-3 h-3 text-green-600"></i>
                            </template>
                        </span>
                    </template>
                </div>
            </div>

            <!-- BOM Lines Table -->
            <div x-show="viewMode === 'split' || viewMode === 'table'" x-cloak
                 class="bg-white dark:bg-gray-800 rounded-xl shadow-sm">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                    <h3 class="font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                        <i data-lucide="list" class="w-4 h-4 text-green-500"></i>
                        BOM Lines
                        <span class="text-sm font-normal text-gray-500" x-text="'(' + bomLines.length + ' items, ' + totalCutters + ' cutters)'"></span>
                    </h3>
                    <button type="button" @click="addNewLine()"
                            class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200">
                        <i data-lucide="plus" class="w-3 h-3 inline mr-1"></i>Add Line
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-gray-500 bg-gray-50 dark:bg-gray-700/50 text-xs">
                                <th class="px-3 py-2 w-12">#</th>
                                <th class="px-3 py-2">Size</th>
                                <th class="px-3 py-2">Chamfer</th>
                                <th class="px-3 py-2">Type</th>
                                <th class="px-3 py-2 text-center w-20">Count</th>
                                <th class="px-3 py-2">Mat #</th>
                                <th class="px-3 py-2 w-16">Color</th>
                                <th class="px-3 py-2 w-12"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                            <template x-for="(line, index) in bomLines" :key="line.order_number">
                                <tr class="bom-line-row"
                                    :class="{'selected': selectedLine === line.order_number}"
                                    @click="selectLine(line.order_number)">
                                    <td class="px-3 py-2">
                                        <span class="w-6 h-6 inline-flex items-center justify-center rounded-full text-xs font-bold text-white"
                                              :style="'background-color: ' + line.color_code"
                                              x-text="line.order_number"></span>
                                    </td>
                                    <td class="px-3 py-2">
                                        <input type="text" x-model="line.size"
                                               @change="updateLine(index, 'size', line.size)"
                                               class="editable-cell w-16 bg-transparent font-mono">
                                    </td>
                                    <td class="px-3 py-2">
                                        <input type="text" x-model="line.chamfer"
                                               @change="updateLine(index, 'chamfer', line.chamfer)"
                                               class="editable-cell w-20 bg-transparent">
                                    </td>
                                    <td class="px-3 py-2">
                                        <input type="text" x-model="line.cutter_type"
                                               @change="updateLine(index, 'cutter_type', line.cutter_type)"
                                               class="editable-cell w-24 bg-transparent font-medium">
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        <input type="number" x-model.number="line.count" min="0"
                                               @change="updateLine(index, 'count', line.count)"
                                               class="editable-cell w-14 bg-transparent text-center font-bold text-blue-600">
                                    </td>
                                    <td class="px-3 py-2">
                                        <div class="flex items-center gap-1">
                                            <input type="text" x-model="line.mat_number"
                                                   @change="updateMatNumber(index, line.mat_number)"
                                                   class="editable-cell w-20 bg-transparent font-mono text-gray-500"
                                                   title="Changes here will update all matching items">
                                            <button type="button" @click.stop="openInventoryLookup(index)"
                                                    class="p-1 text-blue-500 hover:text-blue-700 hover:bg-blue-50 rounded"
                                                    title="Search Inventory">
                                                <i data-lucide="search" class="w-3.5 h-3.5"></i>
                                            </button>
                                            <template x-if="line.inventory_item_id">
                                                <span class="text-green-500" title="Linked to inventory">
                                                    <i data-lucide="link" class="w-3 h-3"></i>
                                                </span>
                                            </template>
                                        </div>
                                    </td>
                                    <td class="px-3 py-2">
                                        <input type="color" x-model="line.color_code"
                                               @change="updateLine(index, 'color_code', line.color_code)"
                                               class="w-6 h-6 rounded cursor-pointer">
                                    </td>
                                    <td class="px-3 py-2">
                                        <button type="button" @click.stop="deleteLine(index)"
                                                class="text-red-400 hover:text-red-600">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-50 dark:bg-gray-700/50 font-medium">
                                <td colspan="4" class="px-3 py-2 text-right text-gray-600 dark:text-gray-400">Total Cutters:</td>
                                <td class="px-3 py-2 text-center text-lg font-bold text-green-600" x-text="totalCutters"></td>
                                <td colspan="3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Panel -->
    <div x-show="showDebug" x-cloak class="bg-gray-900 rounded-xl shadow-sm p-4 text-white">
        <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold flex items-center gap-2">
                <i data-lucide="bug" class="w-4 h-4 text-amber-400"></i>
                Debug: Raw Extracted Text
            </h3>
            <button @click="showDebug = false" class="text-gray-400 hover:text-white">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
        <pre class="text-xs font-mono bg-gray-800 p-3 rounded overflow-auto max-h-64 whitespace-pre-wrap">{{ parsed_data.raw_text|default:"No raw text captured" }}</pre>
    </div>

    <!-- Import Actions -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4">
        <form method="post" class="flex flex-wrap items-center justify-between gap-4">
            {% csrf_token %}

            <div class="flex items-center gap-4">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="clear_existing" value="yes"
                           class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="text-sm text-gray-700 dark:text-gray-300">Clear existing BOM lines before import</span>
                </label>

                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="import_grid" value="yes" checked
                           class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="text-sm text-gray-700 dark:text-gray-300">Import grid positions</span>
                </label>
            </div>

            <!-- Hidden inputs to pass modified data -->
            <input type="hidden" name="bom_lines_json" :value="JSON.stringify(bomLines)">
            <input type="hidden" name="cutter_positions_json" :value="JSON.stringify(cutterPositions)">

            <div class="flex gap-2">
                <button type="submit"
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center gap-2">
                    <i data-lucide="check" class="w-5 h-5"></i>
                    Confirm Import
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function bomImportManager() {
    return {
        viewMode: 'split',
        showDebug: false,
        hasChanges: false,
        selectedLine: null,
        highlightedOrder: null,
        draggedCutter: null,

        // Context menu state
        contextMenu: {
            show: false,
            x: 0,
            y: 0,
            type: 'cell', // 'cell' or 'cutter'
            blade: 0,
            row: 0,
            location: '',
            cutter: null,
            cutterIdx: -1
        },

        // Add cutter dialog
        addCutterDialog: {
            show: false,
            blade: 0,
            row: 0,
            location: '',
            orderNumber: 1
        },

        // Inventory lookup modal
        inventoryLookup: {
            show: false,
            lineIndex: -1,
            query: '',
            results: [],
            loading: false
        },

        // Data from parsed PDF (properly serialized JSON)
        bomLines: {{ bom_lines_json|safe }},
        cutterPositions: {{ cutter_positions_json|safe }},

        // Color palette matching the parser
        colorPalette: [
            "#4A4A4A", "#9E9E9E", "#6B6B6B", "#E0E0E0", "#2196F3",
            "#FF9800", "#4CAF50", "#9C27B0", "#F44336", "#00BCD4"
        ],

        init() {
            if (this.cutterPositions.length === 0 && this.bomLines.length > 0) {
                console.log('No grid positions parsed, showing empty grid');
            }
            this.$nextTick(() => lucide.createIcons());
        },

        get totalCutters() {
            return this.bomLines.reduce((sum, line) => sum + (parseInt(line.count) || 0), 0);
        },

        get gridCutterCount() {
            return this.cutterPositions.length;
        },

        getColorForOrder(orderNum) {
            const line = this.bomLines.find(l => l.order_number === orderNum);
            if (line) return line.color_code;
            const idx = (orderNum - 1) % this.colorPalette.length;
            return this.colorPalette[idx];
        },

        getLineForOrder(orderNum) {
            return this.bomLines.find(l => l.order_number === orderNum);
        },

        getCuttersAt(blade, row, location) {
            return this.cutterPositions.filter(p =>
                p.blade_number === blade &&
                p.row_number === row &&
                p.location === location
            ).sort((a, b) => a.position_in_location - b.position_in_location);
        },

        selectLine(orderNum) {
            this.selectedLine = this.selectedLine === orderNum ? null : orderNum;
            this.highlightedOrder = this.selectedLine;
        },

        highlightLine(orderNum) {
            this.highlightedOrder = orderNum;
        },

        unhighlightLine() {
            if (!this.selectedLine) {
                this.highlightedOrder = null;
            }
        },

        updateLine(index, field, value) {
            this.hasChanges = true;
            if (field === 'cutter_type') {
                this.cutterPositions.forEach(pos => {
                    if (pos.order_number === this.bomLines[index].order_number) {
                        pos.cutter_type = value;
                    }
                });
            }
            if (field === 'chamfer') {
                this.cutterPositions.forEach(pos => {
                    if (pos.order_number === this.bomLines[index].order_number) {
                        pos.chamfer = value;
                    }
                });
            }
        },

        updateMatNumber(index, newMatNumber) {
            const cutterType = this.bomLines[index].cutter_type;
            this.bomLines.forEach(line => {
                if (line.cutter_type === cutterType) {
                    line.mat_number = newMatNumber;
                }
            });
            this.hasChanges = true;
        },

        addNewLine() {
            const maxOrder = Math.max(0, ...this.bomLines.map(l => l.order_number));
            const newOrder = maxOrder + 1;
            const colorIdx = (newOrder - 1) % this.colorPalette.length;

            this.bomLines.push({
                order_number: newOrder,
                size: '',
                chamfer: '',
                cutter_type: '',
                count: 0,
                mat_number: '',
                family_number: '',
                color_code: this.colorPalette[colorIdx]
            });
            this.hasChanges = true;
            this.$nextTick(() => lucide.createIcons());
        },

        deleteLine(index) {
            if (confirm('Delete this line? Grid positions for this order will also be removed.')) {
                const orderNum = this.bomLines[index].order_number;
                this.bomLines.splice(index, 1);
                this.cutterPositions = this.cutterPositions.filter(p => p.order_number !== orderNum);
                this.bomLines.forEach((line, idx) => {
                    line.order_number = idx + 1;
                });
                this.hasChanges = true;
            }
        },

        rebuildGridFromLines() {
            if (confirm('This will clear the current grid and distribute cutters based on BOM line counts. Continue?')) {
                this.cutterPositions = [];
                const locations = ['CONE', 'NOSE', 'SHOULDER', 'GAUGE', 'PAD'];

                this.bomLines.forEach(line => {
                    let remaining = line.count;
                    let posIndex = 1;

                    for (let blade = 1; blade <= 7 && remaining > 0; blade++) {
                        for (let row = 1; row <= 4 && remaining > 0; row++) {
                            for (let loc of locations) {
                                if (remaining <= 0) break;
                                this.cutterPositions.push({
                                    blade_number: blade,
                                    row_number: row,
                                    location: loc,
                                    position_in_location: posIndex++,
                                    cutter_type: line.cutter_type,
                                    order_number: line.order_number,
                                    chamfer: line.chamfer
                                });
                                remaining--;
                            }
                        }
                    }
                });

                this.hasChanges = true;
            }
        },

        // Cell click - open add dialog if empty
        handleCellClick(event, blade, row, location) {
            const cutters = this.getCuttersAt(blade, row, location);
            if (cutters.length === 0 && this.bomLines.length > 0) {
                this.addCutterDialog.blade = blade;
                this.addCutterDialog.row = row;
                this.addCutterDialog.location = location;
                this.addCutterDialog.orderNumber = this.bomLines[0]?.order_number || 1;
                this.addCutterDialog.show = true;
                this.$nextTick(() => lucide.createIcons());
            }
        },

        // Context menus
        showCellMenu(event, blade, row, location) {
            this.contextMenu = {
                show: true,
                x: event.clientX,
                y: event.clientY,
                type: 'cell',
                blade, row, location,
                cutter: null,
                cutterIdx: -1
            };
            this.$nextTick(() => lucide.createIcons());
        },

        showCutterMenu(event, cutter, blade, row, location, idx) {
            this.contextMenu = {
                show: true,
                x: event.clientX,
                y: event.clientY,
                type: 'cutter',
                blade, row, location,
                cutter,
                cutterIdx: idx
            };
            this.$nextTick(() => lucide.createIcons());
        },

        showCutterDetails(cutter, blade, row, location) {
            const line = this.getLineForOrder(cutter.order_number);
            alert(`Cutter Details:\n\nPosition: B${blade}R${row} ${location}\nOrder #: ${cutter.order_number}\nType: ${cutter.cutter_type || line?.cutter_type || 'Unknown'}\nSize: ${line?.size || '-'}\nChamfer: ${cutter.chamfer || line?.chamfer || '-'}\nMat #: ${line?.mat_number || '-'}`);
        },

        addCutterToCell() {
            this.contextMenu.show = false;
            this.addCutterDialog.blade = this.contextMenu.blade;
            this.addCutterDialog.row = this.contextMenu.row;
            this.addCutterDialog.location = this.contextMenu.location;
            this.addCutterDialog.orderNumber = this.bomLines[0]?.order_number || 1;
            this.addCutterDialog.show = true;
            this.$nextTick(() => lucide.createIcons());
        },

        confirmAddCutter() {
            const line = this.getLineForOrder(this.addCutterDialog.orderNumber);
            const existing = this.getCuttersAt(
                this.addCutterDialog.blade,
                this.addCutterDialog.row,
                this.addCutterDialog.location
            );

            this.cutterPositions.push({
                blade_number: this.addCutterDialog.blade,
                row_number: this.addCutterDialog.row,
                location: this.addCutterDialog.location,
                position_in_location: existing.length + 1,
                cutter_type: line?.cutter_type || '',
                order_number: this.addCutterDialog.orderNumber,
                chamfer: line?.chamfer || ''
            });

            this.addCutterDialog.show = false;
            this.hasChanges = true;
        },

        clearCell() {
            this.contextMenu.show = false;
            const { blade, row, location } = this.contextMenu;
            this.cutterPositions = this.cutterPositions.filter(p =>
                !(p.blade_number === blade && p.row_number === row && p.location === location)
            );
            this.hasChanges = true;
        },

        editCutter() {
            this.contextMenu.show = false;
            const line = this.getLineForOrder(this.contextMenu.cutter?.order_number);
            if (line) {
                this.selectedLine = line.order_number;
                this.highlightedOrder = line.order_number;
            }
        },

        duplicateCutter() {
            this.contextMenu.show = false;
            const { cutter, blade, row, location } = this.contextMenu;
            const existing = this.getCuttersAt(blade, row, location);

            this.cutterPositions.push({
                blade_number: blade,
                row_number: row,
                location: location,
                position_in_location: existing.length + 1,
                cutter_type: cutter.cutter_type,
                order_number: cutter.order_number,
                chamfer: cutter.chamfer
            });

            this.hasChanges = true;
        },

        removeCutter() {
            this.contextMenu.show = false;
            const { blade, row, location, cutter } = this.contextMenu;

            const idx = this.cutterPositions.findIndex(p =>
                p.blade_number === blade &&
                p.row_number === row &&
                p.location === location &&
                p.position_in_location === cutter.position_in_location
            );

            if (idx !== -1) {
                this.cutterPositions.splice(idx, 1);
                this.hasChanges = true;
            }
        },

        // Drag and drop handlers
        handleDragStart(event, blade, row, location, idx) {
            this.draggedCutter = { blade, row, location, idx };
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
        },

        handleDragEnd(event) {
            event.target.classList.remove('dragging');
            this.draggedCutter = null;
        },

        handleDragOver(event) {
            event.currentTarget.classList.add('drop-target');
        },

        handleDragLeave(event) {
            event.currentTarget.classList.remove('drop-target');
        },

        handleDrop(event, targetBlade, targetRow, targetLocation) {
            event.currentTarget.classList.remove('drop-target');

            if (!this.draggedCutter) return;

            const { blade, row, location, idx } = this.draggedCutter;
            const cutters = this.getCuttersAt(blade, row, location);
            if (idx >= cutters.length) return;

            const cutter = cutters[idx];
            const cutterIndex = this.cutterPositions.findIndex(p =>
                p.blade_number === blade &&
                p.row_number === row &&
                p.location === location &&
                p.position_in_location === cutter.position_in_location
            );

            if (cutterIndex === -1) return;

            this.cutterPositions[cutterIndex].blade_number = targetBlade;
            this.cutterPositions[cutterIndex].row_number = targetRow;
            this.cutterPositions[cutterIndex].location = targetLocation;
            this.cutterPositions[cutterIndex].position_in_location =
                this.getCuttersAt(targetBlade, targetRow, targetLocation).length + 1;

            this.hasChanges = true;
            this.draggedCutter = null;
        },

        // Inventory lookup functions
        openInventoryLookup(lineIndex) {
            this.inventoryLookup.lineIndex = lineIndex;
            this.inventoryLookup.query = '';
            this.inventoryLookup.results = [];
            this.inventoryLookup.loading = false;
            this.inventoryLookup.show = true;
            this.$nextTick(() => {
                lucide.createIcons();
                // Focus search input
                const input = document.querySelector('[x-model="inventoryLookup.query"]');
                if (input) input.focus();
            });
        },

        searchByLineData(field) {
            const line = this.bomLines[this.inventoryLookup.lineIndex];
            if (!line) return;

            switch (field) {
                case 'type':
                    this.inventoryLookup.query = line.cutter_type || '';
                    break;
                case 'size':
                    this.inventoryLookup.query = line.size || '';
                    break;
                case 'mat':
                    this.inventoryLookup.query = line.mat_number || '';
                    break;
            }
            this.searchInventory();
        },

        async searchInventory() {
            const query = this.inventoryLookup.query.trim();
            if (query.length < 2) {
                this.inventoryLookup.results = [];
                return;
            }

            this.inventoryLookup.loading = true;
            try {
                const response = await fetch(`/inventory/api/items/lookup/?q=${encodeURIComponent(query)}&limit=15`);
                if (response.ok) {
                    const data = await response.json();
                    this.inventoryLookup.results = data || [];
                } else {
                    this.inventoryLookup.results = [];
                }
            } catch (error) {
                console.error('Inventory search error:', error);
                this.inventoryLookup.results = [];
            } finally {
                this.inventoryLookup.loading = false;
                this.$nextTick(() => lucide.createIcons());
            }
        },

        selectInventoryItem(item) {
            const lineIndex = this.inventoryLookup.lineIndex;
            if (lineIndex < 0 || lineIndex >= this.bomLines.length) return;

            const line = this.bomLines[lineIndex];

            // Update the line with inventory item data
            line.mat_number = item.mat_number || item.code;
            line.inventory_item_id = item.id;
            line.inventory_item_code = item.code;
            line.inventory_item_name = item.name;

            // Propagate to lines with same cutter type
            const cutterType = line.cutter_type;
            this.bomLines.forEach((l, idx) => {
                if (idx !== lineIndex && l.cutter_type === cutterType) {
                    l.mat_number = item.mat_number || item.code;
                    l.inventory_item_id = item.id;
                    l.inventory_item_code = item.code;
                    l.inventory_item_name = item.name;
                }
            });

            this.hasChanges = true;
            this.inventoryLookup.show = false;
            this.$nextTick(() => lucide.createIcons());
        }
    };
}
</script>
{% endblock %}
