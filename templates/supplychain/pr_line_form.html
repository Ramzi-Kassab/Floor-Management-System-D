{% extends "base.html" %}

{% block title %}{{ page_title }} - ARDT FMS{% endblock %}

{% block page_header %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Add Line Item</h1>
        <p class="text-gray-600 dark:text-gray-400">{{ pr.requisition_number }} - {{ pr.title }}</p>
    </div>
    <a href="{% url 'supplychain:pr_detail' pr.pk %}" class="inline-flex items-center px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800">
        <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>Back to PR
    </a>
</div>
{% endblock %}

{% block content %}
<div class="max-w-4xl">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
        <form method="post" id="prLineForm">
            {% csrf_token %}

            <div class="space-y-6">
                <!-- Item Selection Section -->
                <div class="border-b border-gray-200 dark:border-gray-700 pb-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Select Item</h3>

                    <!-- Selected Item Display -->
                    <div id="selectedItemDisplay" class="hidden mb-4 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium text-blue-900 dark:text-blue-100" id="selectedItemCode"></p>
                                <p class="text-sm text-blue-700 dark:text-blue-300" id="selectedItemName"></p>
                                <p class="text-xs text-blue-600 dark:text-blue-400 mt-1">
                                    <span id="selectedItemCategory"></span> â€¢ <span id="selectedItemUom"></span>
                                </p>
                            </div>
                            <button type="button" onclick="clearItemSelection()" class="text-blue-600 hover:text-blue-800 p-1">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Hidden field for selected item -->
                    <input type="hidden" name="inventory_item" id="id_inventory_item" value="{{ form.inventory_item.value|default:'' }}">

                    <!-- Search and Filter Row -->
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <!-- Category Filter -->
                        <div class="md:w-1/3">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Category</label>
                            <select id="categoryFilter" onchange="searchItems()"
                                    class="w-full px-3 py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">All Categories</option>
                                {% for cat in categories %}
                                <option value="{{ cat.id }}">{{ cat.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Search Input -->
                        <div class="md:w-2/3">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Search Items</label>
                            <div class="relative">
                                <input type="text" id="itemSearch"
                                       placeholder="Search by code, name, HDBS, ERP number..."
                                       oninput="debounceSearch()"
                                       class="w-full px-4 py-2.5 pl-10 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                                <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                        <div class="max-h-80 overflow-y-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 dark:bg-gray-900 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Code</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Name</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase hidden md:table-cell">Category</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">UoM</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase w-20">Select</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr>
                                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                            <i data-lucide="search" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                            <p>Start typing to search for items...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Or enter manually -->
                    <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <button type="button" onclick="toggleManualEntry()" class="text-sm text-blue-600 hover:text-blue-800">
                            <i data-lucide="edit-3" class="w-4 h-4 inline mr-1"></i>
                            Or enter item manually (for non-inventory items)
                        </button>
                    </div>
                </div>

                <!-- Manual Entry Section (hidden by default) -->
                <div id="manualEntrySection" class="hidden border-b border-gray-200 dark:border-gray-700 pb-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Manual Item Entry</h3>
                    <div>
                        <label for="id_item_description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Item Description <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="item_description" id="id_item_description"
                               value="{{ form.item_description.value|default:'' }}"
                               class="w-full px-4 py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500"
                               placeholder="Description of item or service needed">
                        {% if form.item_description.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.item_description.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">Use this for items not in inventory (services, custom items, etc.)</p>
                    </div>
                    <button type="button" onclick="toggleManualEntry()" class="mt-3 text-sm text-blue-600 hover:text-blue-800">
                        <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i>
                        Back to item search
                    </button>
                </div>

                <!-- Quantity and Details -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Quantity & Details</h3>

                    <!-- Quantity and UoM -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="id_quantity_requested" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Quantity <span class="text-red-500">*</span>
                            </label>
                            <input type="number" name="quantity_requested" id="id_quantity_requested"
                                   value="{{ form.quantity_requested.value|default:'' }}"
                                   step="0.001" min="0.001"
                                   class="w-full px-4 py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500"
                                   placeholder="0.00"
                                   required>
                            {% if form.quantity_requested.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ form.quantity_requested.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div>
                            <label for="id_unit_of_measure" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Unit of Measure <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="unit_of_measure" id="id_unit_of_measure"
                                   value="{{ form.unit_of_measure.value|default:'' }}"
                                   class="w-full px-4 py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500"
                                   placeholder="EA, BOX, KG, etc."
                                   required>
                            {% if form.unit_of_measure.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ form.unit_of_measure.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Estimated Price -->
                    <div class="mb-4">
                        <label for="id_estimated_unit_price" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Estimated Unit Price (SAR)
                        </label>
                        <input type="number" name="estimated_unit_price" id="id_estimated_unit_price"
                               value="{{ form.estimated_unit_price.value|default:'' }}"
                               step="0.01" min="0"
                               class="w-full px-4 py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500"
                               placeholder="0.00">
                        <p class="text-xs text-gray-500 mt-1">Optional - for budget estimation</p>
                        {% if form.estimated_unit_price.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.estimated_unit_price.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Notes -->
                    <div>
                        <label for="id_notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Notes
                        </label>
                        <textarea name="notes" id="id_notes" rows="2"
                                  class="w-full px-4 py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500"
                                  placeholder="Any additional notes or specifications...">{{ form.notes.value|default:'' }}</textarea>
                        {% if form.notes.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.notes.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-between items-center mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                <a href="{% url 'supplychain:pr_detail' pr.pk %}" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900">
                    Cancel
                </a>
                <div class="space-x-3">
                    <button type="submit" name="add_another" value="1" class="px-4 py-2 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50">
                        Add & Add Another
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Add Line
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
let searchTimeout = null;
let selectedItem = null;

function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(searchItems, 300);
}

function searchItems() {
    const query = document.getElementById('itemSearch').value;
    const categoryId = document.getElementById('categoryFilter').value;

    if (query.length < 2 && !categoryId) {
        document.getElementById('itemsTableBody').innerHTML = `
            <tr>
                <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                    <svg class="w-8 h-8 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <p>Enter at least 2 characters to search...</p>
                </td>
            </tr>
        `;
        return;
    }

    // Show loading
    document.getElementById('itemsTableBody').innerHTML = `
        <tr>
            <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                <svg class="animate-spin h-6 w-6 mx-auto mb-2" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p>Searching...</p>
            </td>
        </tr>
    `;

    let url = '/inventory/api/items/lookup/?limit=50';
    if (query) url += `&q=${encodeURIComponent(query)}`;
    if (categoryId) url += `&category=${categoryId}`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            renderItems(data.items || []);
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('itemsTableBody').innerHTML = `
                <tr>
                    <td colspan="5" class="px-4 py-8 text-center text-red-500">
                        Error loading items. Please try again.
                    </td>
                </tr>
            `;
        });
}

function renderItems(items) {
    const tbody = document.getElementById('itemsTableBody');

    if (items.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                    <svg class="w-8 h-8 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p>No items found matching your search</p>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = items.map(item => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer ${selectedItem && selectedItem.id === item.id ? 'bg-blue-50 dark:bg-blue-900/20' : ''}"
            onclick="selectItem(${JSON.stringify(item).replace(/"/g, '&quot;')})">
            <td class="px-4 py-3">
                <span class="font-mono text-sm font-medium text-gray-900 dark:text-white">${item.code}</span>
            </td>
            <td class="px-4 py-3">
                <span class="text-sm text-gray-900 dark:text-white">${item.name}</span>
                ${item.description ? `<p class="text-xs text-gray-500 truncate max-w-xs">${item.description}</p>` : ''}
            </td>
            <td class="px-4 py-3 hidden md:table-cell">
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                    ${item.category || '-'}
                </span>
            </td>
            <td class="px-4 py-3">
                <span class="text-sm text-gray-600 dark:text-gray-400">${item.uom || '-'}</span>
            </td>
            <td class="px-4 py-3 text-center">
                <button type="button" onclick="event.stopPropagation(); selectItem(${JSON.stringify(item).replace(/"/g, '&quot;')})"
                        class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">
                    Select
                </button>
            </td>
        </tr>
    `).join('');
}

function selectItem(item) {
    selectedItem = item;

    // Update hidden field
    document.getElementById('id_inventory_item').value = item.id;

    // Update display
    document.getElementById('selectedItemCode').textContent = item.code;
    document.getElementById('selectedItemName').textContent = item.name;
    document.getElementById('selectedItemCategory').textContent = item.category || 'No category';
    document.getElementById('selectedItemUom').textContent = item.uom ? `UoM: ${item.uom}` : '';
    document.getElementById('selectedItemDisplay').classList.remove('hidden');

    // Auto-fill description and UoM
    document.getElementById('id_item_description').value = `${item.code} - ${item.name}`;
    if (item.uom) {
        document.getElementById('id_unit_of_measure').value = item.uom;
    }

    // Hide manual entry if visible
    document.getElementById('manualEntrySection').classList.add('hidden');

    // Re-render table to show selection
    searchItems();

    // Re-initialize icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

function clearItemSelection() {
    selectedItem = null;
    document.getElementById('id_inventory_item').value = '';
    document.getElementById('selectedItemDisplay').classList.add('hidden');
    document.getElementById('id_item_description').value = '';
    document.getElementById('id_unit_of_measure').value = '';
    searchItems();
}

function toggleManualEntry() {
    const section = document.getElementById('manualEntrySection');
    const itemSelector = document.querySelector('.border-b.border-gray-200.dark\\:border-gray-700.pb-6');

    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        // Clear item selection when switching to manual
        clearItemSelection();
    } else {
        section.classList.add('hidden');
    }
}

// Form validation
document.getElementById('prLineForm').addEventListener('submit', function(e) {
    const inventoryItem = document.getElementById('id_inventory_item').value;
    const itemDescription = document.getElementById('id_item_description').value.trim();

    if (!inventoryItem && !itemDescription) {
        e.preventDefault();
        alert('Please select an item from the list or enter a description manually.');
        return false;
    }
});

// Initialize - load some items on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check if there's a pre-selected item
    const inventoryItemId = document.getElementById('id_inventory_item').value;
    if (inventoryItemId) {
        // TODO: Load the selected item details
    }
});
</script>
{% endblock %}
