{% extends "base.html" %}
{% load static role_tags %}

{% block title %}{{ page_title }} | ARDT FMS{% endblock %}

{% block content %}
<!-- Tailwind safelist: These classes are dynamically applied via JavaScript -->
<!-- Ring colors for color selection highlighting -->
<div class="hidden">
    <span class="ring-blue-500 ring-indigo-500 ring-purple-500 ring-pink-500 ring-red-500"></span>
    <span class="ring-orange-500 ring-amber-500 ring-yellow-500 ring-lime-500 ring-green-500"></span>
    <span class="ring-teal-500 ring-cyan-500 ring-sky-500 ring-slate-500 ring-gray-500"></span>
</div>
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <div class="flex items-center space-x-2">
                <a href="{% if dashboard_type == 'manager' %}{% url 'dashboard:manager' %}{% elif dashboard_type == 'planner' %}{% url 'dashboard:planner' %}{% elif dashboard_type == 'technician' %}{% url 'dashboard:technician' %}{% elif dashboard_type == 'qc' %}{% url 'dashboard:qc' %}{% elif dashboard_type|slice:':6' == 'saved_' %}{% url 'dashboard:saved_view' dashboard_type|slice:'6:' %}{% else %}{% url 'dashboard:main' %}{% endif %}" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </a>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{ page_title }}</h1>
            </div>
            <p class="text-gray-600 dark:text-gray-400 mt-1">Drag and drop widgets to customize your dashboard layout</p>
        </div>
        <div class="flex items-center space-x-3">
            <span class="text-sm text-gray-500 dark:text-gray-400">
                {{ active_widget_count }} of {{ total_widgets }} widgets active
            </span>
            <a href="{% if dashboard_type == 'main' %}{% url 'dashboard:reset_dashboard' %}{% else %}{% url 'dashboard:reset_dashboard_type' dashboard_type %}{% endif %}"
               onclick="return confirm('Are you sure you want to reset to the default layout?')"
               class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <i data-lucide="rotate-ccw" class="w-4 h-4 mr-2"></i>
                Reset to Default
            </a>
            <button type="button" id="save-layout-btn"
                    class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                Save Layout
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Active Widgets (Draggable Area) -->
        <div class="lg:col-span-2">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Active Widgets</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Drag to reorder. Click <i data-lucide="settings" class="w-3 h-3 inline"></i> to customize style.</p>

                <div id="active-widgets" class="space-y-3 min-h-[200px]">
                    {% for widget in current_layout %}
                    {% if widget.visible %}
                    <div class="widget-card bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg p-4 cursor-move"
                         data-widget-id="{{ widget.id }}"
                         data-visible="true"
                         data-color="{{ widget.color|default:'blue' }}"
                         data-intensity="{{ widget.color_intensity|default:'medium' }}"
                         data-bg-style="{{ widget.bg_style|default:'solid' }}"
                         data-border-style="{{ widget.border_style|default:'none' }}"
                         data-border-size="{{ widget.border_size|default:'medium' }}"
                         data-text-size="{{ widget.text_size|default:'normal' }}"
                         data-border-radius="{{ widget.border_radius|default:'rounded' }}"
                         data-show-header="{{ widget.show_header|default:'true' }}"
                         draggable="true">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="drag-handle p-1 text-gray-400 cursor-grab hover:text-gray-600 dark:hover:text-gray-300">
                                    <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                                </div>
                                <div class="widget-icon-preview flex-shrink-0 w-10 h-10 rounded-lg bg-{{ widget.color|default:'blue' }}-100 dark:bg-{{ widget.color|default:'blue' }}-900/30 flex items-center justify-center">
                                    <i data-lucide="{{ widget.icon }}" class="w-5 h-5 text-{{ widget.color|default:'blue' }}-600 dark:text-{{ widget.color|default:'blue' }}-400"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900 dark:text-white">{{ widget.name }}</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">{{ widget.description }}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <!-- Size Select -->
                                <select class="size-select text-xs px-2 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 focus:ring-blue-500 focus:border-blue-500"
                                        data-widget-id="{{ widget.id }}">
                                    <option value="small" {% if widget.size == "small" %}selected{% endif %}>Small</option>
                                    <option value="medium" {% if widget.size == "medium" %}selected{% endif %}>Medium</option>
                                    <option value="large" {% if widget.size == "large" %}selected{% endif %}>Large</option>
                                    <option value="full" {% if widget.size == "full" %}selected{% endif %}>Full Width</option>
                                </select>
                                <!-- Settings Button -->
                                <div class="relative" x-data="{ open: false }">
                                    <button @click="open = !open" type="button"
                                            class="widget-settings p-2 text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                                            title="Widget settings">
                                        <i data-lucide="settings" class="w-4 h-4"></i>
                                    </button>
                                    <!-- Settings Dropdown -->
                                    <div x-show="open" @click.away="open = false"
                                         x-transition:enter="transition ease-out duration-100"
                                         x-transition:enter-start="opacity-0 scale-95"
                                         x-transition:enter-end="opacity-100 scale-100"
                                         x-transition:leave="transition ease-in duration-75"
                                         x-transition:leave-start="opacity-100 scale-100"
                                         x-transition:leave-end="opacity-0 scale-95"
                                         class="absolute right-0 mt-2 w-72 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 z-50 p-4"
                                         style="display: none;">
                                        <h4 class="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                                            <i data-lucide="palette" class="w-4 h-4 mr-2"></i>
                                            Widget Style
                                        </h4>

                                        <!-- Color Theme -->
                                        <div class="mb-4">
                                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Color Theme</label>
                                            <div class="flex flex-wrap gap-2">
                                                <button type="button" class="color-option w-7 h-7 rounded-full bg-blue-500 hover:ring-2 hover:ring-offset-2 hover:ring-blue-500 transition-all" data-color="blue" title="Blue"></button>
                                                <button type="button" class="color-option w-7 h-7 rounded-full bg-indigo-500 hover:ring-2 hover:ring-offset-2 hover:ring-indigo-500 transition-all" data-color="indigo" title="Indigo"></button>
                                                <button type="button" class="color-option w-7 h-7 rounded-full bg-purple-500 hover:ring-2 hover:ring-offset-2 hover:ring-purple-500 transition-all" data-color="purple" title="Purple"></button>
                                                <button type="button" class="color-option w-7 h-7 rounded-full bg-pink-500 hover:ring-2 hover:ring-offset-2 hover:ring-pink-500 transition-all" data-color="pink" title="Pink"></button>
                                                <button type="button" class="color-option w-7 h-7 rounded-full bg-red-500 hover:ring-2 hover:ring-offset-2 hover:ring-red-500 transition-all" data-color="red" title="Red"></button>
                                                <button type="button" class="color-option w-7 h-7 rounded-full bg-orange-500 hover:ring-2 hover:ring-offset-2 hover:ring-orange-500 transition-all" data-color="orange" title="Orange"></button>
                                                <button type="button" class="color-option w-7 h-7 rounded-full bg-amber-500 hover:ring-2 hover:ring-offset-2 hover:ring-amber-500 transition-all" data-color="amber" title="Amber"></button>
                                                <button type="button" class="color-option w-7 h-7 rounded-full bg-yellow-500 hover:ring-2 hover:ring-offset-2 hover:ring-yellow-500 transition-all" data-color="yellow" title="Yellow"></button>
                                                <button type="button" class="color-option w-7 h-7 rounded-full bg-lime-500 hover:ring-2 hover:ring-offset-2 hover:ring-lime-500 transition-all" data-color="lime" title="Lime"></button>
                                                <button type="button" class="color-option w-7 h-7 rounded-full bg-green-500 hover:ring-2 hover:ring-offset-2 hover:ring-green-500 transition-all" data-color="green" title="Green"></button>
                                                <button type="button" class="color-option w-7 h-7 rounded-full bg-teal-500 hover:ring-2 hover:ring-offset-2 hover:ring-teal-500 transition-all" data-color="teal" title="Teal"></button>
                                                <button type="button" class="color-option w-7 h-7 rounded-full bg-cyan-500 hover:ring-2 hover:ring-offset-2 hover:ring-cyan-500 transition-all" data-color="cyan" title="Cyan"></button>
                                                <button type="button" class="color-option w-7 h-7 rounded-full bg-sky-500 hover:ring-2 hover:ring-offset-2 hover:ring-sky-500 transition-all" data-color="sky" title="Sky"></button>
                                                <button type="button" class="color-option w-7 h-7 rounded-full bg-slate-500 hover:ring-2 hover:ring-offset-2 hover:ring-slate-500 transition-all" data-color="slate" title="Slate"></button>
                                                <button type="button" class="color-option w-7 h-7 rounded-full bg-gray-500 hover:ring-2 hover:ring-offset-2 hover:ring-gray-500 transition-all" data-color="gray" title="Gray"></button>
                                            </div>
                                        </div>

                                        <!-- Background Style -->
                                        <div class="mb-4">
                                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Background</label>
                                            <div class="grid grid-cols-4 gap-2">
                                                <button type="button" class="bg-style-option px-2 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors flex items-center justify-center gap-1" data-bg-style="solid">
                                                    <i data-lucide="square" class="w-3 h-3"></i> Solid
                                                </button>
                                                <button type="button" class="bg-style-option px-2 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors flex items-center justify-center gap-1" data-bg-style="flat">
                                                    <i data-lucide="minus" class="w-3 h-3"></i> Flat
                                                </button>
                                                <button type="button" class="bg-style-option px-2 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors flex items-center justify-center gap-1" data-bg-style="glass">
                                                    <i data-lucide="sparkles" class="w-3 h-3"></i> Glass
                                                </button>
                                                <button type="button" class="bg-style-option px-2 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors flex items-center justify-center gap-1" data-bg-style="filled">
                                                    <i data-lucide="paint-bucket" class="w-3 h-3"></i> Filled
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Color Intensity -->
                                        <div class="mb-4">
                                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Color Intensity</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <button type="button" class="intensity-option px-3 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-intensity="light">Light</button>
                                                <button type="button" class="intensity-option px-3 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-intensity="medium">Medium</button>
                                                <button type="button" class="intensity-option px-3 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-intensity="strong">Strong</button>
                                            </div>
                                        </div>

                                        <!-- Border Accent -->
                                        <div class="mb-4">
                                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Border Accent</label>
                                            <div class="grid grid-cols-4 gap-2">
                                                <button type="button" class="border-style-option px-2 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors flex items-center justify-center gap-1" data-border-style="none">
                                                    <i data-lucide="x" class="w-3 h-3"></i> None
                                                </button>
                                                <button type="button" class="border-style-option px-2 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors flex items-center justify-center gap-1" data-border-style="top">
                                                    <i data-lucide="minus" class="w-3 h-3"></i> Top
                                                </button>
                                                <button type="button" class="border-style-option px-2 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors flex items-center justify-center gap-1" data-border-style="left">
                                                    <i data-lucide="align-left" class="w-3 h-3"></i> Left
                                                </button>
                                                <button type="button" class="border-style-option px-2 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors flex items-center justify-center gap-1" data-border-style="full">
                                                    <i data-lucide="square" class="w-3 h-3"></i> Full
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Border Thickness -->
                                        <div class="mb-4">
                                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Border Size</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <button type="button" class="border-size-option px-3 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-border-size="thin">Thin</button>
                                                <button type="button" class="border-size-option px-3 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-border-size="medium">Medium</button>
                                                <button type="button" class="border-size-option px-3 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-border-size="thick">Thick</button>
                                            </div>
                                        </div>

                                        <!-- Text Size -->
                                        <div class="mb-4">
                                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Text Size</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <button type="button" class="text-size-option px-3 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-text-size="small">Small</button>
                                                <button type="button" class="text-size-option px-3 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-text-size="normal">Normal</button>
                                                <button type="button" class="text-size-option px-3 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-text-size="large">Large</button>
                                            </div>
                                        </div>

                                        <!-- Border Radius -->
                                        <div class="mb-4">
                                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Corner Style</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <button type="button" class="radius-option px-3 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-radius="square">Square</button>
                                                <button type="button" class="radius-option px-3 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-radius="rounded">Rounded</button>
                                                <button type="button" class="radius-option px-3 py-2 text-xs rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-radius="pill">Pill</button>
                                            </div>
                                        </div>

                                        <!-- Show Header Toggle -->
                                        <div class="flex items-center justify-between">
                                            <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Show Header</label>
                                            <button type="button" class="header-toggle relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-gray-600 transition-colors"
                                                    data-show-header="true">
                                                <span class="header-toggle-dot inline-block h-4 w-4 transform rounded-full bg-white shadow transition-transform translate-x-6"></span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Hide Button -->
                                <button type="button" class="toggle-visibility p-2 text-gray-400 hover:text-red-500 dark:hover:text-red-400 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                                        data-widget-id="{{ widget.id }}"
                                        title="Hide widget">
                                    <i data-lucide="eye-off" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>

                <!-- Empty state -->
                <div id="empty-state" class="hidden text-center py-12 text-gray-500 dark:text-gray-400">
                    <i data-lucide="layout-dashboard" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                    <p class="text-lg font-medium">No widgets added yet</p>
                    <p class="text-sm mt-1">Click "Browse Widgets" to add some!</p>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Browse Widgets Button -->
            <button type="button" id="open-widget-browser"
                    class="w-full flex items-center justify-center px-6 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-xl shadow-lg transition-all transform hover:scale-[1.02]">
                <i data-lucide="layout-grid" class="w-6 h-6 mr-3"></i>
                <div class="text-left">
                    <p class="font-semibold text-lg">Browse Widgets</p>
                    <p class="text-sm text-blue-100">{{ total_widgets }} widgets available</p>
                </div>
                <i data-lucide="chevron-right" class="w-5 h-5 ml-auto"></i>
            </button>

            <!-- Quick Add by Category -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Quick Add</h2>
                <div class="space-y-2">
                    {% for cat_id, cat_info in widget_categories.items %}
                    <button type="button" class="category-quick-add w-full flex items-center p-3 text-left rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
                            data-category="{{ cat_id }}">
                        <div class="flex-shrink-0 w-8 h-8 rounded-lg
                            {% if cat_info.color == 'blue' %}bg-blue-100 dark:bg-blue-900/30{% endif %}
                            {% if cat_info.color == 'green' %}bg-green-100 dark:bg-green-900/30{% endif %}
                            {% if cat_info.color == 'red' %}bg-red-100 dark:bg-red-900/30{% endif %}
                            {% if cat_info.color == 'purple' %}bg-purple-100 dark:bg-purple-900/30{% endif %}
                            {% if cat_info.color == 'orange' %}bg-orange-100 dark:bg-orange-900/30{% endif %}
                            {% if cat_info.color == 'cyan' %}bg-cyan-100 dark:bg-cyan-900/30{% endif %}
                            {% if cat_info.color == 'pink' %}bg-pink-100 dark:bg-pink-900/30{% endif %}
                            {% if cat_info.color == 'gray' %}bg-gray-100 dark:bg-gray-700{% endif %}
                            flex items-center justify-center mr-3">
                            <i data-lucide="{{ cat_info.icon }}" class="w-4 h-4
                                {% if cat_info.color == 'blue' %}text-blue-600 dark:text-blue-400{% endif %}
                                {% if cat_info.color == 'green' %}text-green-600 dark:text-green-400{% endif %}
                                {% if cat_info.color == 'red' %}text-red-600 dark:text-red-400{% endif %}
                                {% if cat_info.color == 'purple' %}text-purple-600 dark:text-purple-400{% endif %}
                                {% if cat_info.color == 'orange' %}text-orange-600 dark:text-orange-400{% endif %}
                                {% if cat_info.color == 'cyan' %}text-cyan-600 dark:text-cyan-400{% endif %}
                                {% if cat_info.color == 'pink' %}text-pink-600 dark:text-pink-400{% endif %}
                                {% if cat_info.color == 'gray' %}text-gray-600 dark:text-gray-400{% endif %}
                            "></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 dark:text-white truncate">{{ cat_info.name }}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                {% with widgets_by_category|get_item:cat_id as cat_widgets %}
                                    {{ cat_widgets|length }} widget{{ cat_widgets|length|pluralize }}
                                {% endwith %}
                            </p>
                        </div>
                        <i data-lucide="plus" class="w-4 h-4 text-gray-400"></i>
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Global Styles -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                    <i data-lucide="wand-2" class="w-5 h-5 mr-2"></i>
                    Apply to All Widgets
                </h2>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Apply styles to all active widgets at once</p>

                <!-- Global Color -->
                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Color Theme</label>
                    <div class="flex flex-wrap gap-1.5">
                        <button type="button" class="global-color w-6 h-6 rounded-full bg-blue-500 hover:ring-2 hover:ring-offset-1 hover:ring-blue-500 transition-all" data-color="blue" title="Blue"></button>
                        <button type="button" class="global-color w-6 h-6 rounded-full bg-indigo-500 hover:ring-2 hover:ring-offset-1 hover:ring-indigo-500 transition-all" data-color="indigo" title="Indigo"></button>
                        <button type="button" class="global-color w-6 h-6 rounded-full bg-purple-500 hover:ring-2 hover:ring-offset-1 hover:ring-purple-500 transition-all" data-color="purple" title="Purple"></button>
                        <button type="button" class="global-color w-6 h-6 rounded-full bg-pink-500 hover:ring-2 hover:ring-offset-1 hover:ring-pink-500 transition-all" data-color="pink" title="Pink"></button>
                        <button type="button" class="global-color w-6 h-6 rounded-full bg-red-500 hover:ring-2 hover:ring-offset-1 hover:ring-red-500 transition-all" data-color="red" title="Red"></button>
                        <button type="button" class="global-color w-6 h-6 rounded-full bg-orange-500 hover:ring-2 hover:ring-offset-1 hover:ring-orange-500 transition-all" data-color="orange" title="Orange"></button>
                        <button type="button" class="global-color w-6 h-6 rounded-full bg-amber-500 hover:ring-2 hover:ring-offset-1 hover:ring-amber-500 transition-all" data-color="amber" title="Amber"></button>
                        <button type="button" class="global-color w-6 h-6 rounded-full bg-yellow-500 hover:ring-2 hover:ring-offset-1 hover:ring-yellow-500 transition-all" data-color="yellow" title="Yellow"></button>
                        <button type="button" class="global-color w-6 h-6 rounded-full bg-lime-500 hover:ring-2 hover:ring-offset-1 hover:ring-lime-500 transition-all" data-color="lime" title="Lime"></button>
                        <button type="button" class="global-color w-6 h-6 rounded-full bg-green-500 hover:ring-2 hover:ring-offset-1 hover:ring-green-500 transition-all" data-color="green" title="Green"></button>
                        <button type="button" class="global-color w-6 h-6 rounded-full bg-teal-500 hover:ring-2 hover:ring-offset-1 hover:ring-teal-500 transition-all" data-color="teal" title="Teal"></button>
                        <button type="button" class="global-color w-6 h-6 rounded-full bg-cyan-500 hover:ring-2 hover:ring-offset-1 hover:ring-cyan-500 transition-all" data-color="cyan" title="Cyan"></button>
                        <button type="button" class="global-color w-6 h-6 rounded-full bg-sky-500 hover:ring-2 hover:ring-offset-1 hover:ring-sky-500 transition-all" data-color="sky" title="Sky"></button>
                        <button type="button" class="global-color w-6 h-6 rounded-full bg-slate-500 hover:ring-2 hover:ring-offset-1 hover:ring-slate-500 transition-all" data-color="slate" title="Slate"></button>
                        <button type="button" class="global-color w-6 h-6 rounded-full bg-gray-500 hover:ring-2 hover:ring-offset-1 hover:ring-gray-500 transition-all" data-color="gray" title="Gray"></button>
                    </div>
                </div>

                <!-- Global Background Style -->
                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Background Style</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button type="button" class="global-bg-style px-3 py-2 text-xs rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-bg-style="solid">Solid</button>
                        <button type="button" class="global-bg-style px-3 py-2 text-xs rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-bg-style="flat">Flat</button>
                        <button type="button" class="global-bg-style px-3 py-2 text-xs rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-bg-style="glass">Glass</button>
                        <button type="button" class="global-bg-style px-3 py-2 text-xs rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-bg-style="filled">Filled</button>
                    </div>
                </div>

                <!-- Global Color Intensity -->
                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Color Intensity</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" class="global-intensity px-3 py-2 text-xs rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-intensity="light">Light</button>
                        <button type="button" class="global-intensity px-3 py-2 text-xs rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-intensity="medium">Medium</button>
                        <button type="button" class="global-intensity px-3 py-2 text-xs rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-intensity="strong">Strong</button>
                    </div>
                </div>

                <!-- Global Border Accent -->
                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Border Accent</label>
                    <div class="grid grid-cols-4 gap-1">
                        <button type="button" class="global-border-style px-2 py-1.5 text-xs rounded border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-border-style="none">None</button>
                        <button type="button" class="global-border-style px-2 py-1.5 text-xs rounded border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-border-style="top">Top</button>
                        <button type="button" class="global-border-style px-2 py-1.5 text-xs rounded border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-border-style="left">Left</button>
                        <button type="button" class="global-border-style px-2 py-1.5 text-xs rounded border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-border-style="full">Full</button>
                    </div>
                </div>

                <!-- Global Border Size -->
                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Border Size</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" class="global-border-size px-3 py-2 text-xs rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-border-size="thin">Thin</button>
                        <button type="button" class="global-border-size px-3 py-2 text-xs rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-border-size="medium">Medium</button>
                        <button type="button" class="global-border-size px-3 py-2 text-xs rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-border-size="thick">Thick</button>
                    </div>
                </div>

                <!-- Global Text Size -->
                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Text Size</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" class="global-text-size px-3 py-2 text-xs rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-text-size="small">Small</button>
                        <button type="button" class="global-text-size px-3 py-2 text-xs rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-text-size="normal">Normal</button>
                        <button type="button" class="global-text-size px-3 py-2 text-xs rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-text-size="large">Large</button>
                    </div>
                </div>

                <!-- Global Corner Style -->
                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Corner Style</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" class="global-radius px-3 py-2 text-xs rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-radius="square">Square</button>
                        <button type="button" class="global-radius px-3 py-2 text-xs rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-radius="rounded">Rounded</button>
                        <button type="button" class="global-radius px-3 py-2 text-xs rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-colors" data-radius="pill">Pill</button>
                    </div>
                </div>

                <!-- Global Header Toggle -->
                <div class="mb-4 flex items-center justify-between">
                    <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Show All Headers</label>
                    <div class="flex space-x-2">
                        <button type="button" class="global-header-toggle px-3 py-1 text-xs rounded bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors" data-show-header="true">Show</button>
                        <button type="button" class="global-header-toggle px-3 py-1 text-xs rounded bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" data-show-header="false">Hide</button>
                    </div>
                </div>

                <!-- Reset All to Default -->
                <button type="button" id="reset-all-styles" class="w-full mt-2 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors flex items-center justify-center">
                    <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                    Reset All Styles to Default
                </button>
            </div>

            <!-- Hidden Widgets -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center">
                    <i data-lucide="eye-off" class="w-4 h-4 mr-2"></i>
                    Hidden Widgets
                </h3>
                <div id="hidden-widgets" class="space-y-2">
                    {% for widget in current_layout %}
                    {% if not widget.visible %}
                    <div class="hidden-widget-card flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600"
                         data-widget-id="{{ widget.id }}">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="{{ widget.icon }}" class="w-4 h-4 text-gray-400"></i>
                            <span class="text-sm text-gray-600 dark:text-gray-400">{{ widget.name }}</span>
                        </div>
                        <button type="button" class="restore-widget text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 text-sm font-medium"
                                data-widget-id="{{ widget.id }}">
                            Restore
                        </button>
                    </div>
                    {% endif %}
                    {% empty %}
                    <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No hidden widgets</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Widget Browser Modal -->
<div id="widget-browser-modal" class="fixed inset-0 z-50 hidden">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="modal-backdrop"></div>

    <!-- Modal Content -->
    <div class="absolute inset-4 md:inset-8 lg:inset-12 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden">
        <!-- Modal Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <div>
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">Widget Library</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400">{{ total_widgets }} widgets available across {{ widget_categories|length }} categories</p>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Search -->
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                    <input type="text" id="widget-search"
                           placeholder="Search widgets..."
                           class="pl-10 pr-4 py-2 w-64 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="button" id="close-widget-browser" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Category Sidebar -->
            <div class="w-64 border-r border-gray-200 dark:border-gray-700 p-4 overflow-y-auto">
                <div class="space-y-1">
                    <button type="button" class="category-filter w-full flex items-center p-3 text-left rounded-lg bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 font-medium"
                            data-category="all">
                        <i data-lucide="layout-grid" class="w-4 h-4 mr-3"></i>
                        All Widgets
                        <span class="ml-auto text-xs bg-blue-100 dark:bg-blue-800 px-2 py-0.5 rounded-full">{{ total_widgets }}</span>
                    </button>
                    {% for cat_id, cat_info in widget_categories.items %}
                    <button type="button" class="category-filter w-full flex items-center p-3 text-left rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700/50"
                            data-category="{{ cat_id }}">
                        <i data-lucide="{{ cat_info.icon }}" class="w-4 h-4 mr-3"></i>
                        {{ cat_info.name }}
                        <span class="ml-auto text-xs bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded-full">
                            {% with widgets_by_category|get_item:cat_id as cat_widgets %}{{ cat_widgets|length }}{% endwith %}
                        </span>
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Widgets Grid -->
            <div class="flex-1 p-6 overflow-y-auto">
                <div id="widgets-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                    {% for cat_id, widgets in widgets_by_category.items %}
                    {% for widget in widgets %}
                    <div class="widget-item bg-gray-50 dark:bg-gray-700/50 rounded-xl p-4 border-2 transition-all hover:shadow-lg
                                {% if widget.is_active %}border-blue-500 dark:border-blue-400{% else %}border-transparent hover:border-gray-300 dark:hover:border-gray-600{% endif %}"
                         data-widget-id="{{ widget.id }}"
                         data-category="{{ cat_id }}"
                         data-name="{{ widget.name|lower }}"
                         data-description="{{ widget.description|lower }}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 w-12 h-12 rounded-xl
                                    {% if cat_id == 'operations' %}bg-blue-100 dark:bg-blue-900/30{% endif %}
                                    {% if cat_id == 'inventory' %}bg-green-100 dark:bg-green-900/30{% endif %}
                                    {% if cat_id == 'quality' %}bg-red-100 dark:bg-red-900/30{% endif %}
                                    {% if cat_id == 'sales' %}bg-purple-100 dark:bg-purple-900/30{% endif %}
                                    {% if cat_id == 'maintenance' %}bg-orange-100 dark:bg-orange-900/30{% endif %}
                                    {% if cat_id == 'analytics' %}bg-cyan-100 dark:bg-cyan-900/30{% endif %}
                                    {% if cat_id == 'team' %}bg-pink-100 dark:bg-pink-900/30{% endif %}
                                    {% if cat_id == 'utilities' %}bg-gray-100 dark:bg-gray-700{% endif %}
                                    flex items-center justify-center mr-3">
                                    <i data-lucide="{{ widget.icon }}" class="w-6 h-6
                                        {% if cat_id == 'operations' %}text-blue-600 dark:text-blue-400{% endif %}
                                        {% if cat_id == 'inventory' %}text-green-600 dark:text-green-400{% endif %}
                                        {% if cat_id == 'quality' %}text-red-600 dark:text-red-400{% endif %}
                                        {% if cat_id == 'sales' %}text-purple-600 dark:text-purple-400{% endif %}
                                        {% if cat_id == 'maintenance' %}text-orange-600 dark:text-orange-400{% endif %}
                                        {% if cat_id == 'analytics' %}text-cyan-600 dark:text-cyan-400{% endif %}
                                        {% if cat_id == 'team' %}text-pink-600 dark:text-pink-400{% endif %}
                                        {% if cat_id == 'utilities' %}text-gray-600 dark:text-gray-400{% endif %}
                                    "></i>
                                </div>
                            </div>
                            {% if widget.is_active %}
                            <span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 rounded-full">
                                <i data-lucide="check" class="w-3 h-3 mr-1"></i>
                                Active
                            </span>
                            {% endif %}
                        </div>
                        <h3 class="font-semibold text-gray-900 dark:text-white mb-1">{{ widget.name }}</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">{{ widget.description }}</p>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-400 dark:text-gray-500 capitalize">
                                {% for c_id, c_info in widget_categories.items %}
                                    {% if c_id == cat_id %}{{ c_info.name }}{% endif %}
                                {% endfor %}
                            </span>
                            <button type="button" class="add-widget-btn inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-lg transition-colors
                                    {% if widget.is_active %}
                                    bg-gray-200 dark:bg-gray-600 text-gray-500 dark:text-gray-400 cursor-not-allowed
                                    {% else %}
                                    bg-blue-600 hover:bg-blue-700 text-white
                                    {% endif %}"
                                    data-widget-id="{{ widget.id }}"
                                    data-widget-name="{{ widget.name }}"
                                    data-widget-icon="{{ widget.icon }}"
                                    data-widget-size="{{ widget.default_size }}"
                                    data-widget-description="{{ widget.description }}"
                                    {% if widget.is_active %}disabled{% endif %}>
                                {% if widget.is_active %}
                                <i data-lucide="check" class="w-4 h-4 mr-1"></i>
                                Added
                                {% else %}
                                <i data-lucide="plus" class="w-4 h-4 mr-1"></i>
                                Add
                                {% endif %}
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                    {% endfor %}
                </div>

                <!-- No results message -->
                <div id="no-results" class="hidden text-center py-12">
                    <i data-lucide="search-x" class="w-12 h-12 mx-auto mb-4 text-gray-300 dark:text-gray-600"></i>
                    <p class="text-gray-500 dark:text-gray-400">No widgets found matching your search</p>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
            <div class="flex items-center justify-between">
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    <span id="selected-count">0</span> widgets selected
                </p>
                <div class="flex items-center space-x-3">
                    <button type="button" id="cancel-browser" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="button" id="apply-widgets" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        Done
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form for saving -->
<form id="save-form" method="post" action="{% if dashboard_type == 'main' %}{% url 'dashboard:customize' %}{% else %}{% url 'dashboard:customize_type' dashboard_type %}{% endif %}" class="hidden">
    {% csrf_token %}
    <input type="hidden" name="widget_config" id="widget-config-input">
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dashboard configuration - store dashboard type for all operations
    const DASHBOARD_CONFIG = {
        type: '{{ dashboard_type|default:"main" }}',
        saveUrl: '{% if dashboard_type == "main" %}{% url "dashboard:save_widget_order" %}{% else %}{% url "dashboard:save_widget_order_type" dashboard_type %}{% endif %}',
        isMain: '{{ dashboard_type|default:"main" }}' === 'main'
    };

    // Debug: log configuration
    console.log('Dashboard Config:', DASHBOARD_CONFIG);

    const activeWidgetsContainer = document.getElementById('active-widgets');
    const saveBtn = document.getElementById('save-layout-btn');
    const saveForm = document.getElementById('save-form');
    const widgetConfigInput = document.getElementById('widget-config-input');
    const emptyState = document.getElementById('empty-state');

    // Modal elements
    const modal = document.getElementById('widget-browser-modal');
    const openModalBtn = document.getElementById('open-widget-browser');
    const closeModalBtn = document.getElementById('close-widget-browser');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const cancelBtn = document.getElementById('cancel-browser');
    const applyBtn = document.getElementById('apply-widgets');
    const searchInput = document.getElementById('widget-search');
    const widgetsGrid = document.getElementById('widgets-grid');
    const noResults = document.getElementById('no-results');

    // Current layout state
    let widgetLayout = {{ current_layout_json|safe }};

    // Available widgets data
    const availableWidgets = {
        {% for widget_id, widget_info in available_widgets.items %}
        "{{ widget_id }}": {
            name: "{{ widget_info.name }}",
            description: "{{ widget_info.description }}",
            icon: "{{ widget_info.icon }}",
            default_size: "{{ widget_info.default_size }}",
            category: "{{ widget_info.category }}"
        },
        {% endfor %}
    };

    // Check empty state
    function checkEmptyState() {
        const cards = activeWidgetsContainer.querySelectorAll('.widget-card');
        if (cards.length === 0) {
            emptyState.classList.remove('hidden');
        } else {
            emptyState.classList.add('hidden');
        }
    }
    checkEmptyState();

    // Drag and drop
    let draggedElement = null;

    activeWidgetsContainer.addEventListener('dragstart', function(e) {
        if (e.target.classList.contains('widget-card')) {
            draggedElement = e.target;
            e.target.classList.add('opacity-50', 'ring-2', 'ring-blue-500');
            e.dataTransfer.effectAllowed = 'move';
        }
    });

    activeWidgetsContainer.addEventListener('dragend', function(e) {
        if (e.target.classList.contains('widget-card')) {
            e.target.classList.remove('opacity-50', 'ring-2', 'ring-blue-500');
            draggedElement = null;
            updateLayoutFromDOM();
        }
    });

    activeWidgetsContainer.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        const afterElement = getDragAfterElement(activeWidgetsContainer, e.clientY);
        if (draggedElement) {
            if (afterElement == null) {
                activeWidgetsContainer.appendChild(draggedElement);
            } else {
                activeWidgetsContainer.insertBefore(draggedElement, afterElement);
            }
        }
    });

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.widget-card:not(.opacity-50)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function updateLayoutFromDOM() {
        const cards = activeWidgetsContainer.querySelectorAll('.widget-card');
        const visibleWidgets = [];
        cards.forEach((card, index) => {
            const widgetId = card.dataset.widgetId;
            const sizeSelect = card.querySelector('.size-select');
            visibleWidgets.push({
                id: widgetId,
                size: sizeSelect ? sizeSelect.value : 'medium',
                order: index + 1,
                visible: true,
                color: card.dataset.color || 'blue',
                color_intensity: card.dataset.intensity || 'medium',
                bg_style: card.dataset.bgStyle || 'solid',
                border_style: card.dataset.borderStyle || 'none',
                border_size: card.dataset.borderSize || 'medium',
                text_size: card.dataset.textSize || 'normal',
                border_radius: card.dataset.borderRadius || 'rounded',
                show_header: card.dataset.showHeader !== 'false'
            });
        });

        // Keep hidden widgets with their style properties
        const hiddenWidgets = widgetLayout.filter(w => !w.visible).map(w => ({
            ...w,
            color: w.color || 'blue',
            color_intensity: w.color_intensity || 'medium',
            bg_style: w.bg_style || 'solid',
            border_style: w.border_style || 'none',
            border_size: w.border_size || 'medium',
            text_size: w.text_size || 'normal',
            border_radius: w.border_radius || 'rounded',
            show_header: w.show_header !== false
        }));
        widgetLayout = [...visibleWidgets, ...hiddenWidgets];
    }

    // Size select change
    document.querySelectorAll('.size-select').forEach(select => {
        select.addEventListener('change', updateLayoutFromDOM);
    });

    // Widget style option handlers
    function attachStyleHandlers() {
        // Color option handlers
        document.querySelectorAll('.color-option').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const color = this.dataset.color;
                const card = this.closest('.widget-card');
                if (!card) return;

                // Update data attribute
                card.dataset.color = color;

                // Update visual preview - icon background and color
                const iconPreview = card.querySelector('.widget-icon-preview');
                if (iconPreview) {
                    // Remove old color classes
                    const colorClasses = ['bg-blue-100', 'bg-green-100', 'bg-red-100', 'bg-purple-100', 'bg-orange-100', 'bg-cyan-100', 'bg-pink-100', 'bg-gray-100',
                                          'dark:bg-blue-900/30', 'dark:bg-green-900/30', 'dark:bg-red-900/30', 'dark:bg-purple-900/30', 'dark:bg-orange-900/30', 'dark:bg-cyan-900/30', 'dark:bg-pink-900/30', 'dark:bg-gray-700'];
                    iconPreview.classList.remove(...colorClasses);
                    iconPreview.classList.add(`bg-${color}-100`, `dark:bg-${color}-900/30`);

                    // Update icon color
                    const icon = iconPreview.querySelector('[data-lucide]');
                    if (icon) {
                        const iconColorClasses = ['text-blue-600', 'text-green-600', 'text-red-600', 'text-purple-600', 'text-orange-600', 'text-cyan-600', 'text-pink-600', 'text-gray-600',
                                                  'dark:text-blue-400', 'dark:text-green-400', 'dark:text-red-400', 'dark:text-purple-400', 'dark:text-orange-400', 'dark:text-cyan-400', 'dark:text-pink-400', 'dark:text-gray-400'];
                        icon.classList.remove(...iconColorClasses);
                        icon.classList.add(`text-${color}-600`, `dark:text-${color}-400`);
                    }
                }

                // Highlight selected color
                const colorButtons = this.closest('.flex').querySelectorAll('.color-option');
                colorButtons.forEach(b => b.classList.remove('ring-2', 'ring-offset-2'));
                this.classList.add('ring-2', 'ring-offset-2');

                updateLayoutFromDOM();
            });
        });

        // Background style option handlers
        document.querySelectorAll('.bg-style-option').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const bgStyle = this.dataset.bgStyle;
                const card = this.closest('.widget-card');
                if (!card) return;

                card.dataset.bgStyle = bgStyle;

                // Highlight selected
                const buttons = this.closest('.grid').querySelectorAll('.bg-style-option');
                buttons.forEach(b => {
                    b.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                    b.classList.add('border-gray-200', 'dark:border-gray-600');
                });
                this.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                this.classList.remove('border-gray-200', 'dark:border-gray-600');

                updateLayoutFromDOM();
            });
        });

        // Border style option handlers
        document.querySelectorAll('.border-style-option').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const borderStyle = this.dataset.borderStyle;
                const card = this.closest('.widget-card');
                if (!card) return;

                card.dataset.borderStyle = borderStyle;

                // Highlight selected
                const buttons = this.closest('.grid').querySelectorAll('.border-style-option');
                buttons.forEach(b => {
                    b.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                    b.classList.add('border-gray-200', 'dark:border-gray-600');
                });
                this.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                this.classList.remove('border-gray-200', 'dark:border-gray-600');

                updateLayoutFromDOM();
            });
        });

        // Border size option handlers
        document.querySelectorAll('.border-size-option').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const borderSize = this.dataset.borderSize;
                const card = this.closest('.widget-card');
                if (!card) return;

                card.dataset.borderSize = borderSize;

                // Highlight selected
                const buttons = this.closest('.grid').querySelectorAll('.border-size-option');
                buttons.forEach(b => {
                    b.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                    b.classList.add('border-gray-200', 'dark:border-gray-600');
                });
                this.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                this.classList.remove('border-gray-200', 'dark:border-gray-600');

                updateLayoutFromDOM();
            });
        });

        // Text size option handlers
        document.querySelectorAll('.text-size-option').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const textSize = this.dataset.textSize;
                const card = this.closest('.widget-card');
                if (!card) return;

                card.dataset.textSize = textSize;

                // Highlight selected text size
                const sizeButtons = this.closest('.grid').querySelectorAll('.text-size-option');
                sizeButtons.forEach(b => {
                    b.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                    b.classList.add('border-gray-200', 'dark:border-gray-600');
                });
                this.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                this.classList.remove('border-gray-200', 'dark:border-gray-600');

                updateLayoutFromDOM();
            });
        });

        // Border radius option handlers
        document.querySelectorAll('.radius-option').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const radius = this.dataset.radius;
                const card = this.closest('.widget-card');
                if (!card) return;

                card.dataset.borderRadius = radius;

                // Highlight selected radius
                const radiusButtons = this.closest('.grid').querySelectorAll('.radius-option');
                radiusButtons.forEach(b => {
                    b.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                    b.classList.add('border-gray-200', 'dark:border-gray-600');
                });
                this.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                this.classList.remove('border-gray-200', 'dark:border-gray-600');

                updateLayoutFromDOM();
            });
        });

        // Header toggle handlers
        document.querySelectorAll('.header-toggle').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const card = this.closest('.widget-card');
                if (!card) return;

                const currentState = card.dataset.showHeader === 'true';
                const newState = !currentState;
                card.dataset.showHeader = newState;

                // Update toggle visual
                const dot = this.querySelector('.header-toggle-dot');
                if (newState) {
                    this.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                    this.classList.add('bg-blue-600');
                    dot.classList.remove('translate-x-1');
                    dot.classList.add('translate-x-6');
                } else {
                    this.classList.add('bg-gray-200', 'dark:bg-gray-600');
                    this.classList.remove('bg-blue-600');
                    dot.classList.add('translate-x-1');
                    dot.classList.remove('translate-x-6');
                }

                updateLayoutFromDOM();
            });
        });

        // Color intensity option handlers
        document.querySelectorAll('.intensity-option').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const intensity = this.dataset.intensity;
                const card = this.closest('.widget-card');
                if (!card) return;

                card.dataset.intensity = intensity;

                // Highlight selected
                const buttons = this.closest('.grid').querySelectorAll('.intensity-option');
                buttons.forEach(b => {
                    b.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                    b.classList.add('border-gray-200', 'dark:border-gray-600');
                });
                this.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                this.classList.remove('border-gray-200', 'dark:border-gray-600');

                updateLayoutFromDOM();
            });
        });

        // Initialize active states on settings dropdowns
        document.querySelectorAll('.widget-card').forEach(card => {
            const color = card.dataset.color || 'blue';
            const intensity = card.dataset.intensity || 'medium';
            const bgStyle = card.dataset.bgStyle || 'solid';
            const borderStyle = card.dataset.borderStyle || 'none';
            const borderSize = card.dataset.borderSize || 'medium';
            const textSize = card.dataset.textSize || 'normal';
            const borderRadius = card.dataset.borderRadius || 'rounded';
            const showHeader = card.dataset.showHeader !== 'false';

            // Set active color button
            const colorBtn = card.querySelector(`.color-option[data-color="${color}"]`);
            if (colorBtn) colorBtn.classList.add('ring-2', 'ring-offset-2');

            // Set active intensity button
            const intensityBtn = card.querySelector(`.intensity-option[data-intensity="${intensity}"]`);
            if (intensityBtn) {
                intensityBtn.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                intensityBtn.classList.remove('border-gray-200', 'dark:border-gray-600');
            }

            // Set active background style button
            const bgStyleBtn = card.querySelector(`.bg-style-option[data-bg-style="${bgStyle}"]`);
            if (bgStyleBtn) {
                bgStyleBtn.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                bgStyleBtn.classList.remove('border-gray-200', 'dark:border-gray-600');
            }

            // Set active border style button
            const borderStyleBtn = card.querySelector(`.border-style-option[data-border-style="${borderStyle}"]`);
            if (borderStyleBtn) {
                borderStyleBtn.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                borderStyleBtn.classList.remove('border-gray-200', 'dark:border-gray-600');
            }

            // Set active border size button
            const borderSizeBtn = card.querySelector(`.border-size-option[data-border-size="${borderSize}"]`);
            if (borderSizeBtn) {
                borderSizeBtn.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                borderSizeBtn.classList.remove('border-gray-200', 'dark:border-gray-600');
            }

            // Set active text size button
            const textSizeBtn = card.querySelector(`.text-size-option[data-text-size="${textSize}"]`);
            if (textSizeBtn) {
                textSizeBtn.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                textSizeBtn.classList.remove('border-gray-200', 'dark:border-gray-600');
            }

            // Set active radius button
            const radiusBtn = card.querySelector(`.radius-option[data-radius="${borderRadius}"]`);
            if (radiusBtn) {
                radiusBtn.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
                radiusBtn.classList.remove('border-gray-200', 'dark:border-gray-600');
            }

            // Set header toggle state
            const headerToggle = card.querySelector('.header-toggle');
            if (headerToggle) {
                const dot = headerToggle.querySelector('.header-toggle-dot');
                if (showHeader) {
                    headerToggle.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                    headerToggle.classList.add('bg-blue-600');
                    dot.classList.remove('translate-x-1');
                    dot.classList.add('translate-x-6');
                } else {
                    headerToggle.classList.add('bg-gray-200', 'dark:bg-gray-600');
                    headerToggle.classList.remove('bg-blue-600');
                    dot.classList.add('translate-x-1');
                    dot.classList.remove('translate-x-6');
                }
            }
        });
    }
    attachStyleHandlers();

    // Toggle visibility (hide widget)
    function attachToggleHandlers() {
        document.querySelectorAll('.toggle-visibility').forEach(btn => {
            btn.addEventListener('click', function() {
                const widgetId = this.dataset.widgetId;
                const card = this.closest('.widget-card');
                const widgetName = card.querySelector('.font-medium').textContent;
                const widgetIcon = card.querySelector('[data-lucide]').getAttribute('data-lucide');

                // Update layout
                const widget = widgetLayout.find(w => w.id === widgetId);
                if (widget) {
                    widget.visible = false;
                }

                // Remove from active
                card.remove();
                checkEmptyState();

                // Add to hidden section
                const hiddenContainer = document.getElementById('hidden-widgets');
                const emptyMsg = hiddenContainer.querySelector('p');
                if (emptyMsg) emptyMsg.remove();

                const hiddenCard = document.createElement('div');
                hiddenCard.className = 'hidden-widget-card flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600';
                hiddenCard.dataset.widgetId = widgetId;
                hiddenCard.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <i data-lucide="${widgetIcon}" class="w-4 h-4 text-gray-400"></i>
                        <span class="text-sm text-gray-600 dark:text-gray-400">${widgetName}</span>
                    </div>
                    <button type="button" class="restore-widget text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 text-sm font-medium" data-widget-id="${widgetId}">
                        Restore
                    </button>
                `;
                hiddenContainer.appendChild(hiddenCard);

                // Reinit icons and handlers
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                attachRestoreHandlers();
            });
        });
    }
    attachToggleHandlers();

    // Restore widget
    function attachRestoreHandlers() {
        document.querySelectorAll('.restore-widget').forEach(btn => {
            btn.addEventListener('click', function() {
                const widgetId = this.dataset.widgetId;
                const widget = widgetLayout.find(w => w.id === widgetId);
                if (widget) {
                    widget.visible = true;
                }
                // Save and reload to properly restore
                widgetConfigInput.value = JSON.stringify(widgetLayout);
                saveForm.submit();
            });
        });
    }
    attachRestoreHandlers();

    // Modal handling
    function openModal() {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
        setTimeout(() => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }, 100);
    }

    function closeModal() {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        searchInput.value = '';
        filterWidgets('', 'all');
    }

    openModalBtn.addEventListener('click', openModal);
    closeModalBtn.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    applyBtn.addEventListener('click', closeModal);

    // Category quick add buttons
    document.querySelectorAll('.category-quick-add').forEach(btn => {
        btn.addEventListener('click', function() {
            const category = this.dataset.category;
            openModal();
            // Set active category filter
            document.querySelectorAll('.category-filter').forEach(f => {
                f.classList.remove('bg-blue-50', 'dark:bg-blue-900/30', 'text-blue-700', 'dark:text-blue-300', 'font-medium');
                f.classList.add('text-gray-600', 'dark:text-gray-400');
            });
            const targetFilter = document.querySelector(`.category-filter[data-category="${category}"]`);
            if (targetFilter) {
                targetFilter.classList.add('bg-blue-50', 'dark:bg-blue-900/30', 'text-blue-700', 'dark:text-blue-300', 'font-medium');
                targetFilter.classList.remove('text-gray-600', 'dark:text-gray-400');
            }
            filterWidgets('', category);
        });
    });

    // Category filter in modal
    document.querySelectorAll('.category-filter').forEach(btn => {
        btn.addEventListener('click', function() {
            const category = this.dataset.category;

            // Update active state
            document.querySelectorAll('.category-filter').forEach(f => {
                f.classList.remove('bg-blue-50', 'dark:bg-blue-900/30', 'text-blue-700', 'dark:text-blue-300', 'font-medium');
                f.classList.add('text-gray-600', 'dark:text-gray-400');
            });
            this.classList.add('bg-blue-50', 'dark:bg-blue-900/30', 'text-blue-700', 'dark:text-blue-300', 'font-medium');
            this.classList.remove('text-gray-600', 'dark:text-gray-400');

            filterWidgets(searchInput.value, category);
        });
    });

    // Search
    searchInput.addEventListener('input', function() {
        const activeCategory = document.querySelector('.category-filter.bg-blue-50')?.dataset.category || 'all';
        filterWidgets(this.value, activeCategory);
    });

    function filterWidgets(search, category) {
        const items = widgetsGrid.querySelectorAll('.widget-item');
        let visibleCount = 0;

        items.forEach(item => {
            const matchesCategory = category === 'all' || item.dataset.category === category;
            const matchesSearch = !search ||
                item.dataset.name.includes(search.toLowerCase()) ||
                item.dataset.description.includes(search.toLowerCase());

            if (matchesCategory && matchesSearch) {
                item.classList.remove('hidden');
                visibleCount++;
            } else {
                item.classList.add('hidden');
            }
        });

        // Show/hide no results message
        if (visibleCount === 0) {
            noResults.classList.remove('hidden');
        } else {
            noResults.classList.add('hidden');
        }
    }

    // Add widget from modal - AUTO-SAVE immediately
    document.querySelectorAll('.add-widget-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (this.disabled) return;

            const widgetId = this.dataset.widgetId;

            // Check if already in layout
            if (widgetLayout.some(w => w.id === widgetId)) {
                return;
            }

            // Add to layout with default styles
            widgetLayout.push({
                id: widgetId,
                size: this.dataset.widgetSize,
                order: widgetLayout.length + 1,
                visible: true,
                color: 'blue',
                color_intensity: 'medium',
                bg_style: 'solid',
                border_style: 'none',
                border_size: 'medium',
                text_size: 'normal',
                border_radius: 'rounded',
                show_header: true
            });

            // Update button state immediately for visual feedback
            this.disabled = true;
            this.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            this.classList.add('bg-gray-200', 'dark:bg-gray-600', 'text-gray-500', 'dark:text-gray-400', 'cursor-not-allowed');
            this.innerHTML = '<i data-lucide="check" class="w-4 h-4 mr-1"></i> Saving...';

            // AUTO-SAVE: Save immediately and stay on page
            widgetConfigInput.value = JSON.stringify(widgetLayout);

            // Use fetch to save without page reload
            fetch(DASHBOARD_CONFIG.saveUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ widgets: widgetLayout, dashboard_type: DASHBOARD_CONFIG.type })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update button to show success
                    this.innerHTML = '<i data-lucide="check" class="w-4 h-4 mr-1"></i> Added';

                    // Update parent card
                    const card = this.closest('.widget-item');
                    card.classList.add('border-blue-500', 'dark:border-blue-400');
                    card.classList.remove('border-transparent');

                    // Add badge
                    const header = card.querySelector('.flex.items-start');
                    if (!header.querySelector('.bg-blue-100')) {
                        const badge = document.createElement('span');
                        badge.className = 'inline-flex items-center px-2 py-1 text-xs font-medium bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 rounded-full';
                        badge.innerHTML = '<i data-lucide="check" class="w-3 h-3 mr-1"></i>Active';
                        header.appendChild(badge);
                    }

                    // Update selected count
                    const countEl = document.getElementById('selected-count');
                    countEl.textContent = widgetLayout.filter(w => w.visible).length;

                    // Show toast notification
                    if (window.showToast) {
                        window.showToast('Widget added to dashboard!', 'success', 3000);
                    }

                    // Reinit icons
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }
            })
            .catch(error => {
                console.error('Error saving widget:', error);
                this.innerHTML = '<i data-lucide="x" class="w-4 h-4 mr-1"></i> Error';
            });
        });
    });

    // Update selected count on load
    document.getElementById('selected-count').textContent = widgetLayout.filter(w => w.visible).length;

    // Save layout - also needs to preserve newly added widgets
    saveBtn.addEventListener('click', function() {
        // Get widgets from DOM
        const cards = activeWidgetsContainer.querySelectorAll('.widget-card');
        const domWidgetIds = [];
        const domWidgets = [];

        cards.forEach((card, index) => {
            const widgetId = card.dataset.widgetId;
            const sizeSelect = card.querySelector('.size-select');
            domWidgetIds.push(widgetId);
            domWidgets.push({
                id: widgetId,
                size: sizeSelect ? sizeSelect.value : 'medium',
                order: index + 1,
                visible: true,
                color: card.dataset.color || 'blue',
                color_intensity: card.dataset.intensity || 'medium',
                bg_style: card.dataset.bgStyle || 'solid',
                border_style: card.dataset.borderStyle || 'none',
                border_size: card.dataset.borderSize || 'medium',
                text_size: card.dataset.textSize || 'normal',
                border_radius: card.dataset.borderRadius || 'rounded',
                show_header: card.dataset.showHeader !== 'false'
            });
        });

        // Add widgets that were added from modal but not yet in DOM
        widgetLayout.forEach(w => {
            if (w.visible && !domWidgetIds.includes(w.id)) {
                domWidgets.push({
                    id: w.id,
                    size: w.size,
                    order: domWidgets.length + 1,
                    visible: true,
                    color: w.color || 'blue',
                    color_intensity: w.color_intensity || 'medium',
                    bg_style: w.bg_style || 'solid',
                    border_style: w.border_style || 'none',
                    border_size: w.border_size || 'medium',
                    text_size: w.text_size || 'normal',
                    border_radius: w.border_radius || 'rounded',
                    show_header: w.show_header !== false
                });
            }
        });

        // Add hidden widgets with their style properties
        widgetLayout.filter(w => !w.visible).forEach(w => {
            domWidgets.push({
                ...w,
                color: w.color || 'blue',
                color_intensity: w.color_intensity || 'medium',
                bg_style: w.bg_style || 'solid',
                border_style: w.border_style || 'none',
                border_size: w.border_size || 'medium',
                text_size: w.text_size || 'normal',
                border_radius: w.border_radius || 'rounded',
                show_header: w.show_header !== false
            });
        });

        widgetConfigInput.value = JSON.stringify(domWidgets);
        saveForm.submit();
    });

    // Keyboard shortcut to close modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeModal();
        }
    });

    // =====================
    // Global Style Handlers
    // =====================

    // All available colors for class manipulation
    const ALL_COLORS = ['blue', 'indigo', 'purple', 'pink', 'red', 'orange', 'amber', 'yellow', 'lime', 'green', 'teal', 'cyan', 'sky', 'slate', 'gray'];

    // Auto-save function for global style changes (silent - no toast)
    function autoSaveGlobalStyles() {
        console.log('Auto-saving global styles for dashboard:', DASHBOARD_CONFIG.type);
        updateLayoutFromDOM();

        fetch(DASHBOARD_CONFIG.saveUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ widgets: widgetLayout, dashboard_type: DASHBOARD_CONFIG.type })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Global styles saved successfully');
            } else {
                console.error('Failed to save global styles:', data.error);
            }
        })
        .catch(error => {
            console.error('Error saving global styles:', error);
        });
    }

    // Apply color to all widgets
    document.querySelectorAll('.global-color').forEach(btn => {
        btn.addEventListener('click', function() {
            console.log('Global color clicked:', this.dataset.color);
            const color = this.dataset.color;
            const cards = activeWidgetsContainer.querySelectorAll('.widget-card');
            console.log('Found widget cards:', cards.length);

            cards.forEach(card => {
                card.dataset.color = color;
                // Update icon preview colors using explicit class names
                const iconPreview = card.querySelector('.widget-icon-preview');
                if (iconPreview) {
                    // Remove all color classes explicitly
                    ALL_COLORS.forEach(c => {
                        iconPreview.classList.remove(`bg-${c}-100`, `dark:bg-${c}-900/30`);
                    });
                    iconPreview.classList.add(`bg-${color}-100`, `dark:bg-${color}-900/30`);

                    const icon = iconPreview.querySelector('[data-lucide]');
                    if (icon) {
                        ALL_COLORS.forEach(c => {
                            icon.classList.remove(`text-${c}-600`, `dark:text-${c}-400`);
                        });
                        icon.classList.add(`text-${color}-600`, `dark:text-${color}-400`);
                    }
                }
            });

            // Highlight selected - must include ring COLOR for visibility
            document.querySelectorAll('.global-color').forEach(b => {
                b.classList.remove('ring-2', 'ring-offset-2');
                // Remove any existing ring color
                ALL_COLORS.forEach(c => b.classList.remove(`ring-${c}-500`));
            });
            this.classList.add('ring-2', 'ring-offset-2', `ring-${color}-500`);

            // Auto-save
            autoSaveGlobalStyles();
        });
    });

    // Apply background style to all widgets
    document.querySelectorAll('.global-bg-style').forEach(btn => {
        btn.addEventListener('click', function() {
            console.log('Global bg-style clicked:', this.dataset.bgStyle);
            const bgStyle = this.dataset.bgStyle;
            const cards = activeWidgetsContainer.querySelectorAll('.widget-card');
            cards.forEach(card => {
                card.dataset.bgStyle = bgStyle;
            });
            // Highlight selected
            document.querySelectorAll('.global-bg-style').forEach(b => {
                b.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
            });
            this.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
            // Auto-save
            autoSaveGlobalStyles();
        });
    });

    // Apply border style to all widgets
    document.querySelectorAll('.global-border-style').forEach(btn => {
        btn.addEventListener('click', function() {
            console.log('Global border-style clicked:', this.dataset.borderStyle);
            const borderStyle = this.dataset.borderStyle;
            const cards = activeWidgetsContainer.querySelectorAll('.widget-card');
            cards.forEach(card => {
                card.dataset.borderStyle = borderStyle;
            });
            // Highlight selected
            document.querySelectorAll('.global-border-style').forEach(b => {
                b.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
            });
            this.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
            // Auto-save
            autoSaveGlobalStyles();
        });
    });

    // Apply color intensity to all widgets
    document.querySelectorAll('.global-intensity').forEach(btn => {
        btn.addEventListener('click', function() {
            console.log('Global intensity clicked:', this.dataset.intensity);
            const intensity = this.dataset.intensity;
            const cards = activeWidgetsContainer.querySelectorAll('.widget-card');
            cards.forEach(card => {
                card.dataset.intensity = intensity;
            });
            // Highlight selected
            document.querySelectorAll('.global-intensity').forEach(b => {
                b.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
            });
            this.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
            // Auto-save
            autoSaveGlobalStyles();
        });
    });

    // Apply border size to all widgets
    document.querySelectorAll('.global-border-size').forEach(btn => {
        btn.addEventListener('click', function() {
            console.log('Global border-size clicked:', this.dataset.borderSize);
            const borderSize = this.dataset.borderSize;
            const cards = activeWidgetsContainer.querySelectorAll('.widget-card');
            cards.forEach(card => {
                card.dataset.borderSize = borderSize;
            });
            // Highlight selected
            document.querySelectorAll('.global-border-size').forEach(b => {
                b.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
            });
            this.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
            // Auto-save
            autoSaveGlobalStyles();
        });
    });

    // Apply text size to all widgets
    document.querySelectorAll('.global-text-size').forEach(btn => {
        btn.addEventListener('click', function() {
            console.log('Global text-size clicked:', this.dataset.textSize);
            const textSize = this.dataset.textSize;
            const cards = activeWidgetsContainer.querySelectorAll('.widget-card');
            cards.forEach(card => {
                card.dataset.textSize = textSize;
            });
            // Highlight selected
            document.querySelectorAll('.global-text-size').forEach(b => {
                b.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
            });
            this.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
            // Auto-save
            autoSaveGlobalStyles();
        });
    });

    // Apply corner style to all widgets
    document.querySelectorAll('.global-radius').forEach(btn => {
        btn.addEventListener('click', function() {
            console.log('Global radius clicked:', this.dataset.radius);
            const radius = this.dataset.radius;
            const cards = activeWidgetsContainer.querySelectorAll('.widget-card');
            cards.forEach(card => {
                card.dataset.borderRadius = radius;
            });
            // Highlight selected
            document.querySelectorAll('.global-radius').forEach(b => {
                b.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
            });
            this.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
            // Auto-save
            autoSaveGlobalStyles();
        });
    });

    // Toggle headers for all widgets
    document.querySelectorAll('.global-header-toggle').forEach(btn => {
        btn.addEventListener('click', function() {
            console.log('Global header-toggle clicked:', this.dataset.showHeader);
            const showHeader = this.dataset.showHeader === 'true';
            const cards = activeWidgetsContainer.querySelectorAll('.widget-card');
            cards.forEach(card => {
                card.dataset.showHeader = showHeader;
                // Update individual toggle states
                const headerToggle = card.querySelector('.header-toggle');
                if (headerToggle) {
                    const dot = headerToggle.querySelector('.header-toggle-dot');
                    if (showHeader) {
                        headerToggle.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                        headerToggle.classList.add('bg-blue-600');
                        dot.classList.remove('translate-x-1');
                        dot.classList.add('translate-x-6');
                    } else {
                        headerToggle.classList.add('bg-gray-200', 'dark:bg-gray-600');
                        headerToggle.classList.remove('bg-blue-600');
                        dot.classList.add('translate-x-1');
                        dot.classList.remove('translate-x-6');
                    }
                }
            });
            // Auto-save
            autoSaveGlobalStyles();
        });
    });

    // Reset all styles to default
    document.getElementById('reset-all-styles').addEventListener('click', function() {
        if (!confirm('Reset all widget styles to default? This will set all widgets to blue color, solid background, no border, and show headers.')) {
            return;
        }
        const cards = activeWidgetsContainer.querySelectorAll('.widget-card');
        cards.forEach(card => {
            card.dataset.color = 'blue';
            card.dataset.intensity = 'medium';
            card.dataset.bgStyle = 'solid';
            card.dataset.borderStyle = 'none';
            card.dataset.borderSize = 'medium';
            card.dataset.textSize = 'normal';
            card.dataset.borderRadius = 'rounded';
            card.dataset.showHeader = 'true';
            // Update icon preview
            const iconPreview = card.querySelector('.widget-icon-preview');
            if (iconPreview) {
                iconPreview.className = iconPreview.className.replace(/bg-\w+-100/g, 'bg-blue-100');
                iconPreview.className = iconPreview.className.replace(/dark:bg-\w+-900\/30/g, 'dark:bg-blue-900/30');
                const icon = iconPreview.querySelector('[data-lucide]');
                if (icon) {
                    icon.className = icon.className.replace(/text-\w+-600/g, 'text-blue-600');
                    icon.className = icon.className.replace(/dark:text-\w+-400/g, 'dark:text-blue-400');
                }
            }
            // Reset header toggle
            const headerToggle = card.querySelector('.header-toggle');
            if (headerToggle) {
                const dot = headerToggle.querySelector('.header-toggle-dot');
                headerToggle.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                headerToggle.classList.add('bg-blue-600');
                dot.classList.remove('translate-x-1');
                dot.classList.add('translate-x-6');
            }
        });
        // Clear global button highlights
        document.querySelectorAll('.global-color').forEach(b => b.classList.remove('ring-2', 'ring-offset-2'));
        document.querySelectorAll('.global-bg-style, .global-border-style, .global-intensity, .global-border-size, .global-text-size, .global-radius').forEach(b => {
            b.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/30');
        });
        // Auto-save the reset
        autoSaveGlobalStyles();
    });

    // Log that all handlers are attached
    console.log('All global style handlers attached successfully');
});
</script>
{% endblock %}
