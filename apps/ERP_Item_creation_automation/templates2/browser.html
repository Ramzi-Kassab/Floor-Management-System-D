{% extends "base.html" %}

{% block title %}ERP Automation - Browser Control{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3>Browser Control</h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h4>Browser Actions</h4>
                <div class="mb-3">
                    <label for="url" class="form-label">URL</label>
                    <!-- Pre-fill with default_url from the route -->
                    <input type="text" class="form-control" id="url" value="{{ default_url }}">
                </div>
                <div class="mb-3">
                    <button type="button" class="btn btn-primary" id="start_browser">Start Browser</button>
                    <button type="button" class="btn btn-danger" id="stop_browser" 
                            {% if not browser_active %}disabled{% endif %}>
                        Stop Browser
                    </button>
                    <!-- Button to save typed URL as default -->
                    <button type="button" class="btn btn-secondary" id="save_default_btn">Save as Default</button>
                </div>
                <div class="alert alert-info" id="browser_status">
                    Browser Status: {% if browser_active %}Running{% else %}Stopped{% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <h4>Execute Action</h4>
                <div class="mb-3">
                    <label for="dict_select" class="form-label">Select Action</label>
                    <select class="form-select" id="dict_select" {% if not browser_active %}disabled{% endif %}>
                        <option value="">-- Select Action --</option>
                        {% for name, content in dictionaries.items() %}
                        <option value="{{ name }}">{{ content.name if content.name else name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="button" class="btn btn-success" id="execute_action" 
                        {% if not browser_active %}disabled{% endif %}>
                    Execute Action
                </button>
                <div class="mt-3" id="action_result"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Start browser
    document.getElementById('start_browser').addEventListener('click', function() {
        const url = document.getElementById('url').value;
        fetch('/browser', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `action=start&url=${encodeURIComponent(url)}`
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('browser_status').textContent = 
                    `Browser Status: Running`;
                document.getElementById('stop_browser').disabled = false;
                document.getElementById('dict_select').disabled = false;
                document.getElementById('execute_action').disabled = false;
            } else {
                alert('Error starting browser: ' + data.message);
            }
        });
    });

    // Stop browser
    document.getElementById('stop_browser').addEventListener('click', function() {
        fetch('/browser', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'action=stop'
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('browser_status').textContent = 
                    'Browser Status: Stopped';
                document.getElementById('stop_browser').disabled = true;
                document.getElementById('dict_select').disabled = true;
                document.getElementById('execute_action').disabled = true;
            } else {
                alert('Error stopping browser: ' + data.message);
            }
        });
    });

    // Execute single dictionary action
    document.getElementById('execute_action').addEventListener('click', function() {
        const dictName = document.getElementById('dict_select').value;
        if (!dictName) {
            alert('Please select an action');
            return;
        }
        fetch('/browser', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `action=execute&dict_name=${encodeURIComponent(dictName)}`
        })
        .then(r => r.json())
        .then(data => {
            const resultDiv = document.getElementById('action_result');
            if (data.success) {
                // data.message is from your web_handler result if you set it
                resultDiv.innerHTML = `<div class="alert alert-success">
                    Action succeeded.
                </div>`;
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger">
                    ${data.message || 'Action failed'}
                </div>`;
            }
        });
    });

    // Save typed URL as default
    document.getElementById('save_default_btn').addEventListener('click', function() {
        const url = document.getElementById('url').value.trim();
        if (!url) {
            alert("Please enter a URL first.");
            return;
        }
        fetch('/browser', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `action=save_default_url&url=${encodeURIComponent(url)}`
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert("Default URL saved: " + url);
            } else {
                alert("Error: " + data.message);
            }
        });
    });
</script>
{% endblock %}
