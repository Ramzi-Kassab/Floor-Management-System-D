"""
ARDT FMS - Scan Codes Models
Version: 5.4

Tables:
- scan_codes (P1)
- scan_logs (P1)
"""

from django.db import models
from django.conf import settings


class ScanCode(models.Model):
    """
    ðŸŸ¢ P1: Universal QR/Barcode registry.
    
    Central registry for all scan codes in the system - both internal
    (generated by ARDT) and external (from suppliers, ARAMCO, etc.)
    """
    
    class CodeType(models.TextChoices):
        QR = 'QR', 'QR Code'
        BARCODE = 'BARCODE', 'Barcode'
        DATAMATRIX = 'DATAMATRIX', 'Data Matrix'
    
    class EntityType(models.TextChoices):
        DRILL_BIT = 'DRILL_BIT', 'Drill Bit'
        WORK_ORDER = 'WORK_ORDER', 'Work Order'
        INVENTORY_ITEM = 'INVENTORY_ITEM', 'Inventory Item'
        EQUIPMENT = 'EQUIPMENT', 'Equipment'
        LOCATION = 'LOCATION', 'Location'
        DOCUMENT = 'DOCUMENT', 'Document'
        USER = 'USER', 'User Badge'
        EXTERNAL = 'EXTERNAL', 'External'
    
    code = models.CharField(max_length=200, unique=True)
    code_type = models.CharField(max_length=20, choices=CodeType.choices, default=CodeType.QR)
    
    # What this code refers to
    entity_type = models.CharField(max_length=30, choices=EntityType.choices)
    entity_id = models.BigIntegerField(null=True, blank=True)
    
    # For external codes
    is_external = models.BooleanField(default=False)
    external_source = models.CharField(max_length=100, blank=True, help_text='ARAMCO, Supplier, etc.')
    
    # Additional data encoded in the code
    encoded_data = models.JSONField(null=True, blank=True)
    
    # Status
    is_active = models.BooleanField(default=True)
    
    # Audit
    created_at = models.DateTimeField(auto_now_add=True)
    created_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='created_scan_codes'
    )
    
    class Meta:
        db_table = 'scan_codes'
        ordering = ['-created_at']
        verbose_name = 'Scan Code'
        verbose_name_plural = 'Scan Codes'
        indexes = [
            models.Index(fields=['entity_type', 'entity_id']),
        ]
    
    def __str__(self):
        return f"{self.code} ({self.entity_type})"


class ScanLog(models.Model):
    """
    ðŸŸ¢ P1: Log of all scan events.
    """
    
    class Purpose(models.TextChoices):
        IDENTIFY = 'IDENTIFY', 'Identification'
        VERIFY = 'VERIFY', 'Verification'
        CHECK_IN = 'CHECK_IN', 'Check In'
        CHECK_OUT = 'CHECK_OUT', 'Check Out'
        STEP_COMPLETE = 'STEP_COMPLETE', 'Step Completion'
        TRANSFER = 'TRANSFER', 'Transfer'
    
    scan_code = models.ForeignKey(
        ScanCode,
        on_delete=models.SET_NULL,
        null=True,
        related_name='scan_logs'
    )
    raw_code = models.CharField(max_length=500, help_text='Raw scanned value')
    
    purpose = models.CharField(max_length=20, choices=Purpose.choices, default=Purpose.IDENTIFY)
    
    # Context
    work_order = models.ForeignKey(
        'workorders.WorkOrder',
        on_delete=models.SET_NULL,
        null=True,
        blank=True
    )
    step_execution = models.ForeignKey(
        'execution.StepExecution',
        on_delete=models.SET_NULL,
        null=True,
        blank=True
    )
    
    # Location
    location = models.ForeignKey(
        'inventory.InventoryLocation',
        on_delete=models.SET_NULL,
        null=True,
        blank=True
    )
    latitude = models.DecimalField(max_digits=10, decimal_places=7, null=True, blank=True)
    longitude = models.DecimalField(max_digits=10, decimal_places=7, null=True, blank=True)
    
    # Result
    is_valid = models.BooleanField(default=True)
    validation_message = models.CharField(max_length=500, blank=True)
    
    # User & device
    scanned_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True
    )
    scanned_at = models.DateTimeField(auto_now_add=True)
    device_info = models.CharField(max_length=200, blank=True)
    
    class Meta:
        db_table = 'scan_logs'
        ordering = ['-scanned_at']
        verbose_name = 'Scan Log'
        verbose_name_plural = 'Scan Logs'
    
    def __str__(self):
        return f"{self.raw_code} @ {self.scanned_at}"
