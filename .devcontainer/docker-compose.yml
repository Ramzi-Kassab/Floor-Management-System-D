version: '3.8'

services:
  app:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile

    volumes:
      - ..:/workspace:cached

    command: sleep infinity

    environment:
      # Database - PostgreSQL
      DATABASE_URL: postgresql://ardt:ardt_password@db:5432/ardt_fms

      # Django
      SECRET_KEY: 'dev-secret-key-for-codespaces-only-change-in-production'
      DEBUG: 'True'
      ALLOWED_HOSTS: 'localhost,127.0.0.1,*.githubpreview.dev,*.app.github.dev,*.preview.app.github.dev'

      # Logging
      DJANGO_LOG_LEVEL: 'INFO'

      # Redis
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/1

      # Email - Console backend for dev
      EMAIL_BACKEND: django.core.mail.backends.console.EmailBackend

    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

    networks:
      - ardt-network

  db:
    image: postgres:16-alpine
    restart: unless-stopped

    volumes:
      - postgres-data:/var/lib/postgresql/data

    environment:
      POSTGRES_USER: ardt
      POSTGRES_PASSWORD: ardt_password
      POSTGRES_DB: ardt_fms

    networks:
      - ardt-network

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ardt -d ardt_fms"]
      interval: 5s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7-alpine
    restart: unless-stopped

    volumes:
      - redis-data:/data

    networks:
      - ardt-network

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10

volumes:
  postgres-data:
  redis-data:

networks:
  ardt-network:
    driver: bridge
